{% extends 'dashboard/base.html.twig' %}

{% block title %}Tontine - {{ tontine.name }}{% endblock %}

{% block contentdashboard %}
<!-- Main Content -->
<main class="flex-1 min-w-0 flex flex-col h-full">
    <!-- Desktop Topbar -->
    <header class="hidden md:block bg-white border-b border-gray-100 sticky top-0 z-30 flex-shrink-0">
        <div class="max-w-[1400px] mx-auto px-4 md:px-6 py-3 flex items-center gap-3">
            <!-- Breadcrumb -->
            <div class="flex items-center gap-2 text-sm text-gray-500">
                <a href="{{ path('app_dashboard') }}" class="hover:text-primary">Tableau de bord</a>
                <i class="fa-solid fa-chevron-right text-xs"></i>
                <a href="{{ path('app_tontines_index') }}" class="hover:text-primary">Mes tontines</a>
                <i class="fa-solid fa-chevron-right text-xs"></i>
                <span class="text-primary font-medium">{{ tontine.name }}</span>
            </div>
            
            <!-- Quick Actions -->
            <div class="flex items-center gap-2 ml-auto">
                {% if tontine.statut == 'active' %}
                    <a href="{{ path('app_tontine_payment', {'id': tontine.id}) }}" 
                       class="inline-flex items-center gap-2 px-4 py-2.5 rounded-lg bg-primary text-white hover:bg-green-700 transition-colors font-medium touch-target">
                        <i class="fa-solid fa-credit-card"></i> Effectuer un paiement
                    </a>
                {% endif %}
            </div>
        </div>
    </header>
    
    <!-- Content Area -->
    <div class="flex-1 overflow-y-auto h-0 min-h-0">
        <div class="max-w-[1400px] mx-auto px-3 xs:px-4 md:px-6 py-4 md:py-6 space-y-4 md:space-y-6">
            
            <!-- Header Section -->
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div>
                    <div class="flex items-center gap-3 mb-2">
                        <h1 class="text-2xl md:text-3xl font-bold text-gray-900">{{ tontine.name }}</h1>
                        <span class="px-3 py-1 rounded-full {{ tontine.statut == 'active' ? 'bg-emerald-50 text-emerald-700' : 'bg-gray-100 text-gray-700' }} text-sm font-medium">
                            {{ tontine.statut == 'active' ? 'Active' : 'Terminée' }}
                        </span>
                    </div>
                    <p class="text-gray-600">{{ tontine.tontineCode }}</p>
                </div>
                
                <!-- Stats Summary -->
                <div class="flex flex-wrap gap-3">
                    <div class="bg-white rounded-lg p-3 border border-gray-200 min-w-[120px]">
                        <div class="text-xs text-gray-500">Montant/point</div>
                        <div class="text-lg font-bold text-primary">{{ tontine.amountPerPoint|number_format(0, ',', ' ') }} FCFA</div>
                    </div>
                    <div class="bg-white rounded-lg p-3 border border-gray-200 min-w-[120px]">
                        <div class="text-xs text-gray-500">Points payés</div>
                        <div class="text-lg font-bold text-accent">{{ tontine.paidPoints|default(0) }}/{{ tontine.totalPoints }}</div>
                    </div>
                    <div class="bg-white rounded-lg p-3 border border-gray-200 min-w-[120px]">
                        <div class="text-xs text-gray-500">Fréquence</div>
                        <div class="text-lg font-bold text-info">
                            {% if tontine.frequency == 'daily' %}Quotidienne
                            {% elseif tontine.frequency == 'weekly' %}Hebdomadaire
                            {% elseif tontine.frequency == 'monthly' %}Mensuelle
                            {% else %}{{ tontine.frequency }}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Carte de Tontine Traditionnelle -->
            <div class="bg-white border-2 border-gray-800 rounded-lg overflow-hidden">
                <!-- En-tête de la carte -->
                <div class="bg-gray-800 text-white p-4 md:p-6">
                    <div class="flex flex-col md:flex-row md:items-start justify-between gap-4">
                        <div>
                            <h2 class="text-xl md:text-2xl font-bold">{{ tontine.name }}</h2>
                            <div class="mt-2 space-y-1 text-sm">
                                <div class="flex items-center gap-2">
                                    <i class="fa-solid fa-hashtag text-gray-300"></i>
                                    <span>Référence: <span class="font-mono font-bold">{{ tontine.tontineCode }}</span></span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <i class="fa-solid fa-user text-gray-300"></i>
                                    <span>Créée par: {{ tontine.user.username|default('Vous') }}</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <i class="fa-solid fa-calendar text-gray-300"></i>
                                    <span>Créée le: {{ tontine.createdAt|date('l d F Y') }}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-1 text-sm">
                            <div class="flex items-center gap-2">
                                <i class="fa-solid fa-money-bill-wave text-gray-300"></i>
                                <span>Valeur/point: <span class="font-bold">{{ tontine.amountPerPoint|number_format(0, ',', ' ') }} XOF</span></span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fa-solid fa-flag-checkered text-gray-300"></i>
                                <span>Date limite: {{ date(tontine.startDate).modify('+' ~ tontine.totalPoints ~ ' ' ~ tontine.frequency)|date('d F Y') }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Section des montants -->
                <div class="p-4 md:p-6 border-b border-gray-300">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="text-center p-4 border-2 border-gray-300 rounded-lg">
                            <div class="text-sm text-gray-600 mb-2">Valeur par point</div>
                            <div class="text-2xl md:text-3xl font-bold text-gray-800">
                                {{ tontine.amountPerPoint|number_format(0, ',', ' ') }} XOF
                            </div>
                        </div>
                        
                        <div class="text-center p-4 border-2 border-green-500 rounded-lg bg-green-50">
                            <div class="text-sm text-green-600 mb-2">Total épargné</div>
                            {% set totalSaved = tontine.amountPerPoint * (tontine.paidPoints|default(0)) %}
                            <div class="text-2xl md:text-3xl font-bold text-green-700">
                                {{ totalSaved|number_format(0, ',', ' ') }} XOF
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Carte de pointage simplifiée -->
                <div class="p-4 md:p-6">
                    <div class="text-center mb-4">
                        <h3 class="text-lg font-bold text-gray-800">Carte de pointage</h3>
                        <p class="text-sm text-gray-600">{{ tontine.paidPoints|default(0) }}/{{ tontine.totalPoints }} points</p>
                    </div>
                    
                    <!-- Grille des points -->
                    <div class="grid grid-cols-7 gap-2">
                        {% for point in 1..tontine.totalPoints %}
                            {% set isPaid = point <= (tontine.paidPoints|default(0)) %}
                            {% set isCurrent = point == (tontine.paidPoints|default(0)) + 1 %}
                            {% set isMissed = date(tontine.startDate).modify('+' ~ (point-1) ~ ' ' ~ tontine.frequency) < date('now') and not isPaid %}
                            
                            <div class="relative">
                                <div class="aspect-square border-2 {{ isPaid ? 'border-green-500 bg-green-100 text-green-700' : isMissed ? 'border-red-500 bg-red-100 text-red-700' : isCurrent ? 'border-yellow-500 bg-yellow-100 text-yellow-700' : 'border-gray-300 bg-gray-50 text-gray-700' }} 
                                          rounded-lg flex flex-col items-center justify-center p-1 cursor-pointer hover:shadow-md transition-all"
                                     onclick="showPointInfo({{ point }})">
                                    
                                    <!-- Numéro du point -->
                                    <div class="text-lg font-bold">{{ point }}</div>
                                    
                                    <!-- Icône statut -->
                                    <div class="text-xs mt-1">
                                        {% if isPaid %}
                                            <i class="fa-solid fa-check text-green-600"></i>
                                        {% elseif isMissed %}
                                            <i class="fa-solid fa-exclamation text-red-600"></i>
                                        {% elseif isCurrent %}
                                            <i class="fa-solid fa-clock text-yellow-600"></i>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Indicateur actuel -->
                                {% if isCurrent and tontine.statut == 'active' %}
                                    <div class="absolute -top-1 -right-1 bg-yellow-500 text-white text-xs px-1.5 py-0.5 rounded-full">
                                        <i class="fa-solid fa-bolt text-[8px]"></i>
                                    </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Légende -->
                    <div class="flex flex-wrap justify-center gap-3 mt-4 pt-4 border-t border-gray-200">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-green-500"></div>
                            <span class="text-xs text-gray-600">Payé</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                            <span class="text-xs text-gray-600">À payer</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-red-500"></div>
                            <span class="text-xs text-gray-600">En retard</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-gray-300"></div>
                            <span class="text-xs text-gray-600">À venir</span>
                        </div>
                    </div>
                </div>
                
                <!-- Résumé -->
                <div class="bg-gray-50 p-4 border-t border-gray-200">
                    <div class="grid grid-cols-3 gap-2">
                        <div class="text-center p-2">
                            <div class="text-xs text-gray-500">Points payés</div>
                            <div class="font-bold text-green-700">{{ tontine.paidPoints|default(0) }}</div>
                        </div>
                        <div class="text-center p-2">
                            <div class="text-xs text-gray-500">Points restants</div>
                            <div class="font-bold text-blue-700">{{ tontine.totalPoints - (tontine.paidPoints|default(0)) }}</div>
                        </div>
                        <div class="text-center p-2">
                            <div class="text-xs text-gray-500">Montant restant</div>
                            <div class="font-bold text-red-700">
                                {{ ((tontine.totalPoints - (tontine.paidPoints|default(0))) * tontine.amountPerPoint)|number_format(0, ',', ' ') }} XOF
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Pied de page -->
                <div class="bg-gray-100 p-3 border-t border-gray-300">
                    <div class="text-center text-xs text-gray-600">
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-1">
                            <div>Carte générée le {{ "now"|date('d/m/Y') }}</div>
                            <div>© {{ "now"|date('Y') }} - {{ tontine.tontineCode }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Informations complémentaires -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Progression -->
                <div class="bg-white rounded-xl border border-gray-200 p-6">
                    <h3 class="font-semibold text-gray-900 mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-chart-line text-primary"></i> Progression globale
                    </h3>
                    
                    {% set totalToSave = tontine.amountPerPoint * tontine.totalPoints %}
                    {% set savedAmount = tontine.amountPerPoint * (tontine.paidPoints|default(0)) %}
                    {% set progress = totalToSave > 0 ? (savedAmount / totalToSave * 100)|round : 0 %}
                    
                    <!-- Barre de progression -->
                    <div class="mb-4">
                        <div class="flex justify-between text-sm mb-2">
                            <span class="text-gray-600">Progression</span>
                            <span class="font-semibold">{{ progress }}%</span>
                        </div>
                        <div class="h-3 bg-gray-100 rounded-full overflow-hidden">
                            <div class="h-full bg-primary rounded-full" style="width: {{ progress }}%"></div>
                        </div>
                    </div>
                    
                    <!-- Stats -->
                    <div class="space-y-3">
                        <div class="flex justify-between items-center p-3 bg-emerald-50 rounded-lg">
                            <div>
                                <div class="text-sm text-gray-600">Épargné</div>
                                <div class="font-bold text-emerald-700">{{ savedAmount|number_format(0, ',', ' ') }} FCFA</div>
                            </div>
                            <i class="fa-solid fa-check-circle text-emerald-500 text-xl"></i>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                            <div>
                                <div class="text-sm text-gray-600">Restant</div>
                                <div class="font-bold text-blue-700">{{ (totalToSave - savedAmount)|number_format(0, ',', ' ') }} FCFA</div>
                            </div>
                            <i class="fa-solid fa-clock text-blue-500 text-xl"></i>
                        </div>
                    </div>
                </div>

                <!-- Prochain paiement -->
                <div class="bg-white rounded-xl border border-gray-200 p-6">
                    <h3 class="font-semibold text-gray-900 mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-calendar-check text-primary"></i> Prochain paiement
                    </h3>
                    
                    {% if tontine.statut == 'active' and tontine.nextDueDate %}
                        {% set daysRemaining = date(tontine.nextDueDate).diff(date('now')).days %}
                        
                        <div class="text-center p-4 bg-yellow-50 rounded-lg mb-4">
                            <div class="text-2xl font-bold text-primary mb-2">
                                {{ tontine.amountPerPoint|number_format(0, ',', ' ') }} FCFA
                            </div>
                            <div class="font-medium text-gray-900">{{ tontine.nextDueDate|date('d/m/Y') }}</div>
                            <div class="text-sm text-gray-600 mt-1">
                                {% if daysRemaining < 0 %}
                                    <span class="text-red-600">En retard de {{ -daysRemaining }} jour(s)</span>
                                {% elseif daysRemaining == 0 %}
                                    <span class="text-warning">Aujourd'hui</span>
                                {% elseif daysRemaining <= 3 %}
                                    <span class="text-warning">Dans {{ daysRemaining }} jour(s)</span>
                                {% else %}
                                    Dans {{ daysRemaining }} jours
                                {% endif %}
                            </div>
                        </div>
                        
                        <a href="{{ path('app_tontine_payment', {'id': tontine.id}) }}" 
                           class="w-full inline-flex items-center justify-center gap-2 px-4 py-3 bg-primary text-white rounded-lg hover:bg-green-700 transition-colors font-medium touch-target">
                            <i class="fa-solid fa-credit-card"></i> Payer maintenant
                        </a>
                    {% else %}
                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                            <i class="fa-solid fa-check-circle text-3xl text-gray-400 mb-3"></i>
                            <div class="text-gray-600">Aucun paiement en attente</div>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Informations détaillées -->
            <div class="bg-white rounded-xl border border-gray-200 p-6">
                <h3 class="font-semibold text-gray-900 mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-info-circle text-primary"></i> Informations détaillées
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <div class="text-sm text-gray-500">Date de début</div>
                        <div class="font-medium">{{ tontine.startDate|date('d/m/Y') }}</div>
                    </div>
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <div class="text-sm text-gray-500">Prochaine échéance</div>
                        <div class="font-medium">{{ tontine.nextDueDate|date('d/m/Y') }}</div>
                    </div>
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <div class="text-sm text-gray-500">Total à épargner</div>
                        <div class="font-bold text-primary">
                            {{ (tontine.amountPerPoint * tontine.totalPoints)|number_format(0, ',', ' ') }} FCFA
                        </div>
                    </div>
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <div class="text-sm text-gray-500">Dernière mise à jour</div>
                        <div class="font-medium">{{ tontine.createdAt|date('d/m/Y H:i') }}</div>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="flex flex-col sm:flex-row gap-3">
                <a href="{{ path('app_tontines_index') }}" 
                   class="inline-flex items-center justify-center gap-2 px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium touch-target">
                    <i class="fa-solid fa-arrow-left"></i> Retour à la liste
                </a>
                
                {% if tontine.statut == 'active' %}
                    <a href="{{ path('app_tontine_payment', {'id': tontine.id}) }}" 
                       class="inline-flex items-center justify-center gap-2 px-6 py-3 bg-primary text-white rounded-lg hover:bg-green-700 transition-colors font-medium touch-target">
                        <i class="fa-solid fa-credit-card"></i> Effectuer un paiement
                    </a>
                    
                    <button onclick="printCard()" 
                           class="inline-flex items-center justify-center gap-2 px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium touch-target">
                        <i class="fa-solid fa-print"></i> Imprimer la carte
                    </button>
                {% endif %}
            </div>
        </div>
    </div>
</main>

<!-- Modal info point -->
<div id="pointInfoModal" class="hidden fixed inset-0 bg-black/50 z-50">
    <div class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-xl w-full max-w-xs">
            <div class="p-4">
                <div class="text-center mb-4">
                    <div id="pointStatusIcon" class="text-3xl mb-2"></div>
                    <h3 id="pointTitle" class="font-bold text-lg"></h3>
                </div>
                <div class="space-y-3">
                    <div>
                        <div class="text-sm text-gray-500">Montant</div>
                        <div id="pointAmount" class="font-bold text-primary"></div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-500">Date estimée</div>
                        <div id="pointDate" class="font-medium"></div>
                    </div>
                    <div id="pointActions" class="pt-3 border-t border-gray-100">
                        <!-- Actions dynamiques -->
                    </div>
                </div>
                <button onclick="closePointInfo()" 
                        class="w-full mt-4 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                    Fermer
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function printCard() {
    const printContent = document.querySelector('.bg-white.border-2.border-gray-800');
    const originalContent = document.body.innerHTML;
    
    document.body.innerHTML = printContent.outerHTML;
    window.print();
    document.body.innerHTML = originalContent;
    window.location.reload();
}

function showPointInfo(pointNumber) {
    const modal = document.getElementById('pointInfoModal');
    const pointTitle = document.getElementById('pointTitle');
    const pointAmount = document.getElementById('pointAmount');
    const pointDate = document.getElementById('pointDate');
    const pointStatusIcon = document.getElementById('pointStatusIcon');
    const pointActions = document.getElementById('pointActions');
    
    const amount = {{ tontine.amountPerPoint }};
    const startDate = new Date('{{ tontine.startDate|date("Y-m-d") }}');
    const frequency = '{{ tontine.frequency }}';
    const paidPoints = {{ tontine.paidPoints|default(0) }};
    
    // Calculer la date estimée
    let estimatedDate = new Date(startDate);
    if (frequency === 'daily') {
        estimatedDate.setDate(startDate.getDate() + (pointNumber - 1));
    } else if (frequency === 'weekly') {
        estimatedDate.setDate(startDate.getDate() + ((pointNumber - 1) * 7));
    } else if (frequency === 'monthly') {
        estimatedDate.setMonth(startDate.getMonth() + (pointNumber - 1));
    }
    
    const isPaid = pointNumber <= paidPoints;
    const isCurrent = pointNumber === paidPoints + 1;
    const isLate = estimatedDate < new Date() && !isPaid;
    
    pointTitle.textContent = `Point #${pointNumber}`;
    pointAmount.textContent = `${amount.toLocaleString('fr-FR')} FCFA`;
    pointDate.textContent = estimatedDate.toLocaleDateString('fr-FR', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
    
    if (isPaid) {
        pointStatusIcon.innerHTML = '<i class="fa-solid fa-check-circle text-green-500"></i>';
        pointActions.innerHTML = '<div class="text-center text-green-600 text-sm"><i class="fa-solid fa-check mr-1"></i> Déjà payé</div>';
    } else if (isLate) {
        pointStatusIcon.innerHTML = '<i class="fa-solid fa-exclamation-triangle text-red-500"></i>';
        pointActions.innerHTML = `
            <button onclick="payPoint(${pointNumber})" 
                    class="w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm">
                <i class="fa-solid fa-credit-card mr-2"></i> Payer en retard
            </button>
        `;
    } else if (isCurrent) {
        pointStatusIcon.innerHTML = '<i class="fa-solid fa-clock text-yellow-500"></i>';
        pointActions.innerHTML = `
            <button onclick="payPoint(${pointNumber})" 
                    class="w-full px-4 py-2 bg-primary text-white rounded-lg hover:bg-green-700 text-sm">
                <i class="fa-solid fa-credit-card mr-2"></i> Payer maintenant
            </button>
        `;
    } else {
        pointStatusIcon.innerHTML = '<i class="fa-regular fa-calendar text-gray-400"></i>';
        pointActions.innerHTML = '<div class="text-center text-gray-500 text-sm">À venir</div>';
    }
    
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closePointInfo() {
    document.getElementById('pointInfoModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
}

function payPoint(pointNumber) {
    window.location.href = '{{ path("app_tontine_payment", {"id": tontine.id}) }}?point=' + pointNumber;
}
</script>

<style>
.touch-target {
    min-height: 44px;
    min-width: 44px;
}

/* Styles d'impression */
@media print {
    @page {
        margin: 0.5cm;
        size: A4 landscape;
    }
    
    body * {
        visibility: hidden;
    }
    
    .bg-white.border-2.border-gray-800,
    .bg-white.border-2.border-gray-800 * {
        visibility: visible;
    }
    
    .bg-white.border-2.border-gray-800 {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        border: 2px solid #000 !important;
        box-shadow: none !important;
    }
}
</style>
{% endblock %}