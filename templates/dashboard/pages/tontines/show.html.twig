{% extends 'dashboard/base.html.twig' %}

{% block title %}Tontine -
{{ tontine.name }}
{% endblock %}

{% block contentdashboard %}
{% set totalAPayer = tontine.totalPoints * tontine.amountPerPoint %}
{% set is_completed = tontine.totalpay == totalAPayer %}
{% set montantARetirer = tontine.amountPerPoint %}
{% set isMonthly = tontine.frequency == 'monthly' %}
{% set interval = tontine.frequency == 'monthly' ? 'months' : (tontine.frequency == 'weekly' ? 'weeks' : (tontine.frequency == 'daily' ? 'days' : 'months')) %}

{# Configuration KkiaPay #}

{% set kkiapay_callback_url = url('app_tontine_payment_verify') %}

<!-- Main Container -->
<div class="flex-1 min-w-0 flex flex-col h-full bg-gradient-to-b from-green-50/20 to-white">
	<!-- Desktop Topbar -->
	<header
		class="hidden md:block bg-gradient-to-r from-green-700 via-green-600 to-green-700 text-white sticky top-0 z-30 flex-shrink-0 shadow-lg">
		<div class="max-w-[1400px] mx-auto px-6 py-3">
			<div class="flex items-center justify-between">

				<div class="flex items-center gap-3">
					
				</div>

				<!-- Quick Actions -->
				<div class="flex items-center gap-3">
					{% if uiState == 'ACTIVE' %}
					<!-- Tontine active -->
					<a href="{{ path('app_tontine_payment', {'id': tontine.id}) }}"
						class="inline-flex items-center gap-2 px-5 py-2.5 rounded-lg bg-yellow-500 text-white hover:bg-yellow-600 transition-all duration-300 font-semibold shadow-lg hover:shadow-xl transform hover:scale-[1.02]">
						<i class="fa-solid fa-credit-card"></i>
						<span>Effectuer un paiement</span>
					</a>
					<div class="flex flex-col md:flex-row gap-3">
						<!-- Bouton de demande de retrait -->
						<a href="{{ path('app_withdrawal_request', {'id': tontine.id}) }}"
							class="inline-flex items-center justify-center gap-3 px-6 py-3.5 bg-gradient-to-r from-yellow-500 to-yellow-500 text-white rounded-xl hover:from-yellow-500 hover:to-yellow-600 transition-all duration-300 transform hover:scale-[1.02] font-medium touch-target shadow-lg hover:shadow-xl">
							<i class="fas fa-download mr-2"></i>
							Demander un retrait
						</a>
					</div>

					{% elseif uiState == 'COMPLETED_NO_WITHDRAWAL' %}
					<div class="flex flex-col md:flex-row gap-3">
						<!-- Bouton de demande de retrait -->
						<a href="{{ path('app_withdrawal_request', {'id': tontine.id}) }}"
							class="inline-flex items-center justify-center gap-3 px-6 py-3.5 bg-gradient-to-r from-yellow-500 to-yellow-500 text-white rounded-xl hover:from-yellow-500 hover:to-yellow-600 transition-all duration-300 transform hover:scale-[1.02] font-medium touch-target shadow-lg hover:shadow-xl">
							<i class="fas fa-download mr-2"></i>
							Demander un retrait
						</a>
					</div>

					{% elseif uiState == 'PARTIAL_WITHDRAWAL' %}
					<div class="flex flex-col md:flex-row gap-3">
						<!-- Bouton de demande de retrait -->
						<a href="{{ path('app_withdrawal_request', {'id': tontine.id}) }}"
							class="inline-flex items-center justify-center gap-3 px-6 py-3.5 bg-gradient-to-r from-yellow-600 to-yellow-500 text-white rounded-xl hover:from-yellow-600 hover:to-yellow-600 transition-all duration-300 transform hover:scale-[1.02] font-medium touch-target shadow-lg hover:shadow-xl">
							<i class="fas fa-download mr-2"></i>
							Demander un retrait
						</a>
					</div>
					{% elseif uiState == 'COMPLETED_FULL_WITHDRAWAL' %}
					<!-- Tontine terminée mais pas encore clôturée -->
					<div
						class="inline-flex items-center justify-center gap-3 px-6 py-3.5 bg-gradient-to-r from-yellow-500 to-yellow-600 text-white rounded-xl font-medium shadow-lg">
						<i class="fas fa-lock"></i>
						<span>Tontine clôturée</span>
					</div>

					{% endif %}
				</div>
			</div>
		</div>
	</header>

	<!-- Mobile Header -->
	<header class="md:hidden bg-green-700 text-white sticky top-0 z-30 shadow-lg px-4 py-3">
		<div class="flex items-center justify-between gap-3 mb-3">
			<div class="flex items-center gap-3 min-w-0">
				<a href="{{ path('app_dashboard') }}" class="flex items-center justify-center w-8 h-8 rounded-full bg-white/10 hover:bg-white/20 transition-colors">
					<i class="fas fa-arrow-left text-sm"></i>
				</a>
				<div class="min-w-0">
					<h1 class="text-base font-bold truncate">{{ tontine.name }}</h1>
					<p class="text-green-100 text-[10px] truncate">{{ tontine.tontineCode }}</p>
				</div>
			</div>
			<div class="flex items-center gap-2 flex-shrink-0">
				{% if uiState == 'COMPLETED_NO_WITHDRAWAL' %}
				<span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-medium bg-yellow-500 text-white whitespace-nowrap">
					<i class="fas fa-check-circle mr-1"></i>
					Terminée
				</span>
				{% elseif uiState == 'COMPLETED_FULL_WITHDRAWAL' %}
				<span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-medium bg-red-500 text-white whitespace-nowrap">
					<i class="fas fa-lock mr-1"></i>
					Clôturée
				</span>
				{% endif %}
			</div>
		</div>
		
		{% if uiState == 'ACTIVE' %}
		<div class="flex gap-2">
			<a href="{{ path('app_tontine_payment', {'id': tontine.id}) }}" 
					class="flex-1 inline-flex items-center justify-center gap-2 px-3 py-2 bg-white/20 backdrop-blur-sm text-white rounded-lg font-bold text-sm shadow-sm active:scale-95 transition-all border border-white/30">
				<i class="fas fa-credit-card"></i>
				<span>Payer un point</span>
			</a>
		</div>
		{% elseif uiState == 'COMPLETED_NO_WITHDRAWAL' or uiState == 'PARTIAL_WITHDRAWAL' %}
		<a href="{{ path('app_withdrawal_request', {'id': tontine.id}) }}"
			 class="block text-center px-3 py-2 bg-yellow-500 text-white rounded-lg font-bold text-sm shadow-sm active:scale-95 transition-all">
			<i class="fas fa-download mr-1"></i>
			Demander le retrait
		</a>
		{% endif %}
	</header>

	<!-- Content Area -->
	<div class="flex-1 overflow-y-auto h-0 min-h-0">
		<div class="max-w-[1400px] mx-auto px-3 md:px-4 py-3 md:py-4 space-y-4 md:space-y-6">

			<div class="grid grid-cols-1 lg:grid-cols-2 gap-3 md:gap-4 lg:gap-8 p-3 md:p-4 lg:p-6">
				<!-- Carte de Tontine -->
				<div
					class="relative bg-gradient-to-br from-white to-green-50 border-2 border-green-800 rounded-2xl overflow-hidden shadow-2xl ">
					<!-- Badge d'état -->
					{% if uiState == 'COMPLETED_NO_WITHDRAWAL' %}
					<div class="absolute top-4 right-4 z-10">
						<span
							class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-600 text-white">
							<i class="fas fa-times-circle mr-1"></i>
							terminée
						</span>
					</div>
					{% elseif uiState == 'COMPLETED_FULL_WITHDRAWAL' %}
					<div class="absolute top-4 right-4 z-10">
						<span
							class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800">
							<i class="fas fa-times-circle mr-1"></i>
							cloturée
						</span>
					</div>
					{% endif %}

					<!-- En-tête de la carte (masqué sur mobile car redondant avec le top header) -->
					<div class="hidden md:block bg-gradient-to-r from-green-800 via-green-700 to-green-800 text-white p-3 md:p-6 lg:p-8">
						<div class="flex flex-col md:flex-row md:items-start justify-between gap-6">
							<!-- Info gauche -->
							<div class="flex-1">
								<div class="flex items-center gap-3 mb-4">
									<div
										class="h-12 w-12 rounded-xl bg-white/20 backdrop-blur-sm flex items-center justify-center">
										<i
											class="fa-solid {% if tontine.statut == 'completed' %}fa-lock{% else %}fa-piggy-bank{% endif %} text-xl"></i>
									</div>
									<div>
									<h2 class="text-lg md:text-xl lg:text-2xl font-bold">{{ tontine.name }}</h2>
										<p
											class="{% if tontine.statut == 'completed' %}text-red-100{% else %}text-green-100{% endif %} text-sm">
											EFA Smart Finance •
											{{ tontine.tontineCode }}
											{% if tontine.statut == 'completed' %}
											<br>Clôturée le
											{{ tontine.endedAt ? tontine.endedAt|date('d/m/Y') : '' }}
											{% endif %}
										</p>
									</div>
								</div>

								<div class="grid grid-cols-1 md:grid-cols-1 gap-4">
									<div class="space-y-2">
										<div class="flex justify-center gap-2">
											<span>
												{% if tontine.frequency == 'monthly' %}
												Tontine de {{ tontine.totalPoints }} mois
												{% elseif tontine.frequency == 'weekly' %}
												Tontine de {{ tontine.totalPoints }} semaines
												{% elseif tontine.frequency == 'daily' %}
												Tontine de {{ tontine.totalPoints }} jours
												{% endif %}


												{% set interval = tontine.frequency == 'monthly' ? 'months' :
												(tontine.frequency == 'weekly' ? 'weeks' :
												(tontine.frequency == 'daily' ? 'days' : 'months')) %}
												{% set endDate = tontine.startDate|date_modify('+' ~
												(tontine.totalPoints - 1) ~ ' ' ~ interval) %}
											</span>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>

					<!-- Carte de pointage interactive-->
				<div class="p-3 md:p-6 lg:p-8">
						<div class="text-center mb-4 md:mb-8">
							<h3 class="text-base md:text-lg lg:text-xl font-bold text-gray-900 mb-2 p-2">Calendrier de la Tontine</h3>
							<div class="flex items-center justify-center gap-4">
								<div class="text-sm text-gray-600">
									<span class="font-semibold text-green-700">{{ tontine.paidPoints|default(0)
										}}</span>
									sur
									<span class="font-semibold text-gray-900">{{ tontine.totalPoints }}</span>
									points
								</div>
								<div class="h-2 w-24 bg-gray-200 rounded-full overflow-hidden">
									<div class="h-full bg-gradient-to-r from-green-500 to-green-600"
										style="width: {{ ((tontine.paidPoints|default(0) / tontine.totalPoints) * 100)|round }}%">
									</div>
								</div>
							</div>
						</div>

						<!-- Navigation par Onglets (Mois) -->
						{% set isMonthly = tontine.frequency == 'monthly' %}
						{% set pointsPerMonth = (isMonthly ? tontine.totalPoints : (tontine.frequency == 'daily' ? 31 : 4)) %}
						{% set currentPoint = (tontine.paidPoints|default(0)) + 1 %}
						{% set totalMonths = (tontine.totalPoints / pointsPerMonth)|round(0, 'ceil') %}
						{% set currentMonthIndex = max(1, (tontine.paidPoints / pointsPerMonth)|round(0, 'ceil')) %}
						{% set multiplier = (tontine.statut == 'terminated') ? min(currentMonthIndex, totalMonths) : totalMonths %}

						<div class="px-4 mb-6">
							<div class="flex items-center gap-2 overflow-x-auto pb-4 scrollbar-hide -mx-4 px-4 sm:mx-0 sm:px-0">
								{% for mIdx in 1..totalMonths %}
									{% set isActive = mIdx == currentMonthIndex %}
									{% set monthStart = (mIdx - 1) * pointsPerMonth + 1 %}
									{% set monthEnd = min(mIdx * pointsPerMonth, tontine.totalPoints) %}
									
									{# Calculer la progression du mois #}
									{% set monthPaidCount = 0 %}
									{% for p in monthStart..monthEnd %}
										{% if p <= (tontine.paidPoints|default(0)) %}
											{% set monthPaidCount = monthPaidCount + 1 %}
										{% endif %}
									{% endfor %}
									{% set monthTotalCount = monthEnd - monthStart + 1 %}
									{% set isMonthFull = monthPaidCount == monthTotalCount %}

									{% if tontine.frequency != 'monthly' %}
									<button type="button" 
										onclick="switchMonth({{ mIdx }})"
										id="tab-month-{{ mIdx }}"
										class="month-tab flex-shrink-0 flex flex-col items-center gap-1 px-4 py-2 rounded-2xl transition-all duration-300 {{ isActive ? 'bg-green-600 text-white shadow-lg' : 'bg-green-50 border border-green-100 text-green-800 hover:bg-green-100' }}">
										<span class="text-lg font-black leading-none">
											{{ isMonthly ? 'Mensuelle' : mIdx ~ (mIdx == 1 ? 'er' : 'em') }}
										</span>
										<span class="text-[10px] font-bold uppercase tracking-wider opacity-80">
											{{ isMonthly ? 'Tontine' : 'Mois' }}
										</span>
										
										<div class="text-[9px] mt-1 px-2 py-0.5 rounded-full {{ isActive ? 'bg-green-500 text-white' : 'bg-green-100 text-green-700' }}">
											{{ monthPaidCount }}/{{ monthTotalCount }}
										</div>
									</button>
									{% endif %}

								{% endfor %}
							</div>
						</div>

						<!-- Zone de Contenu (Grilles) -->
						<div class="px-4">
							{% for mIdx in 1..totalMonths %}
								{% set isActive = mIdx == currentMonthIndex %}
								<div id="month-content-{{ mIdx }}" class="month-content transition-all duration-500 {{ isActive ? 'block' : 'hidden opacity-0' }}">
									<div class="bg-white border border-green-100 rounded-3xl p-4 sm:p-6 shadow-sm">
										<div class="flex items-center justify-between mb-6">
											<h4 class="font-black text-green-800 flex items-center gap-2">
												<i class="fa-solid fa-calendar-check text-green-600"></i>
												{{ isMonthly ? '' : 'Détails du ' ~ mIdx ~ (mIdx == 1 ? 'er' : 'em') ~ '  Mois' }}
											</h4>
											<span class="text-xxs font-bold text-green-600 bg-green-50 px-3 py-1 rounded-full border border-green-100">
												{% set monthStart = (mIdx - 1) * pointsPerMonth + 1 %}
												{% set monthEnd = min(mIdx * pointsPerMonth, tontine.totalPoints) %}
												Points {{ monthStart }} - {{ monthEnd }}
											</span>
										</div>

										<div class="grid grid-cols-6 sm:grid-cols-6 md:grid-cols-8 lg:grid-cols-10 xl:grid-cols-12 gap-2 sm:gap-3 md:gap-4">
											{% for point in max(1, (mIdx - 1) * pointsPerMonth + 1)..min(tontine.totalPoints, mIdx * pointsPerMonth) %}
												{% set isPaid = point <= (tontine.paidPoints|default(0)) %}
												{% set isCurrent = point == currentPoint %}
												{% set pointDueDate = null %}
												{% if tontine.startDate %}
													{% set pointDueDate = tontine.startDate|date_modify('+' ~ (point-1) ~ ' ' ~ (tontine.frequency == 'weekly' ? 'weeks' : tontine.frequency == 'daily' ? 'days' : 'months' )) %}
												{% endif %}
												{% set isMissed = pointDueDate and pointDueDate < date('now') and not isPaid %}
												{% set pointLocalIndex = point - (mIdx - 1) * pointsPerMonth %}
												
												{# Libellé du point #}
												{% if isMonthly %}
													{% set pointLabel = point %}
												{% else %}
													{% set pointLabel = pointLocalIndex %}
												{% endif %}

												<div class="relative group/point">
													<div class="aspect-square border {{ isPaid ? 'border-green-500 bg-green-50 text-green-700' : isMissed ? 'border-red-400 bg-red-50 text-red-700' : isCurrent ? 'border-yellow-500 bg-yellow-50 text-yellow-800' : 'border-slate-200 bg-green-50 text-slate-400' }}
														rounded-2xl flex flex-col items-center justify-center p-2 cursor-pointer hover:shadow-xl hover:scale-105 transition-all duration-300 transform"
														onclick="showPointInfo({{ point }})"
														title="Point #{{ point }}{% if pointDueDate %} - Échéance: {{ pointDueDate|date('d/m/Y') }}{% endif %}">

														
														<div class="{% if isMonthly %}text-xs{% else %}text-sm md:text-base{% endif %} font-black mb-1">{{ pointLabel }}</div>

														<div class="text-xs md:text-sm">
															{% if isPaid %}
																<i class="fa-solid fa-check-double text-green-600 scale-110"></i>
															{% elseif isMissed %}
																<i class="fa-solid fa-triangle-exclamation text-red-500 animate-pulse"></i>
															{% elseif isCurrent %}
																<i class="fa-solid fa-bolt-lightning text-yellow-600 animate-bounce"></i>
															{% else %}
																<i class="fa-regular fa-circle text-slate-200 opacity-50"></i>
															{% endif %}
														</div>
													</div>

													{% if isCurrent and tontine.statut == 'active' %}
														<div class="absolute -top-1 -right-1 bg-yellow-400 text-white text-[8px] h-5 w-5 rounded-full shadow-md flex items-center justify-center z-10 border-2 border-white ring-2 ring-yellow-100">
															<i class="fa-solid fa-star text-[10px]"></i>
														</div>
													{% endif %}
												</div>
											{% endfor %}
										</div>
									</div>
								</div>
							{% endfor %}
						</div>

						<script>
							function switchMonth(mIdx) {
								// Masquer tous les contenus
								document.querySelectorAll('.month-content').forEach(el => {
									el.classList.add('hidden');
									el.classList.remove('opacity-100');
									el.classList.add('opacity-0');
								});
								
								// Désactiver tous les onglets
								document.querySelectorAll('.month-tab').forEach(el => {
									el.classList.remove('bg-green-600', 'text-white', 'shadow-lg');
									el.classList.add('bg-green-50', 'border', 'border-green-100', 'text-green-800');
									
									const badge = el.querySelector('div');
									if (badge) {
										badge.classList.remove('bg-green-500', 'text-white');
										badge.classList.add('bg-green-100', 'text-green-700');
									}
								});

								// Activer le contenu sélectionné
								const activeContent = document.getElementById('month-content-' + mIdx);
								activeContent.classList.remove('hidden');
								setTimeout(() => activeContent.classList.add('opacity-100'), 10);

								// Activer l'onglet sélectionné
								const activeTab = document.getElementById('tab-month-' + mIdx);
								activeTab.classList.add('bg-green-600', 'text-white', 'shadow-lg');
								activeTab.classList.remove('bg-green-50', 'border', 'border-green-100', 'text-green-800');
								
								const activeBadge = activeTab.querySelector('div');
								if (activeBadge) {
									activeBadge.classList.remove('bg-green-100', 'text-green-700');
									activeBadge.classList.add('bg-green-500', 'text-white');
								}

								// Scroll tab into view if needed
								activeTab.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
							}

// Fonctions pour le modal de carte
function openCardModal() {
	const modal = document.getElementById('cardModal');
	modal.classList.remove('hidden');
	document.body.style.overflow = 'hidden';
}

function closeCardModal() {
	const modal = document.getElementById('cardModal');
	modal.classList.add('hidden');
	document.body.style.overflow = '';
}

// Fermer le modal en cliquant sur le fond
document.getElementById('cardModal')?.addEventListener('click', function(e) {
	if (e.target === this) {
		closeCardModal();
	}
});

						</script>

					<!-- Légende améliorée -->
					<div class="flex flex-wrap justify-center gap-4 mt-4 pt-4 p-4 border-t border-gray-200">
						<div class="flex items-center gap-2">
							<div class="w-4 h-4 rounded-full bg-gradient-to-r from-green-500 to-green-600"></div>
							<span class="text-sm text-gray-700">Payé</span>
						</div>
						<div class="flex items-center gap-2">
							<div class="w-4 h-4 rounded-full bg-gradient-to-r from-yellow-500 to-yellow-600"></div>
							<span class="text-sm text-gray-700">À payer</span>
						</div>
						<div class="flex items-center gap-2">
							<div class="w-4 h-4 rounded-full bg-gradient-to-r from-red-500 to-red-600"></div>
							<span class="text-sm text-gray-700">En retard</span>
						</div>
						<div class="flex items-center gap-2">
							<div class="w-4 h-4 rounded-full bg-gradient-to-b from-gray-300 to-gray-400"></div>
							<span class="text-sm text-gray-700">À venir</span>
						</div>
					</div>
					<div class="flex flex-wrap justify-center mb-8">
						<!-- bouton de paiement -->
						{% if uiState == 'ACTIVE' %}
						<!-- Tontine active -->

						<div class="flex items-center gap-4">
							<a href="{{ path('app_tontine_payment', {'id': tontine.id}) }}" class="inline-flex items-center gap-2 px-5 py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-all duration-300 font-semibold shadow-sm transform hover:scale-[1.02]">
								<i class="fa-solid fa-plus-circle"></i>
								<span>Verser</span>
							</a>

                            <a href="{{ path('app_tontine_terminate_request', {'id': tontine.id}) }}"
                                onclick="return confirm('Confirmez-vous la clôture définitive de cette tontine ? Cette action est irréversible.')"
                                class="inline-flex items-center gap-2 px-5 py-2.5 rounded-lg border-2 border-red-200 text-red-600 hover:bg-red-50 hover:border-red-300 transition-all duration-300 font-semibold shadow-sm transform hover:scale-[1.02]">
                                <i class="fa-solid fa-power-off"></i>
                                <span>Clôturer</span>
                            </a>
						</div>

						{% elseif uiState == 'COMPLETED_NO_WITHDRAWAL' or uiState == 'PARTIAL_WITHDRAWAL' %}

						<div class="flex items-center gap-4">
							{% if tontine.canWithdraw %}
								<a href="{{ path('app_withdrawal_request', {'id': tontine.id}) }}" class="inline-flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-xl hover:from-green-700 hover:to-green-800 transition-all duration-300 font-bold shadow-lg shadow-green-200 transform hover:scale-[1.02] active:scale-95">
									<i class="fa-solid fa-hand-holding-dollar text-lg"></i>
									<span>Demander un retrait</span>
								</a>
							{% else %}
								<span class="inline-flex items-center gap-2 px-6 py-3 bg-gray-100 text-gray-500 rounded-xl font-semibold cursor-not-allowed">
									<i class="fa-solid fa-circle-info"></i>
									<span>Solde insuffisant</span>
								</span>
							{% endif %}
						</div>
						{% elseif uiState == 'COMPLETED_FULL_WITHDRAWAL' %}
						<!-- Tontine terminée mais pas encore clôturée -->
						<div
							class="inline-flex items-center justify-center gap-3 px-6 py-3.5 bg-gradient-to-r from-yellow-500 to-yellow-600 text-white rounded-xl font-medium shadow-lg">
							<i class="fas fa-lock"></i>
							<span>Tontine clôturée</span>
						</div>

						{% endif %}
					</div>

				</div>
			</div>

			<!-- Carte Associée - Design Premium -->
			<div class="public-card">

				<div class="bg-green-50 border border-green-200 rounded-xl p-5 mb-8 ">
					<h3 class="font-semibold text-green-800 mb-4 flex items-center">
						<svg class="w-5 h-5 mr-2" fill="currentColor" viewbox="0 0 20 20">
							<path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" />
							<path fill-rule="evenodd"
								d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z"
								clip-rule="evenodd" />
						</svg>
						Résumé de votre tontine
					</h3>

					<div class="grid grid-cols-1 xs:grid-cols-2 gap-4 mb-4">
						<div class="text-center p-3 bg-white rounded-lg border">
							<div id="previewPoints" class="text-2xl font-bold text-green-600">{{ tontine.totalPoints }}
							</div>
							<div class="text-sm text-gray-6000">Versements</div>
						</div>
						<div class="text-center p-3 bg-white rounded-lg border">
							<div id="previewTotal" class="text-2xl font-bold text-green-600">{{ tontine.totalPoints *
								tontine.amountPerPoint }}</div>
							<div class="text-sm text-gray-6000">Total à épargner</div>
						</div>
					</div>

					<div class="space-y-3 bg-green-50/50 p-4 rounded-xl border border-green-100">
						<div class="flex items-center gap-2 mb-2">
							<i class="fa-solid fa-circle-info text-green-600"></i>
							<span class="text-sm font-semibold text-green-800">Prélèvement automatique</span>
						</div>
						<div class="flex justify-between text-sm">
							<span class="text-gray-600">Frais de service :</span>
							<span class="font-bold text-green-700">
                                {{ tontine.getDeductedServiceFee()|number_format(0, ',', ' ') }} FCFA
                            </span>
						</div>
                        <p class="text-[11px] text-gray-500 leading-tight">
                            Les frais de service sont calculés selon la fréquence et la durée de votre tontine. Ils sont prélevés automatiquement sur votre solde lors du retrait.
                        </p>
					</div>

						<div class="pt-3 mt-3 border-t border-green-200">
							<div class="flex justify-between font-bold">
								<span>Solde disponible:</span>
								<span id="previewNet" class="text-lg text-green-700">
                                    {{ tontine.availableWithdrawalAmount|number_format(0, ',', ' ') }}
									FCFA</span>
							</div>
							<div>
								<p class="text-xs text-right text-green-600 mt-1">
                                    {% if tontine.frequency == 'daily' %}
                                        Après déduction des frais de service
                                    {% else %}
                                        Solde de vos cotisations
                                    {% endif %}
								</p>
							</div>
						</div>
					</div>

				<!-- Bouton pour afficher la carte (Mobile uniquement) -->
				<div class="md:hidden mb-6">
					<button onclick="openCardModal()" 
							class="w-full inline-flex items-center justify-center gap-3 px-6 py-4 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-xl font-semibold shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-[1.02] touch-target">
						<i class="fa-solid fa-id-card text-xl"></i>
						<span>Voir ma carte de tontine</span>
					</button>
				</div>

				<!-- Carte au format carte de service -->
				<div id="serviceCardContent" class="hidden md:block relative overflow-hidden rounded-xl shadow-lg bg-gradient-to-br from-green-800 via-green-700 to-green-800" style="aspect-ratio: 85.6 / 54;">
					<!-- Badge Clôturée -->
					{% if uiState == 'COMPLETED_FULL_WITHDRAWAL' %}
					<div class="absolute top-4 right-4 z-10">
						<span
							class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800">
							<i class="fas fa-times-circle mr-1"></i>
							Expirée
						</span>
					</div>
					{% endif %}
					<!-- Fond dégradé (géré par le parent) -->

					<!-- Contenu de la carte -->
					<div class="relative p-4 sm:p-6">
						<!-- En-tête de la carte -->
						<div class="flex justify-between items-start mb-3">
							<div class="flex items-center gap-3">
								<div class="flex flex-col top-1">
									<img src="{{ asset('images/carte_logo.png') }}" alt="Logo" style=" height: 50px;">
								</div>
							</div>

							<!-- Puce de carte -->
							<div class="absolute  flex items-center justify-start right-6 ">
								<div class=" bg-gradient-to-r from-yellow-400 to-yellow-300 rounded-md">
									<img class=" rounded-md" src="{{ path('qr_code',{'id': tontine.id}) }}"
										alt="QR Code">
								</div>
							</div>
						</div>

						<div class="mt-2 space-y-3">
							<!-- Nom de la tontine -->
							<div class=' grid grid-cols-2'>
								<div>
									<p class="text-green-300 text-xs font-medium ">TITULAIRE</p>
									<h2 class="text-sm font-bold text-white ">
										{{ tontine.utilisateur.firstname|slice(0, 15)|upper }}
										{{ tontine.utilisateur.lastname|upper|slice(0, 15) }}
									</h2>
								</div>


							</div>

							<div class='mt-2 grid grid-cols-2'>
								<!-- Informations membre -->
								<div>
									<p class="text-green-300 text-xs font-medium ">TONTINE ASSOCIÉE</p>
									<h2 class="text-sm font-bold text-white">
										{{ tontine.tontineCode|upper|slice(0, 20) }}
									</h2>

								</div>


								<!-- code Qr -->
								<div class="text-right">
									<h2 class="text-green-300 text-xs font-medium ">OBJECTIF</h2>
									<p class="text-sm font-sm text-white">{{ tontine.name}}</p>
								</div>
							</div>

						</div>
						<!-- Pied de carte avec dates -->
						<div
							class="pt-4 mt-2 border-t {% if tontine.statut == 'completed' %}border-red-300/50{% else %}border-white/20{% endif %}">
							<div class="flex justify-between items-center">
								<div>
									<p class="text-green-300 text-xs">ÉMISSION</p>
									<p class="text-white font-medium text-sm">{{ tontine.createdAt|date('d/m/Y') }}</p>
								</div>


								<div class="text-right">
									<p class="text-green-300 text-xs">VALIDITÉ</p>
									<p class="text-white font-medium text-sm">

										<!-- la date du dernier point -->
										{% set lastPointDate = tontine.startDate|date_modify('+' ~ (tontine.totalPoints
										- 1) ~ ' ' ~ interval) %}
										{{ lastPointDate|date('d/m/Y') }}
									</p>
								</div>
							</div>


						</div>
					</div>
				</div>

				<!-- Bouton de téléchargement -->
				{% if uiState == 'ACTIVE' and uiState != 'COMPLETED_WITH_WITHDRAWAL' %}

				<div class="hidden md:block mt-6 text-center">
					<button onclick="downloadCard()"
						class="inline-flex items-center gap-2 bg-gradient-to-r from-green-600 to-green-600 hover:from-green-700 hover:to-green-800 text-white font-medium py-3 px-6 rounded-lg shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-0.5">
						<i class="fa-solid fa-download"></i>
						Télécharger la carte
					</button>
					<!-- 	<p class="text-gray-600 text-sm mt-2">Format PNG • 85.6 × 54 mm</p> -->
				</div>
				{% endif %}


			</div>


		</div>


		<div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6 p-4 sm:p-6">
			<!-- Progression globale -->
			<div class="bg-white rounded-2xl border border-green-200 p-6 shadow-sm hidden sm:block">
				<h3 class="font-semibold text-gray-900 mb-6 flex items-center gap-3">
					<div
						class="h-10 w-10 rounded-lg bg-gradient-to-r from-green-100 to-green-50 text-green-600 flex items-center justify-center">
						<i class="fa-solid fa-chart-line text-lg"></i>
					</div>
					<span>Progression globale</span>
				</h3>

				{% set totalToSave = tontine.amountPerPoint * tontine.totalPoints %}
				{% set savedAmount = tontine.amountPerPoint * (tontine.paidPoints|default(0)) %}
				{% set progress = totalToSave > 0 ? (savedAmount / totalToSave * 100)|round : 0 %}

				<!-- Barre de progression animée -->
				<div class="mb-6">
					<div class="flex justify-between text-sm mb-3">
						<span class="text-gray-600">Objectif d'épargne</span>
						<span class="font-semibold text-green-700">{{ progress }}%</span>
					</div>
					<div class="h-4 bg-gray-100 rounded-full overflow-hidden">
						<div class="h-full bg-gradient-to-r from-green-500 via-green-600 to-green-700 rounded-full transition-all duration-1000 ease-out"
							style="width: {{ progress }}%"></div>
					</div>
					<div class="flex justify-between text-xs text-gray-6000 mt-2">
						<span>0 FCFA</span>
						<span>{{ totalToSave|number_format(0, ',', ' ') }}
							FCFA</span>
					</div>
				</div>

				<!-- Stats financières -->
				<div class="space-y-4">
					<div
						class="flex justify-between items-center p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl border border-green-200">
						<div>
							<div class="text-sm text-gray-600">Épargne réalisée</div>
							<div class="text-xl font-bold text-green-800">{{ savedAmount|number_format(0, ',', ' ') }}
								FCFA</div>
						</div>
						<div
							class="h-12 w-12 rounded-full bg-green-100 text-green-600 flex items-center justify-center">
							<i class="fa-solid fa-check-circle text-lg"></i>
						</div>
					</div>
					<div
						class="flex justify-between items-center p-4 bg-gradient-to-r from-green-50 to-sky-50 rounded-xl border border-green-200">
						<div>
							<div class="text-sm text-gray-600">Épargne restante</div>
							<div class="text-xl font-bold text-green-800">{{ (totalToSave -
								savedAmount)|number_format(0, ',', ' ') }}
								FCFA</div>
						</div>
						<div
							class="h-12 w-12 rounded-full bg-green-100 text-green-600 flex items-center justify-center">
							<i class="fa-solid fa-hourglass-half text-lg"></i>
						</div>
					</div>
				</div>
			</div>

			<!-- Prochain paiement -->
			<div class="rounded-2xl border border-green-200 bg-gradient-to-br from-white to-green-50 p-6 shadow-sm">

				{% if uiState == 'ACTIVE' %}
				<!-- ========================= ACTIVE ========================= -->
				<div class="glass-card h-full rounded-2xl p-6 shadow-soft">
					<div class="mb-6 flex items-center gap-3">
						<div
							class="flex h-12 w-12 items-center justify-center rounded-xl bg-gradient-to-br from-green-600 to-green-700">
							<i class="fas fa-calendar-check text-lg text-white"></i>
						</div>
						<div>
							<h3 class="text-xl font-semibold text-gray-900">Prochain paiement</h3>
							<p class="text-sm text-gray-6000">Paiement régulier de la tontine</p>
						</div>
					</div>

					{% set daysRemaining = date(tontine.nextDueDate).diff(date('now')).days %}

					<div class="mb-8">
						<div class="mb-6 text-center">
							<div class="mb-2 text-sm font-medium text-gray-6000">Montant à payer</div>
							<div class="mb-4 text-4xl font-bold text-gray-900">
								{{ tontine.amountPerPoint|number_format(0, ',', ' ') }}
								F CFA
							</div>
						</div>

						<div class="rounded-xl bg-gray-50 p-4">
							<div class="mb-3 flex items-center justify-center gap-2">
								<i class="fas fa-calendar-day text-green-600"></i>
								<span class="text-lg font-medium text-gray-700">
									{{ tontine.nextDueDate|date('d M Y') }}
								</span>
							</div>

							<div class="flex justify-center">
								{% if daysRemaining < 0 %} <span
									class="inline-flex items-center gap-2 rounded-full bg-red-100 px-4 py-2 text-sm font-medium text-red-800">
									<i class="fas fa-exclamation-circle"></i>
									En retard de
									{{ -daysRemaining }}
									jour{{ daysRemaining < -1 ? 's' : '' }} </span>
										{% elseif daysRemaining == 0 %}
										<span
											class="inline-flex items-center gap-2 rounded-full bg-yellow-100 px-4 py-2 text-sm font-medium text-yellow-800">
											<i class="fas fa-clock"></i>
											Échéance aujourd'hui
										</span>
										{% else %}
										<span
											class="inline-flex items-center gap-2 rounded-full bg-green-100 px-4 py-2 text-sm font-medium text-green-800">
											<i class="fas fa-clock"></i>
											Dans
											{{ daysRemaining }}
											jour{{ daysRemaining > 1 ? 's' : '' }}
										</span>
										{% endif %}
							</div>
						</div>
					</div>

					<a href="{{ path('app_tontine_payment', {'id': tontine.id}) }}"
						class=" block w-full rounded-xl bg-gradient-to-r from-green-600 to-green-700 py-4 text-center text-lg font-semibold text-white shadow-md transition-all duration-300 hover:from-green-700 hover:to-green-800 hover:shadow-lg hover:scale-[1.02]">
						<i class="fas fa-credit-card mr-2"></i>
						Payer maintenant
					</a>
					<p class="text-center text-sm text-gray-6000">
						Paiement sécurisé via notre plateforme
					</p>
				</div>

				{% elseif uiState == 'COMPLETED_NO_WITHDRAWAL' %}
				<!-- ========================= COMPLETED NO WITHDRAWAL ========================= -->
				<div
					class="glass-card h-full rounded-2xl border-2 border-green-500 bg-gradient-to-br from-green-50/50 to-white p-6 shadow-hard">
					<div class="mb-6 flex items-center gap-4">
						<div
							class="flex h-14 w-14 flex-shrink-0 items-center justify-center rounded-xl bg-gradient-to-r from-green-500 to-green-600">
							<i class="fas fa-trophy text-2xl text-white"></i>
						</div>
						<div class="min-w-0 flex-1">
							<h3 class="mb-1 text-xl font-bold text-gray-900">
								Tontine terminée
							</h3>
							<div class="flex flex-wrap items-center gap-2">
								<span class="rounded-full bg-green-100 px-3 py-1 text-sm text-green-700">
									<i class="fas fa-check-circle mr-1"></i>
									Prêt pour retrait
								</span>

							</div>
						</div>
					</div>

					<div class="mb-8">
						<div class="mb-6 rounded-xl bg-white p-5 shadow-sm">
							<div class="mb-2 text-center text-sm font-medium text-gray-6000">
								Montant total disponible
							</div>
							<div class="mb-4 text-center text-4xl font-bold text-green-700">
								{{ tontine.totalPay|number_format(0, ',', ' ') }}
								F CFA
							</div>
							<div class="flex items-center justify-center gap-2 text-gray-600">
								<i class="fas fa-wallet text-green-500"></i>
								<span>Fonds sécurisés et disponibles</span>
							</div>
						</div>

						{% if is_granted('WITHDRAW', tontine) %}
						<div class="space-y-3">
							<a href="{{ path('app_withdrawal_request', {'id': tontine.id}) }}"
								class="flex w-full items-center justify-center gap-2 rounded-xl bg-gradient-to-r from-green-600 to-green-700 px-5 py-3.5 font-medium text-white shadow-md transition-all duration-300 hover:from-green-700 hover:to-green-800 hover:shadow-lg hover:scale-[1.02]">
								<i class="fas fa-download"></i>
								Demander le retrait complet
							</a>
							<p class="text-center text-sm text-gray-6000">
								Traitement sous 24-48h ouvrables
							</p>
						</div>
						{% endif %}
					</div>
				</div>

				{% elseif uiState == 'PARTIAL_WITHDRAWAL' %}
				<!-- ========================= PARTIAL WITHDRAWAL ========================= -->
				<div
					class="glass-card h-full rounded-2xl border-2 border-yellow-500 bg-gradient-to-br from-yellow-50/50 to-white p-6 shadow-hard">
					<div class="mb-6 flex items-center gap-4">
						<div
							class="flex h-14 w-14 flex-shrink-0 items-center justify-center rounded-xl bg-gradient-to-r from-yellow-500 to-yellow-600">
							<i class="fas fa-money-bill-wave text-2xl text-white"></i>
						</div>
						<div class="min-w-0 flex-1">
							<h3 class="mb-1 text-xl font-bold text-gray-900">
								Retrait partiel effectué
							</h3>
							<div class="flex flex-wrap items-center gap-2">
								<span class="rounded-full bg-yellow-100 px-3 py-1 text-sm text-yellow-600">
									<i class="fas fa-clock mr-1"></i>
									Solde disponible
								</span>
							</div>
						</div>
					</div>

					<div class="mb-8 space-y-5">
						<div class="grid grid-cols-1 gap-4 md:grid-cols-1">
							<div class="rounded-xl bg-white p-4 shadow-sm relative">
								<div class="flex justify-between items-start">
									<div>
										<div class="mb-1 text-sm font-medium text-gray-6000">Montant total</div>
										<div class="text-2xl font-bold text-gray-900">
											{{ tontine.totalPay|number_format(0, ',', ' ') }}
											F CFA
										</div>
									</div>
									{% if tontine.isFraisPreleves() %}
									<span
										class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
										<i class="fas fa-info-circle mr-1"></i>
										Frais déduits
									</span>
									{% endif %}
								</div>
								{% if tontine.isFraisPreleves() %}
								<div class="mt-2 pt-2 border-t border-gray-100 text-xs text-gray-6000">
									Frais de retrait: -{{ tontine.getAmountPerPoint()|number_format(0, ',', ' ') }}
									F CFA
								</div>
								{% endif %}
							</div>
							<div class="rounded-xl bg-white p-4 shadow-sm">
								<div class="mb-1 text-sm font-medium text-gray-6000">Déjà retiré</div>
								<div class="text-2xl font-bold text-green-700">
									{{ tontine.getWithdrawnAmount()|number_format(0, ',', ' ') }}
									F CFA
									{% if tontine.getWithdrawnAmount() > 0 %}
									<div class="text-xs font-normal text-gray-6000 mt-1">
										{{ tontine.withdrawals|length }}
										retrait(s) effectué(s)
									</div>
									{% endif %}
								</div>
							</div>
							<div class="rounded-xl bg-white p-4 shadow-sm border-2 border-yellow-200">
								<div class="mb-1 text-sm font-medium text-gray-6000">Solde disponible</div>
								<div class="text-2xl font-bold text-yellow-600">
									{{ (tontine.getRemainingAmount() - tontine.getAmountPerPoint())|number_format(0,
									',', ' ') }}
									F CFA
								</div>
								{% if tontine.isFraisPreleves() %}
								<div class="text-xs text-green-600 mt-1">
									<i class="fas fa-check-circle"></i>
									Frais de retrait déjà appliqués
								</div>
								{% endif %}
							</div>
						</div>

						{% if is_granted('WITHDRAW', tontine) and tontine.getRemainingAmount() > 0 %}
						<div class="space-y-3">
							<a href="{{ path('app_withdrawal_request', {'id': tontine.id}) }}"
								class="flex w-full items-center justify-center gap-2 rounded-xl bg-gradient-to-r from-yellow-600 to-yellow-600 px-5 py-3.5 font-medium text-white shadow-md transition-all duration-300 hover:from-yellow-600 hover:to-yellow-800 hover:shadow-lg hover:scale-[1.02]">
								<i class="fas fa-download mr-1"></i>
								Retirer le solde
							</a>
							<p class="text-center text-sm text-gray-6000">
								Vous pouvez effectuer plusieurs retraits
							</p>
						</div>
						{% endif %}
					</div>
				</div>

				{% elseif uiState == 'COMPLETED_FULL_WITHDRAWAL' %}
				<!-- ========================= COMPLETED FULL WITHDRAWAL ========================= -->
				<div
					class="glass-card h-full rounded-2xl border-2 border-green-500 bg-gradient-to-br from-green-50/30 to-white p-6 shadow-hard">
					<div class="mb-6 flex items-center gap-4">
						<div
							class="flex h-14 w-14 flex-shrink-0 items-center justify-center rounded-xl bg-gradient-to-r from-green-500 to-green-600">
							<i class="fas fa-flag-checkered text-2xl text-white"></i>
						</div>
						<div class="min-w-0 flex-1">
							<h3 class="mb-1 text-xl font-bold text-gray-900">
								Tontine clôturée
							</h3>
							<div class="flex flex-wrap items-center gap-2">
								<span class="rounded-full bg-green-100 px-3 py-1 text-sm text-green-700">
									<i class="fas fa-check-double mr-1"></i>
									Retrait complet effectué
								</span>
							</div>
						</div>
					</div>

					<div class="rounded-xl bg-white p-5 shadow-sm">
						<div class="mb-4 text-center">
							<div class="mb-2 flex justify-center">
								<div class="rounded-full bg-green-100 p-3">
									<i class="fas fa-check text-2xl text-green-600"></i>
								</div>
							</div>
							<h4 class="mb-2 text-lg font-semibold text-gray-900">
								Félicitations !
							</h4>
							<p class="mb-4 text-gray-600">
								Vous avez retiré tous vos fonds avec succès.
							</p>
						</div>

						<div class="rounded-lg bg-gray-50 p-4">
							<div class="mb-2 text-center text-sm font-medium text-gray-6000">
								Montant total retiré
							</div>
							<div class="text-center text-2xl font-bold text-green-700">
								{{ tontine.totalPay|number_format(0, ',', ' ') }}
								F CFA
							</div>
							<div class="mt-3 text-center text-sm text-gray-6000">
								<i class="fas fa-calendar-alt mr-1"></i>
								Clôturée le
								{{ tontine.endedAt|date('d M Y') }}
							</div>
						</div>
					</div>
				</div>

				{% endif %}
			</div>


		</div>
	</div>

</div>
<!-- End Main Container -->

<!-- Modal info point -->
<div id="pointInfoModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 p-4">
	<div class="min-h-screen flex items-center justify-center">
		<div class="bg-white rounded-2xl w-full max-w-xs shadow-2xl transform transition-all">
			<div class="p-6">
				<!-- En-tête du modal -->
				<div class="text-center mb-6">
					<div id="pointStatusIcon" class="text-4xl mb-3"></div>
					<h3 id="pointTitle" class="font-bold text-xl text-gray-900"></h3>
				</div>

				<!-- Informations -->
				<div class="space-y-4">
					<div class="p-3 bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg">
						<div class="text-sm text-gray-600 mb-1">Montant</div>
						<div id="pointAmount" class="text-xl font-bold text-green-700"></div>
					</div>

					<div class="p-3 bg-gradient-to-r from-green-50 to-sky-50 rounded-lg">
						<div class="text-sm text-gray-600 mb-1">Date estimée</div>
						<div id="pointDate" class="font-medium text-gray-900"></div>
					</div>

					<!-- Actions dynamiques -->
					<div id="pointActions" class="pt-4 border-t border-gray-100"></div>
				</div>

				<!-- Bouton fermer -->
				<button onclick="closePointInfo()"
					class="w-full mt-6 px-4 py-3 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-colors font-medium">
					Fermer
				</button>
			</div>
		</div>
	</div>
</div>

<!-- Modal Carte de Service (Mobile) -->
<div id="cardModal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm z-50 p-4">
	<div class="min-h-screen flex flex-col items-center justify-center">
		<!-- Bouton fermer en haut -->
		<button onclick="closeCardModal()" 
				class="absolute top-4 right-4 w-10 h-10 bg-white/10 hover:bg-white/20 rounded-full flex items-center justify-center text-white transition-colors touch-target">
			<i class="fa-solid fa-times text-xl"></i>
		</button>

		<!-- Carte en plein écran -->
		<div class="w-full max-w-md">
			<div class="relative overflow-hidden rounded-2xl shadow-2xl bg-gradient-to-br from-green-800 via-green-700 to-green-800" style="aspect-ratio: 85.6 / 54;">
				<!-- Badge Clôturée -->
				{% if uiState == 'COMPLETED_FULL_WITHDRAWAL' %}
				<div class="absolute top-4 right-4 z-10">
					<span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800">
						<i class="fas fa-times-circle mr-1"></i>
						Expirée
					</span>
				</div>
				{% endif %}
				
				<!-- Contenu de la carte -->
				<div class="relative p-5">
					<!-- En-tête de la carte -->
					<!-- En-tête de la carte -->
						<div class="flex justify-between items-start mb-3">
							<div class="flex items-center gap-3">
								<div class="flex flex-col top-1">
									<img src="{{ asset('images/carte_logo.png') }}" alt="Logo" style=" height: 40px;">
								</div>
							</div>

							<!-- Puce de carte -->
							<div class="absolute  flex items-center justify-start right-6 ">
								<div class=" bg-gradient-to-r from-yellow-400 to-yellow-300 rounded-md">
									<img class=" rounded-md" src="{{ path('qr_code',{'id': tontine.id}) }}"
										alt="QR Code">
								</div>
							</div>
						</div>

						<div class="mt-1 space-y-3">
							<!-- Nom de la tontine -->
							<div class=' grid grid-cols-2'>
								<div>
									<p class="text-green-300 text-xs font-medium ">TITULAIRE</p>
									<p class="text-[12px] font-bold text-white ">
										{{ tontine.utilisateur.firstname|slice(0, 15)|upper }}
										{{ tontine.utilisateur.lastname|upper|slice(0, 15) }}
									</p>
								</div>


							</div>

							<div class='mt-2 grid grid-cols-2'>
								<!-- Informations membre -->
								<div>
									<p class="text-green-300 text-xs font-medium ">TONTINE ASSOCIÉE</p>
									<p class="text-sm font-bold text-white">
										{{ tontine.tontineCode|upper|slice(0, 20) }}
									</p>

								</div>


								<!-- code Qr -->
								<div class="text-right">
									<p class="text-green-300 text-xs font-medium ">OBJECTIF</p>
									<p class="text-sm font-sm text-white">{{ tontine.name}}</p>
								</div>
							</div>

						</div>
						<!-- Pied de carte avec dates -->
						<div
							class="pt-2 mt-2 border-t {% if tontine.statut == 'completed' %}border-red-300/50{% else %}border-white/20{% endif %}">
							<div class="flex justify-between items-center">
								<div>
									<p class="text-green-300 text-xs">ÉMISSION</p>
									<p class="text-white font-medium text-xs">{{ tontine.createdAt|date('d/m/Y') }}</p>
								</div>


								<div class="text-right">
									<p class="text-green-300 text-xs">VALIDITÉ</p>
									<p class="text-white font-medium text-xs">

										<!-- la date du dernier point -->
										{% set lastPointDate = tontine.startDate|date_modify('+' ~ (tontine.totalPoints
										- 1) ~ ' ' ~ interval) %}
										{{ lastPointDate|date('d/m/Y') }}
									</p>
								</div>
							</div>


						</div>
				</div>
			</div>

			<!-- Bouton télécharger -->
			{% if uiState == 'ACTIVE' and uiState != 'COMPLETED_WITH_WITHDRAWAL' %}
			<button onclick="downloadCard('{{ tontine.tontineCode }}')" 
					class="w-full mt-4 inline-flex items-center justify-center gap-2 bg-white text-green-700 font-semibold py-3 px-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 touch-target">
				<i class="fa-solid fa-download"></i>
				Télécharger la carte
			</button>
			{% endif %}
		</div>
	</div>
</div>

<!-- Scripts de la carte -->
<script src="{{ asset('js/card-download.js') }}"></script>

<script>
	function openCardModal() {
		const modal = document.getElementById('cardModal');
		if (modal) {
			modal.classList.remove('hidden');
			document.body.style.overflow = 'hidden';
		}
	}

	function closeCardModal() {
		const modal = document.getElementById('cardModal');
		if (modal) {
			modal.classList.add('hidden');
			document.body.style.overflow = 'auto';
		}
	}

	function printCard() {
		const printContent = document.querySelector('.bg-gradient-to-br.from-white.to-green-50.border-2.border-green-800');
		const originalContent = document.body.innerHTML;

		document.body.innerHTML = printContent.outerHTML;
		window.print();
		document.body.innerHTML = originalContent;
		window.location.reload();
	}

	function showPointInfo(pointNumber) {
		const modal = document.getElementById('pointInfoModal');
		const pointTitle = document.getElementById('pointTitle');
		const pointAmount = document.getElementById('pointAmount');
		const pointDate = document.getElementById('pointDate');
		const pointStatusIcon = document.getElementById('pointStatusIcon');
		const pointActions = document.getElementById('pointActions');

		const amount = {{ tontine.amountPerPoint|default(0) }};
	
	const startDate = new Date('{{ tontine.startDate|date("Y-m-d") }}');
	const frequency = '{{ tontine.frequency|default("daily") }}';
	const paidPointsCount = {{ tontine.paidPoints|default(0) }};

	// Calculer la date estimée
	let estimatedDate = new Date(startDate);
	if (frequency === 'daily') {
		estimatedDate.setDate(startDate.getDate() + (pointNumber - 1));
	} else if (frequency === 'weekly') {
		estimatedDate.setDate(startDate.getDate() + ((pointNumber - 1) * 7));
	} else if (frequency === 'monthly') {
		estimatedDate.setMonth(startDate.getMonth() + (pointNumber - 1));
	}

	const isPaid = pointNumber <= paidPointsCount;
	const isCurrent = pointNumber === paidPointsCount + 1;
	const isLate = estimatedDate < new Date() && !isPaid;

	pointTitle.textContent = `Point #${pointNumber}`;
	pointAmount.textContent = `${amount.toLocaleString('fr-FR')
		} FCFA`;
	pointDate.textContent = estimatedDate.toLocaleDateString('fr-FR', {
		weekday: 'long',
		year: 'numeric',
		month: 'long',
		day: 'numeric'
	});

	if (isPaid) {
		pointStatusIcon.innerHTML = '<div class="h-16 w-16 rounded-full bg-gradient-to-r from-green-100 to-green-200 text-green-600 flex items-center justify-center mx-auto"><i class="fa-solid fa-check-circle text-2xl"></i></div>';
		pointActions.innerHTML = `
            <div class="text-center p-3 bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg">
                <div class="text-green-700 font-medium mb-1"><i class="fa-solid fa-check mr-2"></i>Point payé</div>
                <div class="text-xs text-green-600">Paiement effectué avec succès</div>
            </div>
        `;
	} else if (isLate) {
		pointStatusIcon.innerHTML = '<div class="h-16 w-16 rounded-full bg-gradient-to-r from-red-100 to-red-200 text-red-600 flex items-center justify-center mx-auto"><i class="fa-solid fa-exclamation-triangle text-2xl"></i></div>';
		pointActions.innerHTML = `
            <button onclick="payPoint(${pointNumber})" 
                    class="w-full px-4 py-3 bg-gradient-to-r from-red-600 to-red-700 text-white rounded-xl hover:from-red-700 hover:to-red-800 transition-all duration-300 font-medium">
                <i class="fa-solid fa-credit-card mr-2"></i> Payer en retard
            </button>
            <div class="text-xs text-red-600 text-center mt-2">Échéance dépassée</div>
        `;
	} else if (isCurrent) {
		pointStatusIcon.innerHTML = '<div class="h-16 w-16 rounded-full bg-gradient-to-r from-yellow-100 to-yellow-200 text-yellow-600 flex items-center justify-center mx-auto"><i class="fa-solid fa-clock-rotate-left text-2xl"></i></div>';
		pointActions.innerHTML = `
            <button onclick="payPoint(${pointNumber})" 
                    class="w-full px-4 py-3 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-xl hover:from-green-700 hover:to-green-800 transition-all duration-300 font-medium">
                <i class="fa-solid fa-credit-card mr-2"></i> Payer maintenant
            </button>
            <div class="text-xs text-green-600 text-center mt-2">Prochain paiement dû</div>
        `;
	} else {
		pointStatusIcon.innerHTML = '<div class="h-16 w-16 rounded-full bg-gradient-to-r from-gray-100 to-gray-200 text-gray-400 flex items-center justify-center mx-auto"><i class="fa-regular fa-calendar text-2xl"></i></div>';
		pointActions.innerHTML = `
            <div class="text-center p-3 bg-gradient-to-r from-gray-50 to-gray-100 rounded-lg">
                <div class="text-gray-700 font-medium mb-1"><i class="fa-solid fa-clock mr-2"></i>À venir</div>
                <div class="text-xs text-gray-600">Paiement programmé</div>
            </div>
        `;
	} modal.classList.remove('hidden');
	document.body.style.overflow = 'hidden';
}

	function closePointInfo() {
		document.getElementById('pointInfoModal').classList.add('hidden');
		document.body.style.overflow = 'auto';
	}

	function payPoint(pointNumber) {
		window.location.href = '{{ path("app_tontine_payment", {"id": tontine.id}) }}?point=' + pointNumber;
	}
</script>
<!-- Styles spécifiques pour la carte -->
<style>
	.public-card {
		width: 100%;
		max-width: 460px;
		/* confortable sur PC */
		margin: 0 auto;
	}

	.public-card .relative {
		aspect-ratio: 85.6 / 54;
	}

	/* Animation sur le bouton */
	@keyframes pulse {
		0% {
			transform: scale(1);
		}

		50% {
			transform: scale(1.05);
		}

		100% {
			transform: scale(1);
		}
	}

	button[onclick="downloadCard()"]:hover {
		animation: pulse 0.5s ease-in-out;
	}

	/* Code-barres réaliste */
	.barcode-line {
		animation: scan 2s ease-in-out infinite;
	}

	@keyframes scan {
		0% {
			opacity: 0.3;
		}

		50% {
			opacity: 1;
		}

		100% {
			opacity: 0.3;
		}
	}
</style>

<style>
	.touch-target {
		min-height: 44px;
		min-width: 44px;
	}

	/* Animation pour la barre de progression */
	@keyframes progressBar {
		0% {
			width: 0;
		}

		100% {
			width: var(--progress);
		}
	}

	.h-4.bg-gradient-to-r.from-green-500.via-green-600.to-green-700 {
		animation: progressBar 1s ease-out forwards;
	}

	/* Tooltip animations */
	.group:hover .absolute.bottom-full {
		animation: fadeInUp 0.2s ease-out forwards;
	}

	@keyframes fadeInUp {
		from {
			opacity: 0;
			transform: translate(-50%, 10px);
		}

		to {
			opacity: 1;
			transform: translate(-50%, 0);
		}
	}

	/* Styles d'impression */
	@media print {
		@page {
			margin: 0.5cm;
			size: A4 landscape;
		}

		body * {
			visibility: hidden;
		}

		.bg-gradient-to-br.from-white.to-green-50.border-2.border-green-800,
		.bg-gradient-to-br.from-white.to-green-50.border-2.border-green-800 * {
			visibility: visible;
		}

		.bg-gradient-to-br.from-white.to-green-50.border-2.border-green-800 {
			position: absolute;
			left: 0;
			top: 0;
			width: 100%;
			height: auto;
			box-shadow: none !important;
			border: 2px solid #000 !important;
			background: white !important;
			color: black !important;
		}

		/* Assurer une bonne lisibilité à l'impression */
		.text-green-800,
		.text-green-700,
		.text-green-600 {
			color: black !important;
		}

		.bg-gradient-to-r,
		.bg-gradient-to-br {
			background: white !important;
		}

		.border-green-800,
		.border-green-500,
		.border-green-300 {
			border-color: black !important;
		}
	}

	/* Responsive */
	@media(max-width: 768px) {
		.grid.grid-cols-7.md\:grid-cols-10.lg\:grid-cols-14 {
			grid-template-columns: repeat(5, 1fr);
		}

		.gap-3 {
			gap: 0.5rem;
		}
	}
</style>

<script src="https://cdn.kkiapay.me/k.js"></script>


{% endblock %}