{% extends 'dashboard/base.html.twig' %}

{% block title %}Paiement des Frais - {{ tontine.name }}{% endblock %}

{% block contentdashboard %}
<main class="flex-1 min-w-0 flex flex-col h-full bg-gradient-to-b from-green-50/20 to-white">
    <!-- Topbar -->
    <header class="bg-gradient-to-r from-green-700 via-green-600 to-green-700 text-white shadow-lg">
        <div class="max-w-[1400px] mx-auto px-6 py-4 flex items-center gap-4">
            <a href="{{ path('app_tontines_show', {'id': tontine.id}) }}"
                class="h-10 w-10 flex items-center justify-center rounded-xl bg-white/10 hover:bg-white/20 transition-all backdrop-blur-sm">
                <i class="fa-solid fa-arrow-left"></i>
            </a>
            <div>
                <h1 class="text-xl font-bold">Paiement des frais de service</h1>
                <p class="text-green-100 text-xs opacity-75">{{ tontine.name }} • {{ tontine.tontineCode }}</p>
            </div>
        </div>
    </header>

    <div class="flex-1 overflow-y-auto">
        <div class="max-w-[800px] mx-auto px-4 py-12">
            <!-- Glass Card Card -->
            <div
                class="bg-white rounded-[2.5rem] shadow-2xl shadow-green-900/10 border border-green-100 overflow-hidden">
                <!-- Header Card -->
                <div
                    class="bg-gradient-to-br from-green-50 to-white p-10 border-b border-green-100 relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-10 opacity-5 pointer-events-none">
                        <i class="fas fa-file-invoice-dollar text-9xl -rotate-12"></i>
                    </div>

                    <div class="relative z-10 flex items-center gap-6">
                        <div
                            class="h-20 w-20 rounded-3xl bg-green-700 flex items-center justify-center shadow-lg shadow-green-900/20">
                            <i class="fas fa-money-check-alt text-white text-3xl"></i>
                        </div>
                        <div>
                            <span
                                class="inline-flex px-3 py-1 rounded-full bg-green-100 text-green-700 text-[10px] font-black uppercase tracking-widest mb-2">Détails
                                de la facturation</span>
                            <h2 class="text-3xl font-black text-slate-900 tracking-tight">Récapitulatif des frais</h2>
                        </div>
                    </div>
                </div>

                <!-- Body Card -->
                <div class="p-10 space-y-10">
                    <!-- Breakdown Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="p-6 rounded-3xl bg-slate-50 border border-slate-100">
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Frais par
                                mois</p>
                            <div class="text-2xl font-black text-slate-900">{{ feePerMonth|number_format(0, ',', ' ') }}
                                <span class="text-sm font-medium text-slate-400">FCFA</span>
                            </div>
                        </div>
                        <div class="p-6 rounded-3xl bg-slate-50 border border-slate-100">
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Nombre de
                                mois</p>
                            <div class="text-2xl font-black text-green-700">{{ months }} <span
                                    class="text-sm font-medium text-slate-400">mois</span></div>
                        </div>
                    </div>

                    <!-- Total Section -->
                    <div class="bg-slate-900 rounded-[2rem] p-8 text-white relative overflow-hidden group">
                        <div class="absolute inset-0 bg-gradient-to-r from-green-800 to-slate-900 opacity-90"></div>
                        <div class="relative z-10 flex flex-col md:flex-row md:items-center justify-between gap-6">
                            <div>
                                <h3 class="text-green-400 font-bold uppercase tracking-[0.2em] text-xs mb-4">Total à
                                    régler maintenant</h3>
                                <div class="text-5xl font-black tracking-tighter">{{ totalFee|number_format(0, ',', ' ')
                                    }} <span class="text-xl font-normal opacity-50">FCFA</span></div>
                            </div>
                            <div class="flex-shrink-0">
                                <i class="fas fa-shield-alt text-4xl text-green-500/50"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Info Alert -->
                    <div
                        class="flex items-start gap-4 p-6 bg-yellow-50 rounded-3xl border border-yellow-100 text-yellow-800">
                        <i class="fas fa-info-circle mt-1"></i>
                        <p class="text-sm leading-relaxed font-medium">
                            Conformément à nos conditions générales, les frais de service sont calculés sur la durée
                            totale de votre projet d'épargne. Le paiement unique de ces frais vous permet de bénéficier
                            de tous nos services pendant toute la durée de votre tontine.
                        </p>
                    </div>

                    <!-- Actions -->
                    <div class="pt-6 border-t border-slate-100 flex flex-col sm:flex-row gap-4">
                        <button onclick="initKkiaPayPayment()"
                            class="flex-1 bg-green-700 hover:bg-yellow-500 hover:text-green-950 text-white font-black py-5 px-8 rounded-2xl transition-all shadow-xl shadow-green-900/20 active:scale-[0.98] flex items-center justify-center group">
                            <i
                                class="fa-solid fa-credit-card mr-3 text-lg opacity-50 group-hover:opacity-100 transition-opacity"></i>
                            <span>Payer par KkiaPay</span>
                        </button>
                        <a href="{{ path('app_tontines_show', {'id': tontine.id}) }}"
                            class="py-5 px-8 text-slate-400 font-bold uppercase tracking-widest text-xs hover:text-green-700 transition-all text-center">
                            Annuler
                        </a>
                    </div>
                </div>

                <!-- Footer Card -->
                <div class="bg-slate-50 p-6 text-center border-t border-slate-100">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Paiement 100% sécurisé
                        via KkiaPay</p>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Scripts KkiaPay integration -->
<script src="https://sdk.kkiapay.me/k.js"></script>
<script>
    function initKkiaPayPayment() {
        openKkiapayWidget({
            amount: {{ totalFee }},
    position: "right",
        callback: "{{ url('app_tontines_show', {id: tontine.id}) }}",
            sandbox: true,
                key: "{{ kkiapay_public_key }}",
                    theme: "#15803d",
                        name: "Frais de service - {{ tontine.name }}",
                            description: "Paiement unique des frais pour {{ months }} mois"
        });

    addKkiapayListener('success', (response) => {
        // Envoyer au serveur pour validation
        fetch("{{ path('app_tontine_fees_verify', {id: tontine.id}) }}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-Requested-With": "XMLHttpRequest"
            },
            body: JSON.stringify({
                transactionId: response.transactionId
            })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    window.location.href = data.redirect;
                } else {
                    alert(data.message);
                }
            })
            .catch(err => {
                console.error(err);
                alert("Une erreur est survenue lors de la validation.");
            });
    });
    }
</script>
{% endblock %}