{% extends "dashboard/base.html.twig" %}

{% block title %}Mes Tontines - Tableau{% endblock %}

{% block contentdashboard %}
<div class="min-h-screen bg-green-50 from-green-50 via-white to-green-50/30">
    <!-- Header Premium -->
    <header class="sticky top-0 z-40 bg-gradient-to-r from-green-700 via-green-600 to-green-700 shadow-lg">
        <div class="max-w-[1400px] mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-20">
                <!-- Logo/Brand -->
                <div class="flex items-center gap-4">
                 
                    <div class="flex flex-col">
                        <h1 class="text-xl font-bold text-white">Mes Tontines</h1>
                        <p class="text-green-100 text-sm">Vue tableau • {{ tontines|length }} tontine(s)</p>
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex items-center gap-4">
                    <!-- Search -->
                    <div class="relative hidden md:block">
                        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                            <i class="fa-solid fa-search text-green-200 text-sm"></i>
                        </div>
                        <input type="text" 
                               id="searchInput"
                               placeholder="Rechercher..."
                               class="pl-10 pr-4 py-2.5 w-64 bg-white/10 backdrop-blur-sm border border-white/20 rounded-xl text-white placeholder-green-200 focus:bg-white/20 focus:border-white/30 focus:ring-2 focus:ring-white/20 outline-none transition-all duration-200 text-sm">
                    </div>

                    <!-- View Toggle
                    <div class="flex items-center bg-white/10 backdrop-blur-sm rounded-xl border border-white/20 p-1">
                        <a href="{{ path('app_tontines_index') }}"
                           class="px-4 py-2 text-green-100 hover:text-white rounded-lg transition-colors">
                            <i class="fa-solid fa-grid-2"></i>
                        </a>
                        <span class="px-4 py-2 bg-white/20 text-white rounded-lg">
                            <i class="fa-solid fa-table-list"></i>
                        </span>
                    </div> -->

                    <!-- Add Button -->
                    <a href="{{ path('app_tontine') }}" 
                       class="relative group overflow-hidden">
                        <div class="absolute inset-0 bg-gradient-to-r from-green-500 to-emerald-500 blur-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                        <div class="relative px-5 py-2.5 bg-white rounded-xl shadow-lg group-hover:shadow-xl transition-all duration-300">
                            <span class="bg-gradient-to-r from-green-700 to-green-800 bg-clip-text text-transparent font-semibold text-sm flex items-center gap-2">
                                <i class="fa-solid fa-plus-circle"></i>
                                <span class="hidden sm:inline">Nouvelle</span>
                            </span>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-[1400px] mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Filters & Stats -->
        <div class="mb-8">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <!-- Quick Filters -->
                <div class="inline-flex items-center bg-white/80 backdrop-blur-sm rounded-2xl border border-green-100 p-1 shadow-sm">
                    <button data-filter="all" class="filter-btn px-5 py-2.5 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-xl text-sm font-medium transition-all duration-200 hover:shadow-md flex items-center gap-2">
                        <i class="fa-solid fa-layer-group"></i>
                        Toutes
                        <span class="ml-2 px-1.5 py-0.5 bg-white/20 rounded-md text-xs">{{ tontines|length }}</span>
                    </button>
                    <button data-filter="active" class="filter-btn px-5 py-2.5 text-gray-600 hover:text-green-700 rounded-xl text-sm font-medium transition-colors flex items-center gap-2">
                        <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                        Actives
                        <span class="ml-2 px-1.5 py-0.5 bg-green-100 text-green-700 rounded-md text-xs">
                            {{ tontines|filter(t => t.statut == 'active')|length }}
                        </span>
                    </button>
                    <button data-filter="completed" class="filter-btn px-5 py-2.5 text-gray-600 hover:text-gray-700 rounded-xl text-sm font-medium transition-colors flex items-center gap-2">
                        <div class="w-2 h-2 bg-gray-400 rounded-full"></div>
                        Terminées
                        <span class="ml-2 px-1.5 py-0.5 bg-gray-100 text-gray-700 rounded-md text-xs">
                            {{ tontines|filter(t => t.statut != 'active')|length }}
                        </span>
                    </button>
                </div>

                <!-- Export & Actions 
                <div class="flex items-center gap-3">
                    <button onclick="exportToExcel()" 
                            class="px-4 py-2.5 bg-white border border-green-300 text-green-700 rounded-xl text-sm font-medium hover:bg-green-50 transition-colors flex items-center gap-2">
                        <i class="fa-solid fa-file-export"></i>
                        <span class="hidden sm:inline">Exporter</span>
                    </button>
                    <button onclick="printTable()" 
                            class="px-4 py-2.5 bg-white border border-green-300 text-green-700 rounded-xl text-sm font-medium hover:bg-green-50 transition-colors flex items-center gap-2">
                        <i class="fa-solid fa-print"></i>
                        <span class="hidden sm:inline">Imprimer</span>
                    </button>
                </div>-->
            </div>
        </div>

        <!-- Table Container -->
        <div class="bg-white rounded-2xl border border-green-200 shadow-lg overflow-hidden">
            <!-- Table Header -->
            <div class="bg-gradient-to-r from-green-50 to-emerald-50 border-b border-green-200 px-6 py-4">
                <div class="flex items-center justify-between">
                    <h3 class="font-semibold text-green-800 flex items-center gap-2">
                        <i class="fa-solid fa-list-check"></i>
                        Liste des tontines
                    </h3>
                    <div class="text-sm text-green-600">
                        <span id="visibleCount">{{ tontines|length }}</span> sur {{ tontines|length }} visible(s)
                    </div>
                </div>
            </div>

            <!-- Responsive Table Container -->
            <div class="overflow-x-auto">
                <table class="w-full" id="tontinesTable">
                    <thead>
                        <tr class="bg-gradient-to-r from-gray-50 to-gray-100 border-b border-gray-200">
                            <th class="px-6 py-4 text-left">
                                <div class="flex items-center gap-2">
                                    <input type="checkbox" id="selectAll" class="rounded border-gray-300 text-green-600 focus:ring-green-500">
                                    <label for="selectAll" class="text-sm font-semibold text-gray-700">Nom</label>
                                </div>
                            </th>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Référence</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Statut</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Progression</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Fréquence</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        {% for tontine in tontines %}
                            {% set totalToSave = tontine.amountPerPoint * tontine.totalPoints %}
                            {% set savedAmount = tontine.amountPerPoint * (tontine.paidPoints|default(0)) %}
                            {% set progress = totalToSave > 0 ? (savedAmount / totalToSave * 100)|round : 0 %}
                            {% set isActive = tontine.statut == 'active' %}
                            {% set isCompleted = tontine.statut == 'completed' %}
                            {% set daysLeft = tontine.daysUntilNextPayment|default(0) %}
                            
                            <tr class="hover:bg-green-50/50 transition-colors duration-150 tontine-row" 
                                data-status="{{ isActive ? 'active' : 'completed' }}"
                                data-name="{{ tontine.name|lower }}"
                                data-code="{{ tontine.tontineCode|lower }}">
                                <!-- Nom avec Checkbox -->
                                <td class="px-6 py-4">
                                    <div class="flex items-center gap-3">
                                        <input type="checkbox" class="tontine-checkbox rounded border-gray-300 text-green-600 focus:ring-green-500">
                                        <div class="min-w-0">
                                            <div class="flex items-center gap-2">
                                                <div class="w-10 h-10 rounded-xl bg-gradient-to-br 
                                                    {{ isCompleted ? 'from-green-50 to-green-100' : (isActive ? 'from-green-100 to-emerald-100' : 'from-gray-100 to-gray-50') }} 
                                                    flex items-center justify-center flex-shrink-0">
                                                    <i class="fa-solid {{ isCompleted ? 'fa-check-circle text-green-500' : (isActive ? 'fa-wallet text-green-600' : 'fa-check-circle text-gray-400') }}"></i>
                                                </div>
                                                <div class="min-w-0 flex-1">
                                                    <div class="flex items-center gap-2">
                                                        <p class="font-medium text-gray-900 truncate">{{ tontine.name }}</p>
                                                        {% if tontine.statut == 'completed' %}
                                                            <span class="text-green-500" title="Tontine clôturée">
                                                                <i class="fas fa-lock"></i>
                                                            </span>
                                                        {% endif %}
                                                    </div>
                                                    <p class="text-xs text-gray-500 mt-0.5">
                                                        Créée le {{ tontine.createdAt|date('d/m/Y') }}
                                                        {% if tontine.statut == 'completed' and tontine.endedAt %}
                                                             • Clôturée le {{ tontine.endedAt|date('d/m/Y') }}
                                                        {% endif %}
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </td>

                                <!-- Référence -->
                                <td class="px-6 py-4">
                                    <div class="font-mono text-sm text-gray-700 bg-gray-50 px-3 py-1.5 rounded-lg inline-block border border-gray-200">
                                        {{ tontine.tontineCode }}
                                    </div>
                                </td>

                                <!-- Statut avec date de clôture -->
                                <td class="px-6 py-4">
                                    <div class="flex flex-col gap-1">
                                        {% if tontine.statut == 'completed' %}
                                            <span class="px-3 py-1.5 rounded-full text-xs font-medium bg-gradient-to-r from-green-50 to-green-100 text-green-800 border border-green-200 flex items-center gap-1.5 w-fit">
                                                <i class="fas fa-check-circle text-green-500"></i>
                                                Clôturée
                                            </span>
                                            {% if tontine.endedAt %}
                                                <span class="text-xs text-gray-500 mt-1">
                                                    Le {{ tontine.endedAt|date('d/m/Y') }}
                                                </span>
                                            {% endif %}
                                        {% elseif tontine.statut == 'active' %}
                                            <span class="px-3 py-1.5 rounded-full text-xs font-medium bg-gradient-to-r from-green-100 to-emerald-100 text-green-800 border border-green-200 flex items-center gap-1.5 w-fit">
                                                <div class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></div>
                                                Active
                                            </span>
                                        {% else %}
                                            <span class="px-3 py-1.5 rounded-full text-xs font-medium bg-gray-100 text-gray-700 border border-gray-200 flex items-center gap-1.5 w-fit">
                                                <div class="w-1.5 h-1.5 rounded-full bg-gray-400"></div>
                                                Terminée
                                            </span>
                                        {% endif %}
                                    </div>
                                </td>

                                <!-- Progression -->
                                <td class="px-6 py-4">
                                    <div class="space-y-2 min-w-[120px]">
                                        <div class="flex items-center justify-between text-sm">
                                            <span class="text-gray-600">{{ progress }}%</span>
                                            <span class="font-medium text-gray-900">{{ savedAmount|number_format(0, ',', ' ') }} FCFA</span>
                                        </div>
                                        <div class="h-2 bg-gray-100 rounded-full overflow-hidden">
                                            <div class="h-full bg-gradient-to-r {{ isActive ? 'from-green-500 to-emerald-500' : 'from-gray-400 to-gray-500' }} rounded-full transition-all duration-1000" 
                                                 style="width: {{ progress }}%"></div>
                                        </div>
                                        <div class="text-xs text-gray-500">
                                            {{ tontine.paidPoints|default(0) }}/{{ tontine.totalPoints }} points
                                        </div>
                                    </div>
                                </td>

                               

                                <!-- Fréquence -->
                                <td class="px-6 py-4">
                                    <div class="flex items-center gap-2">
                                        <div class="w-8 h-8 rounded-lg {{ tontine.frequency == 'daily' ? 'bg-green-100 text-green-600' : tontine.frequency == 'weekly' ? 'bg-yellow-100 text-yellow-600' : 'bg-green-100 text-green-600' }} flex items-center justify-center">
                                            <i class="fa-solid {{ tontine.frequency == 'daily' ? 'fa-sun' : tontine.frequency == 'weekly' ? 'fa-calendar-week' : 'fa-calendar-days' }} text-sm"></i>
                                        </div>
                                        <div>
                                            <div class="font-medium text-gray-900">
                                                {% if tontine.frequency == 'daily' %}Quotidienne
                                                {% elseif tontine.frequency == 'weekly' %}Hebdomadaire
                                                {% elseif tontine.frequency == 'monthly' %}Mensuelle
                                                {% else %}{{ tontine.frequency }}
                                                {% endif %}
                                            </div>
                                            <div class="text-xs text-gray-500">
                                                {{ tontine.totalPoints }} points
                                            </div>
                                        </div>
                                    </div>
                                </td>

                              

                                <!-- Actions -->
                                <td class="px-6 py-4">
                                    <div class="flex items-center gap-2">
                                        <a href="{{ path('app_tontines_show', {'id': tontine.id}) }}" 
                                           class="p-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors"
                                           title="Voir détails">
                                            <i class="fa-solid fa-eye"></i>
                                        </a>
                                        {% if isActive %}
                                            <a href="{{ path('app_tontine_payment', {'id': tontine.id}) }}"
                                               class="p-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors"
                                               title="Effectuer paiement">
                                                <i class="fa-solid fa-credit-card"></i>
                                            </a>
                                        {% endif %}
                                      
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}

                        {% if tontines|length == 0 %}
                            <!-- Empty State -->
                            <tr>
                                <td colspan="8" class="px-6 py-12 text-center">
                                    <div class="w-32 h-32 mx-auto mb-6 relative">
                                        <div class="absolute inset-0 bg-gradient-to-r from-green-400/20 to-emerald-400/10 rounded-full animate-pulse"></div>
                                        <div class="relative w-full h-full rounded-full bg-gradient-to-br from-white to-green-50 border-2 border-green-200 flex items-center justify-center">
                                            <i class="fa-solid fa-table text-green-500 text-5xl"></i>
                                        </div>
                                    </div>
                                    <h3 class="text-xl font-bold text-gray-900 mb-3">
                                        Aucune tontine pour le moment
                                    </h3>
                                    <p class="text-gray-600 max-w-md mx-auto mb-8">
                                        Créez votre première tontine pour commencer votre voyage d'épargne
                                    </p>
                                    <a href="{{ path('app_tontine') }}" 
                                       class="inline-flex items-center gap-3 px-8 py-3 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-xl hover:shadow-lg hover:scale-[1.02] transition-all duration-200 font-semibold shadow-md">
                                        <i class="fa-solid fa-plus-circle"></i>
                                        Créer ma première tontine
                                    </a>
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>

            <!-- Table Footer 
            <div class="bg-gradient-to-r from-gray-50 to-gray-100 border-t border-gray-200 px-6 py-4">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div class="text-sm text-gray-600">
                        <span id="selectedCount">0</span> tontine(s) sélectionnée(s)
                    </div>
                    <div class="flex items-center gap-3">
                        <button id="deleteSelected" 
                                class="px-4 py-2 bg-red-100 text-red-700 rounded-lg text-sm font-medium hover:bg-red-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                                disabled>
                            <i class="fa-solid fa-trash"></i>
                            Supprimer la sélection
                        </button>
                        <button id="exportSelected" 
                                class="px-4 py-2 bg-green-100 text-green-700 rounded-lg text-sm font-medium hover:bg-green-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                                disabled>
                            <i class="fa-solid fa-download"></i>
                            Exporter la sélection
                        </button>
                    </div>
                </div>
            </div>-->
        </div>

        <!-- Pagination -->
        {% if tontines|length > 0 %}
            <div class="mt-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div class="text-sm text-gray-600">
                    Affichage de 1 à {{ tontines|length }} sur {{ tontines|length }} tontine(s)
                </div>
                <div class="inline-flex items-center bg-white rounded-xl border border-gray-200 p-1">
                    <button class="px-3 py-2 text-gray-500 hover:text-gray-700 rounded-lg disabled:opacity-50">
                        <i class="fa-solid fa-chevron-left"></i>
                    </button>
                    <button class="px-3 py-2 bg-green-600 text-white rounded-lg">1</button>
                    <button class="px-3 py-2 text-gray-700 hover:text-green-600 rounded-lg">2</button>
                    <button class="px-3 py-2 text-gray-700 hover:text-green-600 rounded-lg">3</button>
                    <button class="px-3 py-2 text-gray-500 hover:text-gray-700 rounded-lg">
                        <i class="fa-solid fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        {% endif %}
    </main>

    <!-- Dropdown Menu Template -->
    <div id="actionDropdownTemplate" class="hidden">
        <div class="absolute right-0 mt-2 w-48 bg-white rounded-xl border border-gray-200 shadow-lg py-2 z-50">
            <a href="#" class="view-link block px-4 py-2 text-gray-700 hover:bg-gray-100">
                <i class="fa-solid fa-eye mr-2"></i>Voir détails
            </a>
            <a href="#" class="payment-link block px-4 py-2 text-gray-700 hover:bg-gray-100">
                <i class="fa-solid fa-credit-card mr-2"></i>Effectuer paiement
            </a>
            <a href="#" class="edit-link block px-4 py-2 text-gray-700 hover:bg-gray-100">
                <i class="fa-solid fa-edit mr-2"></i>Modifier
            </a>
            <div class="border-t border-gray-200 my-1"></div>
            <button class="delete-btn block w-full text-left px-4 py-2 text-red-600 hover:bg-red-50">
                <i class="fa-solid fa-trash mr-2"></i>Supprimer
            </button>
        </div>
    </div>
</div>

<style>
/* Table Styles */
#tontinesTable {
    border-collapse: separate;
    border-spacing: 0;
}

#tontinesTable th {
    position: sticky;
    top: 0;
    background: linear-gradient(to bottom, #f9fafb, #f3f4f6);
    z-index: 10;
    border-bottom: 2px solid #d1d5db;
}

#tontinesTable tr {
    transition: all 0.2s ease;
}

#tontinesTable tr:hover {
    background-color: rgba(16, 185, 129, 0.05);
}

/* Progress Bar Animation */
@keyframes progressFill {
    from { width: 0; }
}

.h-2.bg-gradient-to-r {
    animation: progressFill 1s ease-out;
}

/* Dropdown Animation */
@keyframes dropdownFade {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Custom Scrollbar for Table */
.table-container::-webkit-scrollbar {
    height: 8px;
    width: 8px;
}

.table-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

.table-container::-webkit-scrollbar-thumb {
    background: linear-gradient(to right, #008040, #059669);
    border-radius: 4px;
}

.table-container::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(to right, #059669, #047857);
}

/* Row Selection */
.tontine-row.selected {
    background-color: rgba(16, 185, 129, 0.1);
    border-left: 3px solid #008040;
}

/* Responsive
@media (max-width: 768px) {
    .overflow-x-auto {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    #tontinesTable th:nth-child(3),
    #tontinesTable td:nth-child(3),
    #tontinesTable th:nth-child(5),
    #tontinesTable td:nth-child(5) {
        display: none;
    }
}

@media (max-width: 640px) {
    # th:nth-child(6),
    #tontinesTable td:nth-child(6),
    #tontinesTable th:nth-child(7),
    #tontinesTable td:nth-child(7) {
        display: none;
    }
} */

/* Loading Skeleton */
.skeleton-row {
    animation: skeleton-loading 1.5s infinite;
}

@keyframes skeleton-loading {
    0% { opacity: 0.5; }
    50% { opacity: 0.8; }
    100% { opacity: 0.5; }
}

/* Print Styles */
@media print {
    header, footer, .filter-btn, .action-buttons {
        display: none !important;
    }
    
    #tontinesTable {
        border: 1px solid #000;
    }
    
    #tontinesTable th {
        background: #fff !important;
        color: #000 !important;
        border-bottom: 2px solid #000;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Select All Checkbox
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.tontine-checkbox');
    const selectedCount = document.getElementById('selectedCount');
    const deleteSelectedBtn = document.getElementById('deleteSelected');
    const exportSelectedBtn = document.getElementById('exportSelected');
    
    function updateSelectedCount() {
        const selected = document.querySelectorAll('.tontine-checkbox:checked');
        selectedCount.textContent = selected.length;
        
        // Enable/disable buttons
        deleteSelectedBtn.disabled = selected.length === 0;
        exportSelectedBtn.disabled = selected.length === 0;
        
        // Toggle row selection class
        checkboxes.forEach((checkbox, index) => {
            const row = checkbox.closest('.tontine-row');
            if (checkbox.checked) {
                row.classList.add('selected');
            } else {
                row.classList.remove('selected');
            }
        });
    }
    
    selectAll.addEventListener('change', function() {
        checkboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        updateSelectedCount();
    });
    
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            // Update select all state
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            const anyChecked = Array.from(checkboxes).some(cb => cb.checked);
            
            selectAll.checked = allChecked;
            selectAll.indeterminate = anyChecked && !allChecked;
            
            updateSelectedCount();
        });
    });
    
    // Filter Functionality
    const filterButtons = document.querySelectorAll('.filter-btn');
    const tontineRows = document.querySelectorAll('.tontine-row');
    const visibleCount = document.getElementById('visibleCount');
    
    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Update active filter button
            filterButtons.forEach(btn => {
                btn.classList.remove('bg-gradient-to-r', 'from-green-600', 'to-green-700', 'text-white');
                btn.classList.add('text-gray-600', 'hover:text-green-700');
            });
            
            this.classList.add('bg-gradient-to-r', 'from-green-600', 'to-green-700', 'text-white');
            this.classList.remove('text-gray-600', 'hover:text-green-700');
            
            const filter = this.getAttribute('data-filter');
            let visible = 0;
            
            tontineRows.forEach(row => {
                const status = row.getAttribute('data-status');
                
                if (filter === 'all' || status === filter) {
                    row.style.display = '';
                    visible++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            visibleCount.textContent = visible;
        });
    });
    
    // Search Functionality
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            let visible = 0;
            
            tontineRows.forEach(row => {
                const name = row.getAttribute('data-name');
                const code = row.getAttribute('data-code');
                
                if (name.includes(searchTerm) || code.includes(searchTerm) || searchTerm === '') {
                    row.style.display = '';
                    visible++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            visibleCount.textContent = visible;
        });
    }
    
    // Dropdown Actions
    const dropdownTriggers = document.querySelectorAll('.dropdown-trigger');
    let currentDropdown = null;
    
    dropdownTriggers.forEach(trigger => {
        trigger.addEventListener('click', function(e) {
            e.stopPropagation();
            
            // Close any existing dropdown
            if (currentDropdown) {
                currentDropdown.remove();
                currentDropdown = null;
            }
            
            // Get tontine ID
            const tontineId = this.getAttribute('data-id');
            const row = this.closest('tr');
            const tontineName = row.querySelector('p.font-medium').textContent;
            
            // Create dropdown from template
            const template = document.getElementById('actionDropdownTemplate');
            const dropdown = template.cloneNode(true);
            dropdown.id = '';
            dropdown.classList.remove('hidden');
            dropdown.style.position = 'absolute';
            dropdown.style.top = `${this.offsetTop + this.offsetHeight + 5}px`;
            dropdown.style.left = `${this.offsetLeft - dropdown.offsetWidth + this.offsetWidth}px`;
            dropdown.style.animation = 'dropdownFade 0.2s ease-out';
            
            // Update links with actual URLs
            const viewLink = dropdown.querySelector('.view-link');
            viewLink.href = `/tontines/${tontineId}`;
            
            const paymentLink = dropdown.querySelector('.payment-link');
            paymentLink.href = `/tontines/${tontineId}/payment`;
            
            const editLink = dropdown.querySelector('.edit-link');
            editLink.href = `/tontines/${tontineId}/edit`;
            
            // Add delete functionality
            const deleteBtn = dropdown.querySelector('.delete-btn');
            deleteBtn.addEventListener('click', function() {
                if (confirm(`Êtes-vous sûr de vouloir supprimer la tontine "${tontineName}" ?`)) {
                    // Implement delete functionality here
                    fetch(`/tontines/${tontineId}/delete`, {
                        method: 'DELETE',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            row.remove();
                            updateVisibleCount();
                        }
                    })
                    .catch(error => console.error('Error:', error));
                }
            });
            
            // Append dropdown
            document.body.appendChild(dropdown);
            currentDropdown = dropdown;
            
            // Close dropdown when clicking outside
            setTimeout(() => {
                document.addEventListener('click', closeDropdown);
            }, 10);
        });
    });
    
    function closeDropdown() {
        if (currentDropdown) {
            currentDropdown.remove();
            currentDropdown = null;
            document.removeEventListener('click', closeDropdown);
        }
    }
    
    // Bulk Actions
    deleteSelectedBtn.addEventListener('click', function() {
        const selected = Array.from(document.querySelectorAll('.tontine-checkbox:checked'))
            .map(checkbox => {
                const row = checkbox.closest('.tontine-row');
                return {
                    id: row.querySelector('.dropdown-trigger')?.getAttribute('data-id'),
                    name: row.querySelector('p.font-medium').textContent
                };
            });
        
        if (selected.length === 0) return;
        
        const names = selected.map(t => `"${t.name}"`).join(', ');
        if (confirm(`Êtes-vous sûr de vouloir supprimer ${selected.length} tontine(s) : ${names} ?`)) {
            // Implement bulk delete here
            selected.forEach(tontine => {
                const row = document.querySelector(`[data-id="${tontine.id}"]`)?.closest('.tontine-row');
                if (row) row.remove();
            });
            
            updateVisibleCount();
            updateSelectedCount();
        }
    });
    
    exportSelectedBtn.addEventListener('click', function() {
        const selected = Array.from(document.querySelectorAll('.tontine-checkbox:checked'))
            .map(checkbox => checkbox.closest('.tontine-row'));
        
        if (selected.length === 0) return;
        
        // Prepare data for export
        const data = selected.map(row => {
            return {
                name: row.querySelector('p.font-medium').textContent,
                code: row.querySelector('.font-mono').textContent,
                status: row.querySelector('[class*="rounded-full"]').textContent,
                progress: row.querySelector('.text-sm .text-gray-600').textContent,
            };
        });
        
        // Convert to CSV
        const headers = ['Nom', 'Référence', 'Statut', 'Progression'];
        const csvContent = [
            headers.join(','),
            ...data.map(row => [
                `"${row.name}"`,
                `"${row.code}"`,
                `"${row.status}"`,
                `"${row.progress}"`
            ].join(','))
        ].join('\n');
        
        // Download CSV
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `tontines_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });
    
    function updateVisibleCount() {
        const visible = document.querySelectorAll('.tontine-row[style=""]').length;
        visibleCount.textContent = visible;
    }
    
    // Print Functionality
    window.printTable = function() {
        window.print();
    };
    
    // Export to Excel
    window.exportToExcel = function() {
        alert('Fonctionnalité d\'export Excel à implémenter');
        // You would typically use a library like SheetJS here
    };
    
    // Initialize
    updateSelectedCount();
});
</script>
{% endblock %}