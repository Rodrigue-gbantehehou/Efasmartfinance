{% extends "dashboard/base.html.twig" %}

{% block title %}Paiement de la Tontine - {{ tontine.name }}{% endblock %}

{% block stylesheets %}
{{ parent() }}
<!-- Inclure le script KKiaPay -->
<script src="https://cdn.kkiapay.me/k.js"></script>
<style>
    .glass-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
    }

    .amount-btn.active {
        background-color: #15803d;
        color: white;
        border-color: #15803d;
    }

    /* Custom Input Styling */
    .custom-number-input::-webkit-outer-spin-button,
    .custom-number-input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    .custom-number-input {
        -moz-appearance: textfield;
    }

    .payment-method-radio:checked+div {
        border-color: #15803d;
        background-color: #f0fdf4;
    }

    .payment-method-radio:checked+div .check-icon {
        opacity: 1;
        transform: scale(1);
    }
</style>
{% endblock %}

{% block contentdashboard %}
<main class="flex-1 min-w-0 flex flex-col h-full bg-gradient-to-b from-green-50/30 to-white/50">
    <!-- Topbar -->
    <header class="bg-gradient-to-r from-green-700 via-green-600 to-green-700 text-white shadow-lg flex-shrink-0">
        <div class="max-w-[1400px] mx-auto px-4 md:px-6 py-3 md:py-4">
            <div class="flex items-center justify-between gap-3">
                <div class="flex items-center gap-3 min-w-0 flex-1">
                    <a href="{{ path('app_tontines_show', {'id': tontine.id}) }}"
                        class="h-9 w-9 md:h-10 md:w-10 flex items-center justify-center rounded-xl bg-white/10 hover:bg-white/20 transition-all backdrop-blur-sm flex-shrink-0 touch-target">
                        <i class="fa-solid fa-arrow-left text-sm"></i>
                    </a>
                    <div class="min-w-0">
                        <h1 class="text-base md:text-xl font-bold leading-tight truncate">Effectuer un versement</h1>
                        <p class="text-green-100 text-xs md:text-sm opacity-90 truncate">{{ tontine.name }} • {{ tontine.tontineCode }}</p>
                    </div>
                </div>
                <div class="hidden md:block flex-shrink-0">
                    <span class="px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider bg-white/20 border border-white/10">
                        {{ tontine.statut == 'active' ? 'Active' : 'Terminée' }}
                    </span>
                </div>
            </div>
        </div>
    </header>

    <div class="flex-1 overflow-y-auto p-4 md:p-6">
        <div class="max-w-5xl mx-auto">
            {% set totalToSave = tontine.amountPerPoint * tontine.totalPoints %}
            {% set savedAmount = tontine.amountPerPoint * (tontine.paidPoints|default(0)) %}
            {% set progress = totalToSave > 0 ? (savedAmount / totalToSave * 100)|round : 0 %}

            <div class="grid lg:grid-cols-3 gap-4 md:gap-6 lg:gap-8">

                <!-- Left Column: Payment Form -->
                <div class="lg:col-span-2 space-y-4 md:space-y-6">

                    <!-- Amount Selection Card -->
                    <div
                        class="bg-white rounded-[2rem] shadow-xl shadow-green-900/5 border border-green-50 overflow-hidden relative group">
                        <div
                            class="absolute top-0 right-0 p-8 opacity-5 pointer-events-none group-hover:scale-110 transition-transform duration-700">
                            <i class="fas fa-coins text-8xl -rotate-12 text-green-700"></i>
                        </div>

                        <!-- Header -->
                        <div class="p-4 md:p-6 lg:p-8 border-b border-gray-100 bg-gradient-to-br from-green-50/50 to-white relative z-10">
                            <h2 class="text-lg md:text-xl lg:text-2xl font-black text-gray-900 tracking-tight mb-1">Combien souhaitez-vous verser ?</h2>
                            <p class="text-gray-600 text-xs md:text-sm">Choisissez un montant ou saisissez une valeur personnalisée.</p>
                        </div>

                        <!-- Body -->
                        <div class="p-4 md:p-6 lg:p-8 space-y-4 md:space-y-6 lg:space-y-8 relative z-10">


<div class="bg-green-700 rounded-2xl p-4 border border-gray-200 shadow-sm sm:hidden">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="h-10 w-10 rounded-lg bg-white/20 flex items-center justify-center text-white font-bold text-sm">
                                {{ progress }}<span class="text-xs">%</span>
                            </div>
                            <div class="flex-1">
                                <p class="text-xs text-white font-bold uppercase mb-1">Progression</p>
                                <div class="h-1.5 bg-white/20 rounded-full overflow-hidden">
                                    <div class="h-full bg-yellow-400 rounded-full" style="width: {{ progress }}%"></div>
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-between items-center text-xs text-white pt-3 border-t border-white/20">
                            <span>Reste à payer:</span>
                            <span class="font-bold">{{ (tontine.amountPerPoint * (tontine.totalPoints|default(0)) - tontine.amountPerPoint * (tontine.paidPoints|default(0)))|number_format(0, ',', ' ') }} F</span>
                        </div>
                    </div>

                            <!-- Custom Amount -->
                            <div>
                                <label for="custom-amount" class="text-xs font-bold text-gray-600 uppercase tracking-widest block mb-2 md:mb-3">
                                    montant </label>
                                <div class="relative group focus-within:ring-2 md:focus-within:ring-4 ring-green-500/10 rounded-xl md:rounded-2xl transition-all">
                                    <div class="absolute inset-y-0 left-0 pl-3 md:pl-4 flex items-center pointer-events-none">
                                        <span class="text-gray-600 font-bold text-sm md:text-base">FCFA</span>
                                    </div>
                                    <input type="number" id="custom-amount"
                                        min="{{ tontine.amountPerPoint|default(100) }}" step="100"
                                        value="{{ tontine.amountPerPoint|default(100) }}"
                                        inputmode="numeric"
                                        class="custom-number-input w-full pl-14 md:pl-16 pr-3 md:pr-4 py-3 md:py-4 bg-gray-50/50 border border-gray-200 rounded-xl md:rounded-2xl text-lg md:text-xl font-black text-gray-900 placeholder-gray-400 focus:outline-none focus:border-green-500 focus:bg-white transition-all shadow-inner touch-target"
                                        placeholder="0">
                                </div>
                                <!--   <p class="mt-2 text-xs text-green-600 pl-1 font-medium">
                                    <i class="fa-solid fa-check-circle mr-1"></i> Multiple de {{
                                    tontine.amountPerPoint|default(100)|number_format(0, ',', ' ') }} FCFA
                                </p> -->
                            </div>
                            <!-- Option frais (checkbox) -->
                            {% set feesDue = tontine.getFeesDue() %}
                            {% if tontine.frequency != 'daily' %}
                                <div class="bg-yellow-50 rounded-xl p-4 border border-yellow-200">
                                    <label class="flex items-start gap-3 cursor-pointer select-none">
                                        <div class="relative flex items-center pt-1">
                                            <input type="checkbox" id="include-fees" 
                                                class="w-5 h-5 text-green-600 rounded border-gray-300 focus:ring-green-500 transition-all"
                                                checked
                                                onchange="toggleFees()">
                                        </div>
                                        <div class="flex-1">
                                            <span class="block font-bold text-gray-900">Inclure les frais</span>
                                            <span class="block text-sm text-gray-600 mt-0.5">
                                                Ajouter <span id="fee-display-amount" class="font-bold text-green-700">+{{ feesDue|number_format(0, ',', ' ') }} FCFA</span> au paiement
                                                <span class="text-xs text-gray-400 block">(Arriérés: {{ feesDue|number_format(0, ',', ' ') }} F + Frais courants)</span>
                                            </span>
                                        </div>
                                    </label>
                                    <input type="hidden" id="fees-arrears-amount" value="{{ feesDue }}">
                                </div>
                            {% endif %}

                            <!-- Suggested Amounts 
                            <div>
                                <label
                                    class="text-xs font-bold text-gray-600 uppercase tracking-widest block mb-3">Montants
                                    suggérés</label>
                                <div class="flex flex-wrap gap-3">
                                    {% for multiplier in 1..3 %}
                                    {% set amount = tontine.amountPerPoint|default(100) * multiplier %}
                                    <button type="button" onclick="setAmount({{ amount }})"
                                        class="amount-btn flex-1 min-w-[100px] py-3 px-4 rounded-xl border border-gray-200 bg-gray-50 hover:bg-gray-100 hover:border-gray-300 transition-all text-sm font-bold text-gray-700 {{ loop.first ? 'active' : '' }}">
                                        {{ amount|number_format(0, ',', ' ') }} F
                                    </button>
                                    {% endfor %}
                                </div>
                            </div>-->
                            <!-- Payment Actions -->
                            <div class="pt-3 md:pt-4 border-t border-gray-100">
                                <button id="process-payment-btn" onclick="initPayment()"
                                    class="w-full bg-yellow-400 hover:bg-yellow-300 text-green-950 font-black py-3 md:py-4 px-4 md:px-6 rounded-xl md:rounded-2xl transition-all shadow-lg shadow-yellow-400/20 active:scale-[0.98] flex items-center justify-center group disabled:opacity-50 disabled:cursor-not-allowed touch-target text-sm md:text-base">
                                    <span id="payment-btn-text" class="flex items-center gap-2">
                                        <span>Confirmer et Payer</span>
                                        <i
                                            class="fa-solid fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
                                    </span>
                                    <span id="payment-loading" class="hidden">
                                        <i class="fa-solid fa-spinner fa-spin mr-2"></i> Traitement...
                                    </span>
                                </button>

                                <div class="flex items-center justify-center gap-2 text-xs text-gray-600 mt-3">
                                    <i class="fa-solid fa-lock text-green-600"></i>
                                    <span>Paiement 100% sécurisé via KkiaPay</span>
                                </div>
                            </div>

                        </div>
                    </div>

                    <!-- Payment Method Card (Hidden Logic preserved, but styled if visible) -->
                    <div
                        class="bg-white rounded-[2rem] shadow-xl shadow-green-900/5 border border-green-50 overflow-hidden hidden">
                        <!-- Hidden as per original, keeping structure -->
                        <div class="p-6 md:p-8 border-b border-gray-100 bg-gradient-to-br from-gray-50 to-white">
                            <h2 class="text-xl font-bold text-gray-900">Moyen de paiement</h2>
                        </div>
                        <div class="p-6 md:p-8 space-y-4">
                            <!-- KkiaPay Option -->
                            <label class="block relative cursor-pointer group">
                                <input type="radio" name="payment_method" value="kkiapay"
                                    class="payment-method-radio sr-only" checked
                                    onchange="selectPaymentMethod('kkiapay')">
                                <div
                                    class="p-4 rounded-xl border border-gray-200 hover:border-green-300 transition-all flex items-center gap-4 bg-white">
                                    <div
                                        class="h-12 w-12 rounded-lg bg-green-50 flex items-center justify-center text-green-600 flex-shrink-0">
                                        <i class="fa-solid fa-mobile-screen text-xl"></i>
                                    </div>
                                    <div class="flex-1">
                                        <div class="font-bold text-gray-900">Mobile Money / Carte</div>
                                        <div class="text-xs text-gray-600">MTN, Moov, Visa, MasterCard</div>
                                    </div>
                                    <div
                                        class="check-icon h-6 w-6 rounded-full bg-green-500 text-white flex items-center justify-center text-xs opacity-0 scale-50 transition-all">
                                        <i class="fa-solid fa-check"></i>
                                    </div>
                                </div>
                            </label>
                        </div>
                        <!-- Container for dynamic payment buttons like PayPal -->
                        <div id="payment-process-container" class="px-6 pb-6"></div>

                        <!-- Error Display -->
                        <div id="payment-error"
                            class="mx-6 mb-6 p-4 rounded-xl bg-red-50 text-red-600 text-sm hidden flex items-start gap-3">
                            <i class="fa-solid fa-circle-exclamation mt-0.5"></i>
                            <span id="error-message"></span>
                        </div>
                    </div>

                </div>


                <div class="space-y-6 hidden sm:block">
                    <div class="bg-white rounded-3xl p-6 border border-gray-200 shadow-sm">
                        <div class="flex items-center gap-4 mb-4">
                            <div
                                class="h-12 w-12 rounded-xl bg-green-50 flex items-center justify-center text-green-600 font-bold text-lg">
                                {{ progress }}<span class="text-xs">%</span>
                            </div>
                            <div>
                                <p class="text-xs text-gray-700 font-bold uppercase">Progression</p>
                                <div class="w-24 h-2 bg-gray-100 rounded-full mt-1 overflow-hidden">
                                    <div class="h-full bg-green-500 rounded-full" style="width: {{ progress }}%"></div>
                                </div>
                            </div>
                        </div>

                        <div  class="flex justify-between items-center text-xs text-gray-600 pt-4 border-t border-gray-100">
                            <span>Reste à payer:</span>
                            <span class="font-bold text-gray-900">{{ (tontine.amountPerPoint * (tontine.totalPoints|default(0)) - tontine.amountPerPoint * (tontine.paidPoints|default(0)))|number_format(0, ',', ' ') }} FCFA</span>
                        </div>
                    </div>

                </div>

                <!-- Tontine Info Mini-Card -->


            </div>

        </div>
    </div>
    </div>
</main>


<!-- Hidden Data Fields -->
<input type="hidden" id="tontine-id" value="{{ tontine.id|default('') }}">
<input type="hidden" id="csrf-token" value="{{ csrf_token('payment') }}">
<input type="hidden" id="amount-per-point" value="{{ tontine.amountPerPoint|default(100) }}">
<input type="hidden" id="user-email" value="{{ app.user.email|default('') }}">
<input type="hidden" id="user-name" value="{{ app.user.nomComplet|default('') }}">
<input type="hidden" id="total-tontine-amount" value="{{ (tontine.amountPerPoint * tontine.totalPoints)|default(0) }}">
<input type="hidden" id="amount-paid"
    value="{{ (tontine.amountPerPoint * (tontine.paidPoints|default(0)))|default(0) }}">

<script>
    // ==================== CONFIGURATION ====================
    const API_BASE_URL = '{{ path("app_tontine_payment_init") }}';
    const API_VERIFY_URL = '{{ path("app_tontine_payment_verify") }}';
    const KKIA_PUBLIC_KEY = '{{ kkiapay_public_key|default("") }}';
    let selectedPaymentMethod = 'kkiapay'; // Default to kkiapay as it's the main one
    let currentAmount = {{ tontine.amountPerPoint|default (0) }};
    let feesArrears = 0;
    let totalFeesToPay = 0;
    let includeFees = false;
    
    // Calculate Fee Ratio (Total Service Fee / Total Tontine Amount)
    {% set totalTontine = tontine.amountPerPoint * tontine.totalPoints %}
    {% set totalFees = tontine.getDeductedServiceFee() %}
    const FEE_RATIO = {{ totalTontine > 0 ? (totalFees / totalTontine) : 0 }};

    // ==================== UTILITY FUNCTIONS ====================
    function isMultiple(number, multiple) {
        return number % multiple === 0;
    }

    function setLoading(isLoading) {
        const btn = document.getElementById('process-payment-btn');
        const loadingEl = document.getElementById('payment-loading');
        const btnText = document.getElementById('payment-btn-text');

        if (isLoading) {
            btn.disabled = true;
            btnText.classList.add('hidden');
            loadingEl.classList.remove('hidden');
        } else {
            btn.disabled = false;
            btnText.classList.remove('hidden');
            loadingEl.classList.add('hidden');
        }
    }

    // ==================== UPDATE UI ====================
    function updateDisplayAmount(amount) {
        const displayEl = document.getElementById('display-amount');
        if (displayEl) {
            displayEl.textContent = parseInt(amount).toLocaleString('fr-FR'); // Format nicely
        }
    }

    function toggleFees() {
        const cb = document.getElementById('include-fees');
        includeFees = cb ? cb.checked : false;
        feesArrears = parseInt(document.getElementById('fees-arrears-amount')?.value || 0);
        
        // Recalculate with current amount
        const input = document.getElementById('custom-amount');
        calculateFees(parseInt(input.value) || 0);
        
        updatePaymentButtonState();
    }

    function calculateFees(amount) {
        // Current Fee = Amount * Ratio
        const currentFee = Math.ceil(amount * FEE_RATIO);
        totalFeesToPay = feesArrears + currentFee;

        // Update UI logic
        const feeDisplay = document.getElementById('fee-display-amount');
        if (feeDisplay) {
            feeDisplay.textContent = '+' + totalFeesToPay.toLocaleString('fr-FR') + ' FCFA';
        }
    }

    // ==================== PAYMENT FUNCTIONS ====================
    function setAmount(amount) {
        const input = document.getElementById('custom-amount');
        if (!input) return;

        // Check Max
        const totalTontineAmount = parseInt(document.getElementById('total-tontine-amount').value) || 0;
        const amountPaid = parseInt(document.getElementById('amount-paid').value) || 0;
        const remainingAmount = totalTontineAmount - amountPaid;

        if (amount > remainingAmount) {
            alert(`Le montant dépasse le solde restant à payer (${remainingAmount.toLocaleString('fr-FR')} FCFA)`);
            return;
        }

        input.value = amount;
        currentAmount = parseInt(amount);
        updateDisplayAmount(currentAmount);

        // update buttons active state
        document.querySelectorAll('.amount-btn').forEach(btn => {
            const btnText = btn.textContent.replace(/[^\d]/g, ''); // strip non-digits
            if (parseInt(btnText) == amount) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });

        updatePaymentButtonState();
    }

    function selectPaymentMethod(method) {
        selectedPaymentMethod = method;
        // UI update handled by css :checked mostly, but good for logic
    }


    function updatePaymentButtonState() {
        const input = document.getElementById('custom-amount');
        const button = document.getElementById('process-payment-btn');
        if (!input || !button) return;

        const validation = validateAmount(parseInt(input.value) || 0);
        
        // Calculate Total
        const tontineAmount = parseInt(input.value) || 0;
        let total = tontineAmount;
        
        // Update fees based on current amount
        calculateFees(tontineAmount);

        if (includeFees) {
            total += totalFeesToPay;
        }

        const btnText = document.getElementById('payment-btn-text');

        if (validation.isValid) {
            button.disabled = false;
            button.classList.remove('opacity-50', 'cursor-not-allowed');
            // Update button text
            btnText.innerHTML = `<span>Payer ${total.toLocaleString('fr-FR')} FCFA</span> <i class="fa-solid fa-arrow-right ml-2 group-hover:translate-x-1 transition-transform"></i>`;
        } else {
            button.disabled = true;
            button.classList.add('opacity-50', 'cursor-not-allowed');
            btnText.innerHTML = `<span>Montant invalide</span>`;
        }
    }

    function validateAmount(amount) {
        const totalTontineAmount = parseInt(document.getElementById('total-tontine-amount').value) || 0;
        const amountPaid = parseInt(document.getElementById('amount-paid').value) || 0;
        const remainingAmount = totalTontineAmount - amountPaid;
        const minAmount = parseInt(document.getElementById('custom-amount').min) || 0;
        const amountPerPoint = parseInt(document.getElementById('amount-per-point').value) || 100;

        if (!amount || isNaN(amount) || amount < minAmount) {
            return { isValid: false, message: `Minimum ${minAmount} FCFA` };
        }

        if (!isMultiple(amount, amountPerPoint)) {
            return { isValid: false, message: `Multiple de ${amountPerPoint} FCFA requis` };
        }

        if (amount > remainingAmount) {
            return { isValid: false, message: `Max ${remainingAmount} FCFA` };
        }

        return { isValid: true };
    }


    // ==================== INIT ====================
    document.addEventListener('DOMContentLoaded', function () {
        const input = document.getElementById('custom-amount');
        if (input) {
            input.addEventListener('input', function () {
                const val = parseInt(this.value) || 0;
                currentAmount = val;
                updateDisplayAmount(val);

                // Highlight custom button if matches, else none
                document.querySelectorAll('.amount-btn').forEach(btn => {
                    btn.classList.remove('active');
                });

                updatePaymentButtonState();
            });
        }

        // Initial State
        if (input) {
            currentAmount = parseInt(input.value) || 0;
            updateDisplayAmount(currentAmount);
            toggleFees(); // Initialize fee state
            updatePaymentButtonState();
        }
    });


    // ==================== API / PAYMENT START ====================
    async function initPayment() {
        // Re-validate
        const input = document.getElementById('custom-amount');
        const amount = parseInt(input.value) || 0;
        const validation = validateAmount(amount);

        if (!validation.isValid) {
            alert(validation.message);
            return;
        }

        setLoading(true);

        try {
            const csrfToken = document.getElementById('csrf-token').value;
            const tontineId = document.getElementById('tontine-id').value;

            const response = await fetch(API_BASE_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    'X-CSRF-Token': csrfToken
                },
                body: JSON.stringify({
                    tontine_id: tontineId,
                    amount: includeFees ? (currentAmount + totalFeesToPay) : currentAmount,
                    method: selectedPaymentMethod,
                    include_fees: includeFees,
                    fee_amount: totalFeesToPay
                })
            });

            const data = await response.json();

            if (data.success) {
                handlePaymentInit(data);
            } else {
                alert(data.message || 'Erreur d\'initialisation');
                setLoading(false);
            }

        } catch (e) {
            console.error(e);
            alert('Erreur de connexion');
            setLoading(false);
        }
    }

    function handlePaymentInit(data) {
        if (selectedPaymentMethod === 'kkiapay') {
            initKkiaPay(data);
        } else {
            // Fallback/Extensible for other methods
            alert('Méthode non supportée');
            setLoading(false);
        }
    }

    // ==================== KKIAPAY LOGIC ====================
    function initKkiaPay(data) {
        if (typeof openKkiapayWidget === 'undefined') {
            alert('KKiaPay non chargé. Veuillez recharger la page.');
            setLoading(false);
            return;
        }

        const userEmail = document.getElementById('user-email').value;
        const userName = document.getElementById('user-name').value;
        const tontineId = document.getElementById('tontine-id').value;

        const config = {
            amount: data.amount,
            key: data.public_key || KKIA_PUBLIC_KEY,
            position: "center",
            theme: "#15803d",
            sandbox: true,
            data: JSON.stringify({
                payment_id: data.payment_id,
                tontine_id: tontineId,
                description: "Versement tontine"
            }),
            name: userName,
            email: userEmail
        };

        addKKiaPayListeners(data.payment_id);
        openKkiapayWidget(config);
        setLoading(false);
    }

    function addKKiaPayListeners(paymentId) {
        try {
            removeSuccessListeners();
            removeFailedListeners();
        } catch (e) { }

        addSuccessListener(async (response) => {
            setLoading(true);
            try {
                const transactionId = response.transactionId || response.id;
                await verifyPayment(paymentId, transactionId);
            } catch (e) {
                console.error(e);
                alert('Erreur de vérification');
                setLoading(false);
            }
        });

        addFailedListener((error) => {
            console.error(error);
            alert('Paiement échoué');
            setLoading(false);
        });
    }

    // ==================== VERIFICATION LOGIC ====================
    async function verifyPayment(paymentId, transactionId) {
        try {
            const csrfToken = document.getElementById('csrf-token').value;
            const response = await fetch(API_VERIFY_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    'X-CSRF-Token': csrfToken
                },
                body: JSON.stringify({
                    payment_id: paymentId,
                    transaction_id: transactionId
                })
            });

            const data = await response.json();

            if (data.success) {
                window.location.href = "{{ path('app_tontine_payment_success', {id: 'PAYMENT_ID'}) }}".replace('PAYMENT_ID', paymentId);
            } else {
                alert('Validation échouée: ' + (data.message || 'Erreur'));
                setLoading(false);
            }
        } catch (error) {
            console.error(error);
            alert('Erreur serveur durant la vérification');
            setLoading(false);
        }
    }
</script>
{% endblock %}