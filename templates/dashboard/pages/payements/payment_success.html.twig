{% extends "dashboard/base.html.twig" %}

{% block title %}Confirmation de Paiement - EFA SMART FINANCE{% endblock %}

{% block stylesheets %}
{{ parent() }}
<style>
    .success-animation {
        animation: scaleIn 0.5s ease-out;
    }
    
    .pulse-dot {
        animation: pulse 2s infinite;
    }
    
    @keyframes scaleIn {
        from {
            transform: scale(0.8);
            opacity: 0;
        }
        to {
            transform: scale(1);
            opacity: 1;
        }
    }
    
    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
        }
    }
    
    .receipt-shadow {
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    
    .gradient-border {
        border: 2px solid transparent;
        background: linear-gradient(white, white) padding-box,
                    linear-gradient(135deg, #10b981, #3b82f6) border-box;
    }
</style>
{% endblock %}

{% block contentdashboard %}
<div class="min-h-screen bg-gradient-to-br from-gray-50 to-green-50 flex flex-col items-center justify-center p-4">
    <div class="max-w-lg w-full success-animation">
        <!-- Success Card -->
        <div class="bg-white rounded-3xl receipt-shadow overflow-hidden mb-6 gradient-border">
            <!-- Header -->
            <div class="bg-gradient-to-r from-primary to-green-500 p-6 text-center relative">
                <!-- Confetti effect -->
                <div class="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none">
                    <div class="absolute top-4 left-1/4 w-2 h-2 bg-yellow-300 rounded-full opacity-70"></div>
                    <div class="absolute top-2 right-1/3 w-3 h-3 bg-blue-400 rounded-full opacity-60"></div>
                    <div class="absolute bottom-4 left-1/3 w-2 h-2 bg-purple-400 rounded-full opacity-70"></div>
                </div>
                
                <div class="relative z-10">
                    <!-- Success Icon -->
                    <div class="h-24 w-24 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-4 pulse-dot">
                        <div class="h-20 w-20 bg-white rounded-full flex items-center justify-center">
                            <i class="fa-solid fa-check text-primary text-4xl"></i>
                        </div>
                    </div>
                    
                    <!-- Title -->
                    <h1 class="text-3xl font-bold text-white mb-2">Paiement confirmé !</h1>
                    <p class="text-white/90 text-lg">Transaction réussie</p>
                </div>
            </div>
            
            <!-- transaction Details -->
            <div class="p-8">
                <!-- Summary -->
                <div class="text-center mb-8">
                    <div class="text-5xl font-bold text-primary mb-2">
                        {{ transaction.amount|number_format(0, ',', ' ') }} FCFA
                    </div>
                    <p class="text-gray-500">Montant payé</p>
                </div>
                
                <!-- Details Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                    <!-- Transaction Info -->
                    <div class="bg-gray-50 rounded-xl p-4">
                        <div class="flex items-center text-gray-500 mb-2">
                            <i class="fa-solid fa-receipt mr-2"></i>
                            <span class="text-sm font-medium">Référence</span>
                        </div>
                        <div class="font-mono text-gray-900">
                            {{ transaction.transactionId|default('N/A')|slice(0, 12) }}...
                        </div>
                    </div>
                    
                    <!-- transaction paymentMethod -->
                    <div class="bg-gray-50 rounded-xl p-4">
                        <div class="flex items-center text-gray-500 mb-2">
                            {% if transaction.paymentMethod == 'kkiapay' %}
                                <i class="fa-solid fa-mobile-screen mr-2"></i>
                            {% elseif transaction.paymentMethod == 'paypal' %}
                                <i class="fa-brands fa-paypal mr-2"></i>
                            {% elseif transaction.paymentMethod == 'cash' %}
                                <i class="fa-solid fa-money-bill mr-2"></i>
                            {% else %}
                                <i class="fa-solid fa-credit-card mr-2"></i>
                            {% endif %}
                            <span class="text-sm font-medium">Méthode</span>
                        </div>
                        <div class="font-medium text-gray-900">
                            {% if transaction.paymentMethod == 'kkiapay' %}Mobile Money
                            {% elseif transaction.paymentMethod == 'paypal' %}PayPal
                            {% elseif transaction.paymentMethod == 'cash' %}Espèces
                            {% else %}Carte bancaire{% endif %}
                        </div>
                    </div>
                    
                    <!-- Tontine Info -->
                    <div class="bg-gray-50 rounded-xl p-4 md:col-span-2">
                        <div class="flex items-center text-gray-500 mb-2">
                            <i class="fa-solid fa-piggy-bank mr-2"></i>
                            <span class="text-sm font-medium">Tontine</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="font-bold text-gray-900">{{ transaction.tontine.name }}</div>
                                <div class="text-sm text-gray-500">{{ transaction.tontine.tontineCode }}</div>
                            </div>
                            <span class="px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                {{ transaction.tontine.statut == 'active' ? 'Active' : 'Terminée' }}
                            </span>
                        </div>
                    </div>
                </div>
                
                <!-- Timeline -->
                <div class="border-t border-gray-200 pt-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Détails de la transaction</h3>
                    <div class="space-y-4">
                        <div class="flex items-center">
                            <div class="h-10 w-10 rounded-full bg-green-100 flex items-center justify-center mr-4">
                                <i class="fa-solid fa-check text-green-600"></i>
                            </div>
                            <div class="flex-1">
                                <div class="font-medium text-gray-900">Paiement validé</div>
                                <div class="text-sm text-gray-500">{{ transaction.createdAt|date('d/m/Y à H:i') }}</div>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <div class="h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center mr-4">
                                <i class="fa-solid fa-coins text-blue-600"></i>
                            </div>
                            <div class="flex-1">
                                <div class="font-medium text-gray-900">Montant ajouté à votre épargne</div>
                                <div class="text-sm text-gray-500">Points acquis : {{ (transaction.amount / transaction.tontine.amountPerPoint)|round(1) }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Actions -->
        <div class="space-y-4">
            <!-- Primary Actions -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <a href="{{ path('app_tontines_index') }}" 
                   class="group flex items-center justify-center py-4 px-6 bg-primary text-white rounded-xl font-medium hover:bg-green-700 transition-all duration-300 transform hover:-translate-y-1">
                    <i class="fa-solid fa-list mr-3"></i>
                    <span>Mes tontines</span>
                </a>
                <a href="{{ path('app_tontines_show', {'id': transaction.tontine.id}) }}" 
                   class="group flex items-center justify-center py-4 px-6 bg-white text-gray-900 border-2 border-gray-200 rounded-xl font-medium hover:bg-gray-50 hover:border-primary transition-all duration-300 transform hover:-translate-y-1">
                    <i class="fa-solid fa-chart-line mr-3 text-primary"></i>
                    <span>Suivi de la tontine</span>
                </a>
            </div>
            
            <!-- Secondary Actions -->
            <div class="bg-white rounded-xl p-4 border border-gray-200">
                <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                    <div class="flex items-center text-gray-600">
                        <i class="fa-solid fa-receipt mr-2"></i>
                        <span class="text-sm">Recevez un reçu par email</span>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button onclick="window.print()" 
                                class="flex items-center py-2 px-4 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200 transition-colors">
                            <i class="fa-solid fa-print mr-2"></i>
                            Imprimer
                        </button>
                        <button onclick="downloadReceipt()" 
                                class="flex items-center py-2 px-4 bg-blue-100 text-blue-700 rounded-lg font-medium hover:bg-blue-200 transition-colors">
                            <i class="fa-solid fa-download mr-2"></i>
                            Télécharger
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Support -->
            <div class="text-center pt-4">
                <p class="text-sm text-gray-500 mb-2">
                    Besoin d'aide ou vous avez une question ?
                </p>
                <div class="flex items-center justify-center space-x-4">
                    <a href="tel:+22890123456" 
                       class="text-sm text-primary hover:text-green-700 font-medium">
                        <i class="fa-solid fa-phone mr-1"></i>
                        +228 90 12 34 56
                    </a>
                    <a href="mailto:support@efasmartfinance.com" 
                       class="text-sm text-primary hover:text-green-700 font-medium">
                        <i class="fa-solid fa-envelope mr-1"></i>
                        support@efasmartfinance.com
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Print Styles -->
<style media="print">
    @media print {
        body * {
            visibility: hidden;
        }
        .min-h-screen, .min-h-screen * {
            visibility: visible;
        }
        .min-h-screen {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            background: white;
        }
        button, .flex.items-center.space-x-3, .text-center.pt-4 {
            display: none !important;
        }
    }
</style>

<script>
function downloadReceipt() {
    // Créer un PDF du reçu (vous pouvez implémenter une API pour générer un vrai PDF)
    const receiptContent = `
        ====================================
                    EFA SMART FINANCE
        ====================================
        
        REÇU DE PAIEMENT
        
        Référence : ${'{{ transaction.transactionId|default("N/A") }}'}
        Date : ${'{{ transaction.createdAt|date("d/m/Y H:i") }}'}
        
        DÉTAILS DU PAIEMENT
        --------------------
        Montant : ${'{{ transaction.amount|number_format(0, ",", " ") }}'} FCFA
        Méthode : ${'{{ transaction.paymentMethod }}'}
        
        DÉTAILS DE LA TONTINE
        ----------------------
        Nom : ${'{{ transaction.tontine.name }}'}
        Code : ${'{{ transaction.tontine.tontineCode }}'}
        Statut : ${'{{ transaction.tontine.statut == "active" ? "Active" : "Terminée" }}'}
        
        ====================================
        Merci pour votre confiance !
        ====================================
        
        Contact : support@efasmartfinance.com
        Tel : +228 90 12 34 56
    `;
    
    // Créer un blob et télécharger
    const blob = new Blob([receiptContent], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `reçu-paiement-${'{{ transaction.tontine.tontineCode }}'}-${'{{ transaction.createdAt|date("Ymd") }}'}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// Animation de confetti
document.addEventListener('DOMContentLoaded', function() {
    // Confetti simple
    setTimeout(() => {
        for (let i = 0; i < 20; i++) {
            createConfetti();
        }
    }, 500);
    
    function createConfetti() {
        const colors = ['#10b981', '#3b82f6', '#8b5cf6', '#f59e0b'];
        const confetti = document.createElement('div');
        confetti.className = 'absolute w-2 h-2 rounded-full';
        confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.left = Math.random() * 100 + '%';
        confetti.style.top = '0';
        confetti.style.opacity = '0.8';
        confetti.style.zIndex = '40';
        
        document.querySelector('.relative.z-10').appendChild(confetti);
        
        // Animation
        const animation = confetti.animate([
            { transform: 'translateY(0) rotate(0deg)', opacity: 1 },
            { transform: `translateY(${window.innerHeight * 0.3}px) rotate(${Math.random() * 360}deg)`, opacity: 0 }
        ], {
            duration: 1000 + Math.random() * 1000,
            easing: 'cubic-bezier(0.215, 0.61, 0.355, 1)'
        });
        
        animation.onfinish = () => confetti.remove();
    }
    
    // Auto-redirection après 30 secondes
    setTimeout(() => {
        const redirectUrl = '{{ path('app_tontines_index') }}';
        const countdownEl = document.createElement('div');
        countdownEl.className = 'fixed bottom-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg text-sm z-50';
        countdownEl.innerHTML = 'Redirection dans <span id="countdown">5</span> secondes...';
        document.body.appendChild(countdownEl);
        
        let countdown = 5;
        const countdownInterval = setInterval(() => {
            countdown--;
            document.getElementById('countdown').textContent = countdown;
            
            if (countdown <= 0) {
                clearInterval(countdownInterval);
                countdownEl.remove();
                window.location.href = redirectUrl;
            }
        }, 1000);
    }, 30000);
});
</script>
{% endblock %}