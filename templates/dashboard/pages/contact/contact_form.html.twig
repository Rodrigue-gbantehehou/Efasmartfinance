<div id="contactModal" class="hidden fixed inset-0 bg-black/50 z-50 backdrop-blur-sm transition-opacity">
    <div class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full md:max-w-md max-h-[85vh] overflow-y-auto shadow-2xl transform transition-all">
            <div class="p-4 md:p-6">
                <div class="flex items-center justify-between mb-4 md:mb-6">
                    <h3 class="text-base md:text-lg font-bold text-gray-900">Contacter le support</h3>
                    <button type="button" onclick="closeContactModal()" 
                            class="p-2 hover:bg-gray-100 rounded-lg transition-colors touch-target">
                        <i class="fa-solid fa-times text-gray-600"></i>
                    </button>
                </div>
                
                <form id="supportForm" onsubmit="return submitSupportForm(event)" class="space-y-3 md:space-y-4">
                    <div>
                        <label class="block text-xs md:text-sm font-medium text-gray-700 mb-2">
                            Sujet <span class="text-red-500">*</span>
                        </label>
                        <select name="subject" required
                                class="w-full px-3 md:px-4 py-2 md:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-700 focus:border-green-700 touch-target text-sm md:text-base">
                            <option value="">Choisir un sujet</option>
                            <option value="technical">Problème technique</option>
                            <option value="payment">Problème de paiement</option>
                            <option value="account">Problème de compte</option>
                            <option value="tontine">Question sur les tontines</option>
                            <option value="security">Question de sécurité</option>
                            <option value="other">Autre</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Description <span class="text-red-500">*</span>
                        </label>
                        <textarea name="message" required
                                  rows="4"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-700 focus:border-green-700 touch-target"
                                  placeholder="Décrivez votre problème ou question en détail..."></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Fichier joint (optionnel)
                        </label>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-green-700 transition-colors">
                            <i class="fa-solid fa-cloud-arrow-up text-3xl text-gray-400 mb-2"></i>
                            <div class="text-sm text-gray-600">
                                <label for="file-upload" class="text-green-700 cursor-pointer hover:text-green-700">
                                    Cliquez pour téléverser (optionnel)
                                </label>
                                <input id="file-upload" name="attachment" type="file" class="hidden" accept="image/*,.pdf,.doc,.docx">
                                <input type="hidden" name="name" value="{{ app.user ? app.user.firstname ~ ' ' ~ app.user.lastname : '' }}">
                                <input type="hidden" name="email" value="{{ app.user ? app.user.email : '' }}">
                                <div id="file-name" class="text-xs mt-2 text-gray-6000"></div>
                            </div>
                            <div class="text-xs text-gray-6000 mt-1">Max. 5MB (images, PDF, documents)</div>
                        </div>
                    </div>
                    
                    <div class="pt-4">
                        <button type="submit"
                                class="w-full px-6 py-3 bg-green-700 text-white rounded-lg hover:bg-green-700 transition-colors font-medium flex items-center justify-center gap-2 touch-target">
                            <i class="fa-solid fa-paper-plane"></i>
                            Envoyer la demande
                        </button>
                        <div class="text-center text-xs text-gray-6000 mt-3">
                            <i class="fa-solid fa-clock mr-1"></i>
                            Réponse généralement sous 24h
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Gestion de la modale de contact
function openContactModal() {
    document.getElementById('contactModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden'; // Empêche le défilement de la page
}

function closeContactModal() {
    document.getElementById('contactModal').classList.add('hidden');
    document.body.style.overflow = ''; // Réactive le défilement de la page
}

// Afficher le nom du fichier sélectionné
document.getElementById('file-upload').addEventListener('change', function(e) {
    const fileName = e.target.files.length > 0 ? e.target.files[0].name : 'Aucun fichier sélectionné';
    document.getElementById('file-name').textContent = fileName;
});

// Gestion du formulaire
async function submitSupportForm(event) {
    event.preventDefault();
    
    const form = event.target;
    const submitButton = form.querySelector('button[type="submit"]');
    const originalButtonText = submitButton.innerHTML;
    
    // Afficher un indicateur de chargement
    submitButton.disabled = true;
    submitButton.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Envoi en cours...';
    
    try {
        const formData = new FormData(form);
        
        // Vérifier la taille du fichier (max 5MB)
        const fileInput = document.getElementById('file-upload');
        if (fileInput.files.length > 0) {
            const fileSize = fileInput.files[0].size / 1024 / 1024; // en MB
            if (fileSize > 5) {
                throw new Error('La taille du fichier ne doit pas dépasser 5MB');
            }
        }
        
        const response = await fetch("{{ path('api_support_submit') }}", {
            method: 'POST',
            headers: {
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        });
        
        const data = await response.json();
        
        if (response.ok) {
            // Succès
            showNotification('Votre demande a été envoyée avec succès ! Notre équipe vous contactera bientôt.', 'success');
            form.reset();
            document.getElementById('file-name').textContent = '';
            closeContactModal();
        } else {
            // Erreur de validation
            if (data.errors) {
                let errorMessage = 'Veuillez corriger les erreurs suivantes :<ul class="list-disc pl-5 mt-2">';
                Object.values(data.errors).forEach(error => {
                    errorMessage += `<li>${error}</li>`;
                });
                errorMessage += '</ul>';
                showNotification(errorMessage, 'error', 10000);
            } else {
                showNotification(data.message || 'Une erreur est survenue lors de l\'envoi de votre demande', 'error');
            }
        }
    } catch (error) {
        console.error('Erreur:', error);
        showNotification(error.message || 'Une erreur est survenue lors de l\'envoi du formulaire. Veuillez réessayer plus tard.', 'error');
    } finally {
        // Réactiver le bouton
        submitButton.disabled = false;
        submitButton.innerHTML = originalButtonText;
    }
    
    return false;
}
</script>