{% extends 'dashboard/base.html.twig' %}


{% block title %}Vérification d'identité - Efa Smart Finance{% endblock %}


{% block contentdashboard %}

{{ form_start(formcompte, {'attr': { 'enctype': 'multipart/form-data', 'id': 'verificationForm' }}) }}
<div class="min-h-screen bg-green-50-to-b from-gray-50 to-gray-100 py-6 px-4 sm:px-6 lg:px-8">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="mb-8">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
                <div class="flex items-center gap-3">
                    <a href="{{ path('app_dashboard') }}" 
                       class="inline-flex items-center gap-2 px-3 py-2 text-sm text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-colors">
                        <i class="fa-solid fa-arrow-left text-sm"></i>
                        Retour
                    </a>
                    <div class="h-6 w-px bg-gray-300"></div>
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold text-gray-900">Vérification d'identité</h1>
                        <p class="text-gray-600 mt-1">Sécurisez votre compte en validant votre identité</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <span class="inline-flex items-center gap-1 px-3 py-1.5 bg-green-100 text-green-800 text-xs font-medium rounded-full">
                        <i class="fa-solid fa-shield-alt"></i>
                        Sécurisé & Crypté
                    </span>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-200">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium text-gray-700">Progression de vérification</span>
                    <span id="progressPercentage" class="text-sm font-semibold text-green-600">0%</span>
                </div>
                <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                    <div id="progressBar" class="h-full bg-gradient-to-r from-green-500 to-green-600 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="space-y-6">
            <!-- Step 1: Personal Information -->
            <div id="step1" class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="border-b border-gray-100 px-6 py-4 bg-gradient-to-r from-green-50 to-green-50/50">
                    <div class="flex items-center gap-3">
                        <div class="flex-shrink-0 h-10 w-10 rounded-lg bg-white border border-green-200 flex items-center justify-center">
                            <span class="font-bold text-green-600">1</span>
                        </div>
                        <div>
                            <h2 class="text-lg font-bold text-gray-900">Informations personnelles</h2>
                            <p class="text-sm text-gray-600">Remplissez vos informations de base</p>
                        </div>
                    </div>
                </div>
                
                <div class="p-6">
                    <div id="personalInfoForm" class="space-y-5">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <!-- Prénom -->
                            <div class="space-y-2">
                                {{ form_label(formcompte.firstname, 'Prénom', {'label_attr': {'class': 'block text-sm font-medium text-gray-700'}}) }}
                                {{ form_widget(formcompte.firstname, {
                                    'attr': {
                                        'class': 'w-full px-4 py-3 border border-gray-300 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-200 transition-all outline-none',
                                        'placeholder': 'Votre prénom'
                                    }
                                }) }}
                                {{ form_errors(formcompte.firstname) }}
                            </div>

                            <!-- Nom -->
                            <div class="space-y-2">
                                {{ form_label(formcompte.lastname, 'Nom', {'label_attr': {'class': 'block text-sm font-medium text-gray-700'}}) }}
                                {{ form_widget(formcompte.lastname, {
                                    'attr': {
                                        'class': 'w-full px-4 py-3 border border-gray-300 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-200 transition-all outline-none',
                                        'placeholder': 'Votre nom de famille'
                                    }
                                }) }}
                                {{ form_errors(formcompte.lastname) }}
                            </div>
                        </div>
                        
                        <!-- Date de naissance -->
                        <div class="space-y-2">
                            {{ form_label(formcompte.birthDate, 'Date de naissance', {'label_attr': {'class': 'block text-sm font-medium text-gray-700'}}) }}
                            <div class="relative">
                                {{ form_widget(formcompte.birthDate, {
                                    'attr': {
                                        'class': 'w-full px-4 py-3 border border-gray-300 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-200 transition-all outline-none',
                                        'max': 'now'|date_modify('-18 years')|date('Y-m-d')
                                    }
                                }) }}
                            </div>
                            <p class="text-xs text-gray-600 mt-1">
                                <i class="fa-solid fa-info-circle text-green-500 mr-1"></i>
                                Vous devez avoir au moins 18 ans
                            </p>
                            {{ form_errors(formcompte.birthDate) }}
                        </div>
                        
                        <!-- Nationalité -->
                        <div class="space-y-2">
                            {{ form_label(formcompte.nationality, 'Nationalité', {'label_attr': {'class': 'block text-sm font-medium text-gray-700'}}) }}
                            {{ form_widget(formcompte.nationality, {
                                'attr': {
                                    'class': 'w-full px-4 py-3 border border-gray-300 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-200 transition-all outline-none bg-white'
                                }
                            }) }}
                            {{ form_errors(formcompte.nationality) }}
                        </div>
                        
                        <!-- Adresse -->
                        <div class="space-y-2">
                            {{ form_label(formcompte.address, 'Adresse complète', {'label_attr': {'class': 'block text-sm font-medium text-gray-700'}}) }}
                            {{ form_widget(formcompte.address, {
                                'attr': {
                                    'class': 'w-full px-4 py-3 border border-gray-300 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-200 transition-all outline-none resize-none',
                                    'rows': 3,
                                    'placeholder': 'Numéro, rue, ville, code postal, pays'
                                }
                            }) }}
                            {{ form_errors(formcompte.address) }}
                        </div>
                        
                        <!-- Téléphone -->
                        <div class="space-y-2">
                            {{ form_label(formcompte.phoneNumber, 'Numéro de téléphone', {'label_attr': {'class': 'block text-sm font-medium text-gray-700'}}) }}
                            <div class="flex flex-col sm:flex-row gap-3">
                             
                                <div class="flex-1">
                                    {{ form_widget(formcompte.phoneNumber, {
                                        'attr': {
                                            'class': 'w-full px-4 py-3 border border-gray-300 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-200 transition-all outline-none',
                                            'placeholder': 'XX XX XX XX',
                                         
                                        }
                                    }) }}
                                    {{ form_errors(formcompte.phoneNumber) }}
                                </div>
                            </div>
                           
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Identity Document -->
            <div id="step2" class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="border-b border-gray-100 px-6 py-4 bg-gradient-to-r from-green-50 to-green-50/50">
                    <div class="flex items-center gap-3">
                        <div class="flex-shrink-0 h-10 w-10 rounded-lg bg-white border border-green-200 flex items-center justify-center">
                            <span class="font-bold text-green-600">2</span>
                        </div>
                        <div>
                            <h2 class="text-lg font-bold text-gray-900">Document d'identité</h2>
                            <p class="text-sm text-gray-600">Téléchargez une photo de votre pièce d'identité</p>
                        </div>
                    </div>
                </div>
                
                <div class="p-6">
                    <div class="space-y-5">
                        <!-- Document Type -->
                        <div class="space-y-2">
                            {{ form_label(formcompte.documentType, 'Type de document', {'label_attr': {'class': 'block text-sm font-medium text-gray-700'}}) }}
                            {{ form_widget(formcompte.documentType, {
                                'attr': {
                                    'class': 'w-full px-4 py-3 border border-gray-300 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-200 transition-all outline-none bg-white',
                                    'required': 'required'
                                }
                            }) }}
                            {{ form_errors(formcompte.documentType) }}
                        </div>

                        <!-- Document Front Upload -->
                        <div class="space-y-2">
                            {{ form_label(formcompte.documentFront, 'Recto du document', {'label_attr': {'class': 'block text-sm font-medium text-gray-700'}}) }}
                            <div class="relative">
                                <div class="relative">
                                    {{ form_widget(formcompte.documentFront, {
                                        'attr': {
                                            'class': 'hidden-file-input',
                                            'accept': 'image/*,.pdf',
                                            'data-dropzone': 'documentFront',
                                            'onchange': 'handleFileSelect(this, "documentFrontPreview")'
                                        }
                                    }) }}
                                    {{ form_errors(formcompte.documentFront) }}
                                    
                                    <div id="documentFrontDropzone" 
                                         class="upload-dropzone"
                                         onclick="document.getElementById('{{ formcompte.documentFront.vars.id }}').click()"
                                         ondragover="event.preventDefault(); this.classList.add('dragover');"
                                         ondragleave="this.classList.remove('dragover');"
                                         ondrop="handleDrop(event, '{{ formcompte.documentFront.vars.id }}', 'documentFrontPreview')">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                        <p>Glissez et déposez votre fichier ici ou <span class="browse-link">parcourir</span></p>
                                        <p class="text-xs text-gray-600 mt-2">Formats acceptés : JPG, PNG, PDF (max. 5MB)</p>
                                    </div>
                                    
                                    <!-- Prévisualisation du fichier -->
                                    <div id="documentFrontPreview" class="file-previews mt-4"></div>
                                </div>
                            </div>
                        </div>


                        <!-- Document Details -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mt-6">
                            <!-- Document Number -->
                            <div class="space-y-2">
                                {{ form_label(formcompte.documentNumber, 'Numéro du document', {'label_attr': {'class': 'block text-sm font-medium text-gray-700'}}) }}
                                {{ form_widget(formcompte.documentNumber, {
                                    'attr': {
                                        'class': 'w-full px-4 py-3 border border-gray-300 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-200 transition-all outline-none',
                                        'placeholder': 'Ex: 123456789012'
                                    }
                                }) }}
                                {{ form_errors(formcompte.documentNumber) }}
                            </div>
                            
                            <!-- Expiry Date -->
                            <div class="space-y-2">
                                {{ form_label(formcompte.expiryDate, "Date d'expiration", {'label_attr': {'class': 'block text-sm font-medium text-gray-700'}}) }}
                                <div class="relative">
                                    {{ form_widget(formcompte.expiryDate, {
                                        'attr': {
                                            'class': 'w-full px-4 py-3 border border-gray-300 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-200 transition-all outline-none',
                                            'min': 'now'|date('Y-m-d')
                                        }
                                    }) }}
                                </div>
                                {{ form_errors(formcompte.expiryDate) }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Selfie -->
            <div id="step3" class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="border-b border-gray-100 px-6 py-4 bg-gradient-to-r from-yellow-50 to-yellow-50/50">
                    <div class="flex items-center gap-3">
                        <div class="flex-shrink-0 h-10 w-10 rounded-lg bg-white border border-yellow-200 flex items-center justify-center">
                            <span class="font-bold text-yellow-600">3</span>
                        </div>
                        <div>
                            <h2 class="text-lg font-bold text-gray-900">Photo selfie avec document</h2>
                            <p class="text-sm text-gray-600">Prenez une photo de vous tenant votre pièce d'identité</p>
                        </div>
                    </div>
                </div>
                
                <div class="p-6">
                    <div class="space-y-5">
                        <!-- Instructions -->
                        <div class="bg-green-50 border border-green-100 rounded-xl p-4">
                            <div class="flex items-start gap-3">
                                <div class="flex-shrink-0 h-8 w-8 rounded-full bg-green-100 text-green-600 flex items-center justify-center mt-0.5">
                                    <i class="fa-solid fa-lightbulb"></i>
                                </div>
                                <div>
                                    <p class="font-medium text-green-800 mb-2">Instructions importantes</p>
                                    <ul class="text-sm text-green-700 space-y-1">
                                        <li class="flex items-start gap-2">
                                            <i class="fa-solid fa-check-circle text-green-500 mt-0.5"></i>
                                            <span>Tenez votre pièce d'identité à côté de votre visage</span>
                                        </li>
                                        <li class="flex items-start gap-2">
                                            <i class="fa-solid fa-check-circle text-green-500 mt-0.5"></i>
                                            <span>Assurez-vous que votre visage et le document soient bien visibles</span>
                                        </li>
                                        <li class="flex items-start gap-2">
                                            <i class="fa-solid fa-check-circle text-green-500 mt-0.5"></i>
                                            <span>Utilisez un bon éclairage et évitez les reflets</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Selfie Capture Section -->
                        <div class="space-y-4">
                            <!-- Toggle Buttons -->
                            <div class="flex flex-wrap gap-3 mb-4">
                                <button type="button" id="useCameraButton" onclick="toggleCaptureMode('camera')" class="flex-1 flex items-center justify-center gap-2 px-4 py-3 bg-white border-2 border-green-600 text-green-600 rounded-xl font-semibold hover:bg-green-50 transition-all">
                                    <i class="fa-solid fa-camera"></i>
                                    Prendre une photo
                                </button>
                                <button type="button" id="useUploadButton" onclick="toggleCaptureMode('upload')" class="flex-1 flex items-center justify-center gap-2 px-4 py-3 bg-gray-100 border-2 border-transparent text-gray-600 rounded-xl font-semibold hover:bg-gray-200 transition-all">
                                    <i class="fa-solid fa-upload"></i>
                                    Télécharger
                                </button>
                            </div>

                            <!-- Camera Interface (Hidden by default) -->
                            <div id="cameraContainer" class="hidden space-y-4 animate-fadeIn">
                                <div class="relative rounded-2xl overflow-hidden bg-black aspect-video shadow-inner">
                                    <video id="video" class="w-full h-full object-cover mirror" autoplay playsinline></video>
                                    <div id="cameraOverlay" class="absolute inset-0 border-2 border-dashed border-white/30 pointer-events-none flex items-center justify-center">
                                        <div class="w-64 h-64 border-2 border-white/50 rounded-full"></div>
                                    </div>
                                    <div id="cameraErrorUI" class="hidden absolute inset-0 bg-gray-900 flex flex-col items-center justify-center p-6 text-center z-10">
                                        <div class="w-16 h-16 bg-red-100 text-red-600 rounded-full flex items-center justify-center mb-4">
                                            <i class="fa-solid fa-camera-slash text-2xl"></i>
                                        </div>
                                        <h3 class="text-white font-bold mb-2">Accès à la caméra impossible</h3>
                                        <p id="cameraErrorMessage" class="text-gray-400 text-sm mb-6">
                                            Nous n'avons pas pu accéder à votre caméra.
                                        </p>
                                        <div class="flex flex-col w-full gap-2">
                                            <button type="button" onclick="startCamera()" class="w-full py-2.5 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition-colors">
                                                Réessayer
                                            </button>
                                            <button type="button" onclick="toggleCaptureMode('upload')" class="w-full py-2.5 bg-gray-800 text-gray-300 rounded-lg font-semibold hover:bg-gray-700 transition-colors">
                                                Utiliser le mode téléchargement
                                            </button>
                                        </div>
                                        <div id="permissionInstructions" class="mt-4 text-xs text-gray-500 text-left w-full border-t border-gray-800 pt-4 hidden">
                                            <p class="font-semibold text-gray-400 mb-1">Comment autoriser l'accès :</p>
                                            <ol class="list-decimal list-inside space-y-1">
                                                <li>Cliquez sur l'icône de cadenas/paramètres dans la barre d'adresse</li>
                                                <li>Activez l'accès à la "Caméra"</li>
                                                <li>Actualisez la page si nécessaire</li>
                                            </ol>
                                        </div>
                                    </div>
                                    <canvas id="canvas" class="hidden"></canvas>
                                </div>
                                <div class="flex gap-3">
                                    <button type="button" onclick="capturePhoto()" class="flex-1 py-3 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 shadow-lg shadow-green-600/20 flex items-center justify-center gap-2">
                                        <i class="fa-solid fa-circle"></i>
                                        Capturer
                                    </button>
                                </div>
                            </div>

                            <!-- Upload Section (Hidden by default) -->
                            <div id="uploadSection" class="hidden">
                                <div class="relative">
                                    {{ form_widget(formcompte.selfie, {
                                        'attr': {
                                            'accept': 'image/*',
                                            'data-dropzone': 'selfie'
                                        }
                                    }) }}
                                    {{ form_errors(formcompte.selfie) }}
                                </div>
                            </div>
                            
                            <!-- Captured/Uploaded Preview -->
                            <div id="confirmedSelfiePreview" class="hidden mt-6">
                                <div class="bg-green-50 border border-green-200 rounded-xl p-4 overflow-hidden">
                                    <div class="flex items-center justify-between mb-4">
                                        <div class="flex items-center gap-3">
                                            <div class="h-10 w-10 rounded-full bg-green-100 text-green-600 flex items-center justify-center">
                                                <i class="fa-solid fa-check text-lg"></i>
                                            </div>
                                            <div>
                                                <p class="font-bold text-green-800">Photo sélectionnée</p>
                                                <p class="text-xs text-green-600">Prête pour la vérification</p>
                                            </div>
                                        </div>
                                        <button type="button" onclick="resetSelfie()" class="text-red-500 hover:text-red-700 p-2 rounded-lg hover:bg-red-50 transition-colors">
                                            <i class="fa-solid fa-trash-can text-lg"></i>
                                        </button>
                                    </div>
                                    <div class="rounded-lg overflow-hidden border border-green-100 shadow-sm max-h-64 flex justify-center bg-white">
                                        <img id="confirmedSelfieImage" alt="Selfie" class="max-h-64 w-auto object-contain">
                                    </div>
                                </div>
                            </div>

                            <!-- Tips -->
                            <div id="selfieTips" class="text-sm text-gray-600 bg-gray-50 rounded-lg p-4">
                                <p class="font-medium text-gray-900 mb-2">Conseils :</p>
                                <ul class="space-y-1">
                                    <li class="flex items-center gap-2">
                                        <i class="fa-solid fa-check text-green-500"></i>
                                        <span>Visage et document bien visibles</span>
                                    </li>
                                    <li class="flex items-center gap-2">
                                        <i class="fa-solid fa-check text-green-500"></i>
                                        <span>Bon éclairage (évitez le contre-jour)</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Confirmation -->
            <div class="bg-white rounded-2xl border border-green-200 p-6 shadow-sm">
                <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                    <div>
                        <h3 class="text-lg font-bold text-gray-900">Prêt à soumettre votre vérification ?</h3>
                        <p class="text-sm text-gray-600 mt-1">
                            Vérifiez que toutes les informations sont correctes avant de soumettre.
                        </p>
                    </div>
                    <button type="submit" 
                            id="submitVerificationBtn"
                            class="w-full sm:w-auto px-8 py-3.5 text-base font-semibold text-white bg-gradient-to-r from-green-600 to-green-700 rounded-xl hover:from-green-700 hover:to-green-800 transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
                        <i class="fa-solid fa-check-circle mr-2"></i>
                        <span>Soumettre la vérification</span>
                    </button>
                </div>
                
                <!-- Summary -->
                <div id="verificationSummary" class="hidden mt-6 pt-6 border-t border-gray-200">
                    <h4 class="font-medium text-gray-900 mb-3">Résumé de votre soumission :</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="h-8 w-8 rounded-full bg-green-100 text-green-600 flex items-center justify-center">
                                    <i class="fa-solid fa-user-check"></i>
                                </div>
                                <span class="font-medium text-gray-900">Informations personnelles</span>
                            </div>
                            <div class="text-sm text-gray-600">
                                <p id="summaryName"></p>
                                <p id="summaryPhone" class="mt-1"></p>
                            </div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="h-8 w-8 rounded-full bg-green-100 text-green-600 flex items-center justify-center">
                                    <i class="fa-solid fa-id-card"></i>
                                </div>
                                <span class="font-medium text-gray-900">Document d'identité</span>
                            </div>
                            <div class="text-sm text-gray-600">
                                <p id="summaryDocument"></p>
                                <p id="summaryExpiry" class="mt-1"></p>
                            </div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="h-8 w-8 rounded-full bg-yellow-100 text-yellow-600 flex items-center justify-center">
                                    <i class="fa-solid fa-camera"></i>
                                </div>
                                <span class="font-medium text-gray-900">Selfie</span>
                            </div>
                            <div class="text-sm text-gray-600" id="summarySelfie">
                                Prêt pour vérification
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Security Note -->
            <div class="text-center">
                <div class="inline-flex items-center gap-2 text-sm text-gray-600 bg-white rounded-lg px-4 py-3 border border-gray-200">
                    <i class="fa-solid fa-shield-halved text-green-500"></i>
                    <span>Vos données sont sécurisées, cryptées et conformes au RGPD.</span>
                </div>
            </div>
        </div>
    </div>
</div>

{{ form_end(formcompte) }}
{% endblock %}

{% block javascripts %}
<style>
    .mirror { transform: scaleX(-1); }
    .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>
<script>
    let stream = null;
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const selfieInput = document.getElementById('{{ formcompte.selfie.vars.id }}');

    function toggleCaptureMode(mode) {
        const cameraBtn = document.getElementById('useCameraButton');
        const uploadBtn = document.getElementById('useUploadButton');
        const cameraContainer = document.getElementById('cameraContainer');
        const uploadSection = document.getElementById('uploadSection');
        const tips = document.getElementById('selfieTips');

        if (!cameraBtn || !uploadBtn || !cameraContainer || !uploadSection) return;

        if (mode === 'camera') {
            cameraBtn.classList.add('bg-green-600', 'text-white');
            cameraBtn.classList.remove('bg-white', 'text-green-600');
            uploadBtn.classList.remove('bg-green-600', 'text-white');
            uploadBtn.classList.add('bg-gray-100', 'text-gray-600');
            
            cameraContainer.classList.remove('hidden');
            uploadSection.classList.add('hidden');
            startCamera();
        } else {
            uploadBtn.classList.add('bg-green-600', 'text-white');
            uploadBtn.classList.remove('bg-gray-100', 'text-gray-600');
            cameraBtn.classList.remove('bg-green-600', 'text-white');
            cameraBtn.classList.add('bg-white', 'text-green-600');
            
            uploadSection.classList.remove('hidden');
            cameraContainer.classList.add('hidden');
            stopCamera();
        }
        
        const preview = document.getElementById('confirmedSelfiePreview');
        if (preview) preview.classList.add('hidden');
        if (tips) tips.classList.remove('hidden');
    }

    async function startCamera() {
        if (!video) return;
        
        const errorUI = document.getElementById('cameraErrorUI');
        const errorMessage = document.getElementById('cameraErrorMessage');
        const instructions = document.getElementById('permissionInstructions');
        const overlay = document.getElementById('cameraOverlay');
        
        if (errorUI) errorUI.classList.add('hidden');
        if (instructions) instructions.classList.add('hidden');
        if (overlay) overlay.classList.remove('hidden');

        // Check for secure context
        if (!window.isSecureContext) {
            showCameraError("L'accès à la caméra nécessite une connexion sécurisée (HTTPS). Veuillez vérifier votre barre d'adresse.");
            return;
        }

        try {
            stream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: "user",
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }, 
                audio: false 
            });
            video.srcObject = stream;
            video.onloadedmetadata = () => {
                video.play();
            };
        } catch (err) {
            console.error("Camera error:", err);
            let msg = "Impossible d'accéder à la caméra.";
            
            if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                msg = "L'accès à la caméra a été refusé. Veuillez autoriser les permissions dans votre navigateur.";
                if (instructions) instructions.classList.remove('hidden');
            } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
                msg = "Aucune caméra n'a été trouvée sur cet appareil.";
            } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
                msg = "La caméra est déjà utilisée par une autre application.";
            }
            
            showCameraError(msg);
        }
    }

    function showCameraError(message) {
        const errorUI = document.getElementById('cameraErrorUI');
        const errorMessage = document.getElementById('cameraErrorMessage');
        const overlay = document.getElementById('cameraOverlay');
        
        if (errorUI) errorUI.classList.remove('hidden');
        if (errorMessage) errorMessage.textContent = message;
        if (overlay) overlay.classList.add('hidden');
        
        // Stop any potential stream
        stopCamera();
    }

    function stopCamera() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
        }
    }

    function capturePhoto() {
        if (!video || !canvas || !selfieInput) return;
        const context = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        
        // Mirror the image back if the video was mirrored
        context.translate(canvas.width, 0);
        context.scale(-1, 1);
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        canvas.toBlob((blob) => {
            const file = new File([blob], "selfie.jpg", { type: "image/jpeg" });
            
            // Put the file in the hidden input using DataTransfer
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            selfieInput.files = dataTransfer.files;
            
            // Show preview
            const reader = new FileReader();
            reader.onload = (e) => {
                const previewImg = document.getElementById('confirmedSelfieImage');
                const previewDiv = document.getElementById('confirmedSelfiePreview');
                const camCont = document.getElementById('cameraContainer');
                const tips = document.getElementById('selfieTips');
                
                if (previewImg) previewImg.src = e.target.result;
                if (previewDiv) previewDiv.classList.remove('hidden');
                if (camCont) camCont.classList.add('hidden');
                if (tips) tips.classList.add('hidden');
                stopCamera();
            };
            reader.readAsDataURL(blob);
        }, 'image/jpeg', 0.9);
    }

    function resetSelfie() {
        if (selfieInput) selfieInput.value = '';
        const preview = document.getElementById('confirmedSelfiePreview');
        const tips = document.getElementById('selfieTips');
        if (preview) preview.classList.add('hidden');
        if (tips) tips.classList.remove('hidden');
        toggleCaptureMode('camera');
    }

    if (selfieInput) {
        selfieInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const previewImg = document.getElementById('confirmedSelfieImage');
                    const previewDiv = document.getElementById('confirmedSelfiePreview');
                    const uploadSec = document.getElementById('uploadSection');
                    const tips = document.getElementById('selfieTips');
                    
                    if (previewImg) previewImg.src = e.target.result;
                    if (previewDiv) previewDiv.classList.remove('hidden');
                    if (uploadSec) uploadSec.classList.add('hidden');
                    if (tips) tips.classList.add('hidden');
                };
                reader.readAsDataURL(this.files[0]);
            }
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        toggleCaptureMode('camera');
        
        const form = document.getElementById('verificationForm');
        if (form) {
            form.querySelectorAll('input, select').forEach(input => {
                input.addEventListener('change', updateProgress);
            });
        }
        updateProgress();
    });

    function updateProgress() {
        const inputs = Array.from(document.querySelectorAll('input[required], select[required]'));
        const filled = inputs.filter(i => i.value && i.value !== '').length;
        const percent = inputs.length > 0 ? Math.round((filled / inputs.length) * 100) : 0;
        
        const progressBar = document.getElementById('progressBar');
        const percentLabel = document.getElementById('progressPercentage');
        
        if (progressBar) progressBar.style.width = percent + '%';
        if (percentLabel) percentLabel.textContent = percent + '%';
    }

    function handleFileSelect(input, previewId) {
        const preview = document.getElementById(previewId);
        if (!preview) return;
        preview.innerHTML = '';
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                if (file.type.startsWith('image/')) {
                    preview.innerHTML = `<div class="bg-gray-100 rounded-lg p-2 transition-all animate-fadeIn"><img src="${e.target.result}" class="max-h-32 rounded mx-auto shadow-sm"><p class="text-xs text-center mt-2 text-gray-600 font-medium">${file.name}</p></div>`;
                } else {
                    preview.innerHTML = `<div class="bg-gray-100 rounded-lg p-4 text-center transition-all animate-fadeIn"><i class="fas fa-file-pdf text-3xl text-red-500 mb-2"></i><p class="text-xs font-semibold text-gray-600">${file.name}</p></div>`;
                }
                updateProgress();
            };
            reader.readAsDataURL(file);
        }
    }

    window.handleDrop = function(e, inputId, previewId) {
        e.preventDefault();
        const input = document.getElementById(inputId);
        const dropzone = e.currentTarget;
        if (dropzone) dropzone.classList.remove('dragover');
        if (input) {
            input.files = e.dataTransfer.files;
            handleFileSelect(input, previewId);
        }
    };
</script>
{% endblock %}