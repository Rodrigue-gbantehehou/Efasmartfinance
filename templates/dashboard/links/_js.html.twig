



<!-- Scripts JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    // Données globales
    let appData = {
        user: {},
        tontines: [],
        stats: {}
    };

    // Fonction pour charger les données
    async function loadTontines() {
        try {
            // Essayer d'abord les données embarquées dans Twig
            const dataElement = document.getElementById('appData');
            if (dataElement && dataElement.textContent) {
                appData = JSON.parse(dataElement.textContent);
                console.log('Données chargées depuis Twig:', appData);
                updateUI();
                return;
            }

            // Fallback à l'API
            const response = await fetch('/api/tontines', {
                headers: {
                    'Accept': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin'
            });
            
            if (!response.ok) {
                throw new Error(`Erreur HTTP: ${response.status}`);
            }
            
            const data = await response.json();
            appData = {
                user: data.user || {},
                tontines: data.tontines || [],
                stats: data.stats || {}
            };
            
            console.log('Données chargées depuis API:', appData);
            updateUI();
            
        } catch (error) {
            console.error('Erreur:', error);
            
            // Utiliser des données par défaut si tout échoue
            appData = {
                user: { firstName: 'Utilisateur', fullName: 'Utilisateur' },
                tontines: [],
                stats: {
                    totalBalance: 0,
                    activeTontines: 0,
                    completedTontines: 0,
                    totalTontines: 0,
                    upcomingPayments: 0,
                    monthlySavings: 0,
                    latePayments: 0,
                    lateAmount: 0
                }
            };
            
            updateUI();
            
            // Afficher un message d'erreur discret
            const errorMessage = document.createElement('div');
            errorMessage.className = 'bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4 rounded';
            errorMessage.innerHTML = `
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-yellow-700">
                            Les données sont chargées en mode hors ligne. Rechargez la page pour les données actualisées.
                        </p>
                    </div>
                </div>
            `;
            document.querySelector('main')?.prepend(errorMessage);
        }
    }

    // Fonction pour mettre à jour l'interface
    function updateUI() {
        updateUserInfo();
        updateStatistics();
        updateTontinesTable();
        updateUpcomingPayments();
        initCharts();
    }

    // Mettre à jour les informations utilisateur
    function updateUserInfo() {
        if (appData.user) {
            const fullName = appData.user.fullName || 
                            `${appData.user.firstName || ''} ${appData.user.lastName || ''}`.trim() || 
                            'Utilisateur';
            
            // Mettre à jour tous les éléments qui affichent le nom
            const nameElements = [
                'welcomeUserName',
                'userDisplayName',
                'userDisplayNameMobile'
            ];
            
            nameElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = fullName;
                }
            });
            
            // Mettre à jour le nom dans l'en-tête mobile si présent
            const mobileNameElement = document.querySelector('[id*="userName"]');
            if (mobileNameElement) {
                mobileNameElement.textContent = fullName;
            }
        }
    }

    // Mettre à jour les statistiques
    function updateStatistics() {
        const stats = appData.stats;
        
        // Solde total
        const totalBalanceEl = document.getElementById('totalBalance');
        if (totalBalanceEl) {
            totalBalanceEl.textContent = formatCurrency(stats.totalBalance || 0);
        }
        
        // Tontines actives
        const activeTontinesEl = document.getElementById('activeTontinesCount');
        if (activeTontinesEl) {
            activeTontinesEl.textContent = stats.activeTontines || 0;
        }
        
        // Tontines terminées
        const completedTontinesEl = document.getElementById('completedTontines');
        if (completedTontinesEl) {
            completedTontinesEl.textContent = stats.completedTontines || 0;
        }
        
        // Total tontines
        const totalTontinesEl = document.getElementById('totalTontines');
        if (totalTontinesEl) {
            totalTontinesEl.textContent = stats.totalTontines || (appData.tontines?.length || 0);
        }
        
        // Barre de progression des tontines actives
        const progressEl = document.getElementById('activeTontinesProgress');
        if (progressEl && stats.totalTontines && stats.completedTontines) {
            const progress = (stats.completedTontines / stats.totalTontines) * 100;
            progressEl.style.width = `${progress}%`;
        }
        
        // Épargne mensuelle (à calculer si non fourni)
        const monthlySavingsEl = document.getElementById('monthlySavings');
        if (monthlySavingsEl) {
            if (stats.monthlySavings !== undefined) {
                monthlySavingsEl.textContent = formatCurrency(stats.monthlySavings);
            } else {
                // Calculer approximativement si non fourni
                const monthlyAmount = appData.tontines?.reduce((sum, tontine) => {
                    if (tontine.status === 'active') {
                        if (tontine.period === 'monthly') return sum + tontine.amount;
                        if (tontine.period === 'weekly') return sum + (tontine.amount * 4);
                        if (tontine.period === 'daily') return sum + (tontine.amount * 30);
                    }
                    return sum;
                }, 0) || 0;
                monthlySavingsEl.textContent = formatCurrency(monthlyAmount);
            }
        }
        
        // Prochain paiement
        if (appData.tontines && appData.tontines.length > 0) {
            // Trier par date de paiement la plus proche
            const sortedTontines = [...appData.tontines].sort((a, b) => {
                return new Date(a.nextPayment) - new Date(b.nextPayment);
            });
            
            const nextTontine = sortedTontines[0];
            
            const nextPaymentAmountEl = document.getElementById('nextPaymentAmount');
            const nextPaymentDateEl = document.getElementById('nextPaymentDate');
            const nextPaymentTontineEl = document.getElementById('nextPaymentTontine');
            
            if (nextPaymentAmountEl) {
                nextPaymentAmountEl.textContent = formatCurrency(nextTontine.amount || 0);
            }
            
            if (nextPaymentDateEl) {
                nextPaymentDateEl.textContent = formatDate(nextTontine.nextPayment);
            }
            
            if (nextPaymentTontineEl) {
                nextPaymentTontineEl.textContent = nextTontine.name || 'Tontine';
            }
        }
        
        // Retards
        const latePaymentsCountEl = document.getElementById('latePaymentsCount');
        const latePaymentsAmountEl = document.getElementById('latePaymentsAmount');
        const latePaymentsProgressEl = document.getElementById('latePaymentsProgress');
        
        if (latePaymentsCountEl) {
            latePaymentsCountEl.textContent = stats.latePayments || 0;
        }
        
        if (latePaymentsAmountEl) {
            latePaymentsAmountEl.textContent = formatCurrency(stats.lateAmount || 0);
        }
        
        if (latePaymentsProgressEl && stats.upcomingPayments) {
            const progress = stats.latePayments ? 
                (stats.latePayments / stats.upcomingPayments) * 100 : 0;
            latePaymentsProgressEl.style.width = `${progress}%`;
        }
    }

    // Mettre à jour le tableau des tontines
    function updateTontinesTable() {
        const tbody = document.getElementById('tontinesTableBody');
        if (!tbody) return;
        
        if (!appData.tontines || appData.tontines.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="py-8 text-center text-gray-500">
                        <div class="flex flex-col items-center justify-center">
                            <i class="fas fa-inbox text-4xl text-gray-300 mb-2"></i>
                            <p class="mb-3">Aucune tontine trouvée</p>
                            <a href="{{ path('app_tontine') }}" 
                               class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-green-700 text-sm touch-target transition-colors">
                                Créer une tontine
                            </a>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }
        
        // Vider et remplir le tableau
        tbody.innerHTML = '';
        
        appData.tontines.forEach(tontine => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50 transition-colors';
            
            // Formater la périodicité
            const periodMap = {
                'daily': 'Quotidien',
                'weekly': 'Hebdomadaire', 
                'monthly': 'Mensuel',
                'email': 'Par email' // Adapté à vos données
            };
            const periodText = periodMap[tontine.period] || tontine.period;
            
            // Statut avec badge coloré
            const statusBadge = tontine.status === 'active' ? 
                '<span class="px-2 py-1 text-xs rounded-full bg-emerald-50 text-emerald-700 whitespace-nowrap">Active</span>' :
                '<span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-700 whitespace-nowrap">Terminée</span>';
            
            // Calculer les jours jusqu'au prochain paiement
            const daysUntilPayment = daysUntil(tontine.nextPayment);
            const isLate = daysUntilPayment < 0;
            
            row.innerHTML = `
                <td class="py-3 px-2">
                    <div class="font-medium text-gray-900 text-sm truncate max-w-[120px]" title="${tontine.name}">
                        ${tontine.name}
                    </div>
                    <div class="text-xs text-gray-500 sm:hidden">${periodText}</div>
                </td>
                <td class="py-3 px-2 hidden sm:table-cell whitespace-nowrap">
                    ${periodText}
                </td>
                <td class="py-3 px-2 font-semibold text-gray-900 whitespace-nowrap">
                    ${formatCurrency(tontine.amount)}
                </td>
                <td class="py-3 px-2 hidden md:table-cell">
                    <div class="font-medium ${isLate ? 'text-danger' : 'text-gray-900'} whitespace-nowrap">
                        ${formatDate(tontine.nextPayment)}
                    </div>
                    <div class="text-xs ${isLate ? 'text-danger' : 'text-gray-500'}">
                        ${isLate ? `En retard de ${Math.abs(daysUntilPayment)} jours` : `Dans ${daysUntilPayment} jours`}
                    </div>
                </td>
                <td class="py-3 px-2">
                    <div class="flex items-center gap-1 min-w-[80px]">
                        <div class="flex-1 h-2 bg-gray-100 rounded-full overflow-hidden">
                            <div class="h-full bg-primary rounded-full" style="width: ${tontine.progress || 0}%"></div>
                        </div>
                        <span class="text-xs font-medium whitespace-nowrap">${tontine.progress || 0}%</span>
                    </div>
                    <div class="text-xs text-gray-500 md:hidden mt-1">
                        ${formatDate(tontine.nextPayment)}
                    </div>
                </td>
                <td class="py-3 px-2">
                    ${statusBadge}
                </td>
                <td class="py-3 px-2">
                    <div class="flex items-center gap-1">
                        <button onclick="viewTontine(${tontine.id})" 
                                class="p-1 hover:bg-gray-100 rounded touch-target transition-colors" 
                                title="Voir les détails">
                            <i class="fa-solid fa-eye text-gray-600 text-sm"></i>
                        </button>
                        <button onclick="payTontine(${tontine.id})" 
                                class="p-1 hover:bg-gray-100 rounded touch-target transition-colors" 
                                title="Effectuer un paiement">
                            <i class="fa-solid fa-credit-card text-primary text-sm"></i>
                        </button>
                    </div>
                </td>
            `;
            
            tbody.appendChild(row);
        });
    }

    // Mettre à jour les échéances à venir
    function updateUpcomingPayments() {
        const container = document.getElementById('upcomingPayments');
        if (!container) return;
        
        if (!appData.tontines || appData.tontines.length === 0) {
            return; // Garder le message par défaut
        }
        
        // Filtrer et trier les échéances
        const upcoming = appData.tontines
            .filter(tontine => tontine.status === 'active')
            .sort((a, b) => new Date(a.nextPayment) - new Date(b.nextPayment))
            .slice(0, 4);
        
        if (upcoming.length === 0) {
            container.innerHTML = `
                <div class="col-span-full bg-gray-50 rounded-lg p-6 border border-gray-200 text-center">
                    <i class="fa-solid fa-calendar-check text-3xl text-gray-300 mb-3 block"></i>
                    <p class="text-gray-500">Aucune échéance à venir</p>
                    <p class="text-sm text-gray-400 mt-1">Tout est à jour</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = '';
        
        upcoming.forEach(tontine => {
            const days = daysUntil(tontine.nextPayment);
            const isUrgent = days <= 3;
            const isLate = days < 0;
            
            const card = document.createElement('div');
            card.className = `border rounded-xl p-4 hover:shadow-sm transition-shadow ${
                isLate ? 'border-danger' : isUrgent ? 'border-warning' : 'border-gray-200'
            }`;
            
            card.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <div class="min-w-0 flex-1">
                        <div class="font-semibold text-gray-900 text-sm truncate" title="${tontine.name}">
                            ${tontine.name}
                        </div>
                        <div class="text-xs text-gray-500 mt-1">
                            ${formatDate(tontine.nextPayment)}
                        </div>
                    </div>
                    ${isLate ? 
                        '<span class="px-2 py-1 text-xs rounded-full bg-danger/10 text-danger flex-shrink-0 ml-2">En retard</span>' : 
                      isUrgent ? 
                        '<span class="px-2 py-1 text-xs rounded-full bg-warning/10 text-warning flex-shrink-0 ml-2">Urgent</span>' : 
                        ''
                    }
                </div>
                <div class="text-lg font-bold text-primary mb-3 truncate">
                    ${formatCurrency(tontine.amount)}
                </div>
                <div class="flex justify-between items-center">
                    <div class="text-sm">
                        <span class="text-gray-600">${isLate ? 'Retard de' : 'Dans'}</span>
                        <span class="font-bold ml-1 ${isLate ? 'text-danger' : 'text-gray-900'}">
                            ${Math.abs(days)} jour${Math.abs(days) > 1 ? 's' : ''}
                        </span>
                    </div>
                    <button onclick="payTontine(${tontine.id})" 
                            class="px-3 py-1.5 text-sm bg-primary text-white rounded-lg hover:bg-green-700 
                                   touch-target whitespace-nowrap transition-colors ${isLate ? 'bg-danger hover:bg-red-700' : ''}">
                        ${isLate ? 'Régulariser' : 'Payer'}
                    </button>
                </div>
            `;
            
            container.appendChild(card);
        });
    }

    // Initialiser les graphiques
    function initCharts() {
        const ctx = document.getElementById('savingsChart');
        if (!ctx) return;
        
        // Données basées sur vos tontines
        const savingsData = calculateSavingsData();
        
        try {
            new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Jun'],
                    datasets: [{
                        label: 'Épargne cumulée',
                        data: savingsData,
                        borderWidth: 2,
                        borderColor: '#10B981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 3,
                        pointHoverRadius: 5,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => `Épargne: ${formatCurrency(context.raw)}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: (value) => {
                                    if (value >= 1000000) return (value/1000000).toFixed(1) + 'M';
                                    if (value >= 1000) return (value/1000).toFixed(0) + 'k';
                                    return value;
                                }
                            }
                        }
                    }
                }
            });
        } catch (error) {
            console.error('Erreur d\'initialisation du graphique:', error);
        }
    }
    
    function calculateSavingsData() {
        // Calculer des données de démonstration basées sur vos tontines
        const total = appData.stats.totalBalance || 0;
        return [
            0,
            total * 0.2,
            total * 0.4,
            total * 0.6,
            total * 0.8,
            total
        ];
    }

    // Fonctions utilitaires
    function formatCurrency(amount) {
        return new Intl.NumberFormat('fr-FR').format(amount) + ' FCFA';
    }
    
    function formatDate(dateString) {
        try {
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        } catch (e) {
            return '--/--/----';
        }
    }
    
    function daysUntil(dateString) {
        try {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const targetDate = new Date(dateString);
            targetDate.setHours(0, 0, 0, 0);
            const diffTime = targetDate - today;
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        } catch (e) {
            return 0;
        }
    }

    // Fonctions d'action
    function viewTontine(id) {
        // Redirection vers la page de détail
        window.location.href = `/tontine/${id}`;
    }
    
    function payTontine(id) {
        // Ouvrir modal ou rediriger vers paiement
        const tontine = appData.tontines.find(t => t.id === id);
        if (tontine) {
            alert(`Paiement de ${formatCurrency(tontine.amount)} pour "${tontine.name}"`);
            // window.location.href = `/paiement/${id}`;
        }
    }

    // Initialisation
    document.addEventListener('DOMContentLoaded', function() {
        // Année courante
        const currentYear = new Date().getFullYear();
        document.getElementById('currentYear').textContent = currentYear;
        
        // Charger les données
        loadTontines();
        
        // Initialiser les menus
        initUserMenu();
    });
    
    function initUserMenu() {
        const menuButton = document.getElementById('userMenuButton');
        const menu = document.getElementById('userMenu');
        
        if (menuButton && menu) {
            menuButton.addEventListener('click', (e) => {
                e.stopPropagation();
                menu.classList.toggle('hidden');
            });
            
            document.addEventListener('click', () => menu.classList.add('hidden'));
            menu.addEventListener('click', (e) => e.stopPropagation());
        }
    }
    
    // Exposer les fonctions globalement
    window.viewTontine = viewTontine;
    window.payTontine = payTontine;
</script>
