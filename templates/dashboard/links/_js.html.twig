<!-- Scripts JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="{{ asset('assets/js/settings.js') }}" defer></script>
<script src="{{ asset('assets/js/settingsprofile.js') }}" defer></script>
<script src="{{ asset('assets/js/settingsecurite.js') }}" defer></script>
<script src="{{ asset('assets/js/notifications.js') }}" defer></script>

<script>
    // Donn√©es globales
    let appData = {
        user: {},
        tontines: [],
        stats: {}
    };

    // Fonction pour charger les donn√©es
    async function loadTontines() {
        try {
            // Essayer d'abord les donn√©es embarqu√©es dans Twig
            const dataElement = document.getElementById('appData');
            if (dataElement && dataElement.textContent) {
                appData = JSON.parse(dataElement.textContent);
                console.log('Donn√©es charg√©es depuis Twig:', appData);
                updateUI();
                return;
            }

            // Fallback √† l'API
            const response = await fetch('/api/tontines', {
                headers: {
                    'Accept': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin'
            });

            if (!response.ok) {
                throw new Error(`Erreur HTTP: ${response.status}`);
            }

            const data = await response.json();
            appData = {
                user: data.user || {},
                tontines: Array.isArray(data.tontines) ? data.tontines : Object.values(data.tontines || {}),
                stats: data.stats || {}
            };

           // console.log('Donn√©es charg√©es depuis API:', appData);
            updateUI();

        } catch (error) {
            console.error('Erreur:', error);

            // Utiliser des donn√©es par d√©faut si tout √©choue
            appData = {
                user: { firstName: 'Utilisateur', fullName: 'Utilisateur' },
                tontines: [],
                stats: {
                    totalBalance: 0,
                    activeTontines: 0,
                    completedTontines: 0,
                    totalTontines: 0,
                    upcomingPayments: 0,
                    monthlySavings: 0,
                    latePayments: 0,
                    lateAmount: 0
                }
            };

            updateUI();

            // Afficher un message d'erreur discret
            const errorMessage = document.createElement('div');
            errorMessage.className = 'bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4 rounded';
            errorMessage.innerHTML = `
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-yellow-600">
                            Les donn√©es sont charg√©es en mode hors ligne. Rechargez la page pour les donn√©es actualis√©es.
                        </p>
                    </div>
                </div>
            `;
            document.querySelector('main')?.prepend(errorMessage);
        }
    }

    // Fonction pour mettre √† jour l'interface
    function updateUI() {
        updateUserInfo();
        updateStatistics();
        updateTontinesTable();
        // updateUpcomingPayments();
        initCharts();
    }

    // Mettre √† jour les informations utilisateur
    function updateUserInfo() {
        if (appData.user) {
            const fullName = appData.user.fullName ||
                `${appData.user.firstName || ''} ${appData.user.lastName || ''}`.trim() ||
                'Utilisateur';

            // Mettre √† jour tous les √©l√©ments qui affichent le nom
            const nameElements = [
                'welcomeUserName',
                'userDisplayName',
                'userDisplayNameMobile'
            ];

            nameElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = fullName;
                }
            });

            // Mettre √† jour le nom dans l'en-t√™te mobile si pr√©sent
            const mobileNameElement = document.querySelector('[id*="userName"]');
            if (mobileNameElement) {
                mobileNameElement.textContent = fullName;
            }
        }
    }

    // Mettre √† jour les statistiques
    function updateStatistics() {
        const stats = appData.stats;

        // Solde total
        const totalBalanceEl = document.getElementById('totalBalance');
        if (totalBalanceEl) {
            totalBalanceEl.textContent = formatCurrency(stats.totalBalance || 0);
        }

        // Tontines actives
        const activeTontinesEl = document.getElementById('activeTontinesCount');
        if (activeTontinesEl) {
            activeTontinesEl.textContent = stats.activeTontines || 0;
        }

        // Tontines termin√©es
        const completedTontinesEl = document.getElementById('completedTontines');
        if (completedTontinesEl) {
            completedTontinesEl.textContent = stats.completedTontines || 0;
        }

        // Total tontines
        const totalTontinesEl = document.getElementById('totalTontines');
        if (totalTontinesEl) {
            totalTontinesEl.textContent = stats.totalTontines || (appData.tontines?.length || 0);
        }

        // Barre de progression des tontines actives
        const progressEl = document.getElementById('activeTontinesProgress');
        if (progressEl && stats.totalTontines && stats.completedTontines) {
            const progress = (stats.completedTontines / stats.totalTontines) * 100;
            progressEl.style.width = `${progress}%`;
        }

        // √âpargne mensuelle (√† calculer si non fourni)
        const monthlySavingsEl = document.getElementById('monthlySavings');
        if (monthlySavingsEl) {
            if (stats.monthlySavings !== undefined) {
                monthlySavingsEl.textContent = formatCurrency(stats.monthlySavings);
            } else {
                // Calculer approximativement si non fourni
                const monthlyAmount = appData.tontines?.reduce((sum, tontine) => {
                    if (tontine.status === 'active') {
                        if (tontine.period === 'monthly') return sum + tontine.amount;
                        if (tontine.period === 'weekly') return sum + (tontine.amount * 4);
                        if (tontine.period === 'daily') return sum + (tontine.amount * 30);
                    }
                    return sum;
                }, 0) || 0;
                monthlySavingsEl.textContent = formatCurrency(monthlyAmount);
            }
        }

        // Prochain paiement
        if (appData.tontines && appData.tontines.length > 0) {
            // Trier par date de paiement la plus proche
            const sortedTontines = [...appData.tontines].sort((a, b) => {
                return new Date(a.nextPayment) - new Date(b.nextPayment);
            });

            const nextTontine = sortedTontines[0];

            const nextPaymentAmountEl = document.getElementById('nextPaymentAmount');
            const nextPaymentDateEl = document.getElementById('nextPaymentDate');
            const nextPaymentTontineEl = document.getElementById('nextPaymentTontine');

            if (nextPaymentAmountEl) {
                nextPaymentAmountEl.textContent = formatCurrency(nextTontine.amount || 0);
            }

            if (nextPaymentDateEl) {
                nextPaymentDateEl.textContent = formatDate(nextTontine.nextPayment);
            }

            if (nextPaymentTontineEl) {
                nextPaymentTontineEl.textContent = nextTontine.name || 'Tontine';
            }
        }

        // Retards
        const latePaymentsCountEl = document.getElementById('latePaymentsCount');
        const latePaymentsAmountEl = document.getElementById('latePaymentsAmount');
        const latePaymentsProgressEl = document.getElementById('latePaymentsProgress');

        if (latePaymentsCountEl) {
            latePaymentsCountEl.textContent = stats.latePayments || 0;
        }

        if (latePaymentsAmountEl) {
            latePaymentsAmountEl.textContent = formatCurrency(stats.lateAmount || 0);
        }

        if (latePaymentsProgressEl && stats.upcomingPayments) {
            const progress = stats.latePayments ?
                (stats.latePayments / stats.upcomingPayments) * 100 : 0;
            latePaymentsProgressEl.style.width = `${progress}%`;
        }
    }

    // Mettre √† jour le tableau des tontines
    function updateTontinesTable() {
        const tbody = document.getElementById('tontinesTableBody');
        if (!tbody) return;

        if (!appData.tontines || appData.tontines.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="py-8 text-center text-gray-600">
                        <div class="flex flex-col items-center justify-center">
                            <i class="fas fa-inbox text-4xl text-gray-300 mb-2"></i>
                            <p class="mb-3">Aucune tontine trouv√©e</p>
                            <a href="{{ path('app_tontine') }}" 
                               class="px-4 py-2 bg-green-700 text-white rounded-lg hover:bg-green-700 text-sm touch-target transition-colors">
                                Cr√©er une tontine
                            </a>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }

        // Vider et remplir le tableau
        tbody.innerHTML = '';

        appData.tontines.forEach((tontine, index) => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50 transition-colors';

            // Num√©ro de ligne (commence √† 1)
            const numeroLigne = index + 1;

            // Formater la p√©riodicit√©
            const periodMap = {
                'daily': 'Quotidien',
                'weekly': 'Hebdomadaire',
                'monthly': 'Mensuel',
                'email': 'Par email' // Adapt√© √† vos donn√©es
            };
            const periodText = periodMap[tontine.period] || tontine.period;

            // Statut avec badge color√©
            const statusBadge = tontine.status === 'active' ?
                '<span class="px-2 py-1 text-xs rounded-full bg-emerald-50 text-emerald-700 whitespace-nowrap">Active</span>' :
                '<span class="px-2 py-1 text-xs rounded-full bg-yellow-50 text-yellow-600 whitespace-nowrap">Cl√¥tur√©e</span>';

            // Calculer les jours jusqu'au prochain paiement
            const daysUntilPayment = daysUntil(tontine.nextPayment);
            const isLate = daysUntilPayment < 0;

            row.innerHTML = `
        <td class="py-3 px-2">
             <div class="font-medium text-gray-600 text-sm">
        ${index + 1}
    </div>
        </td>
        <td class="py-3 px-2">
            <div class="flex items-center gap-2">
                <div class="font-medium text-gray-900 text-sm truncate max-w-[120px]" title="${tontine.name}">
                    ${tontine.name} 
                </div>
                ${tontine.status !== 'active' ? '<i class="fa-solid fa-lock text-xs text-yellow-500"></i>' : ''}
            </div>
            <div class="text-xs text-gray-600 sm:hidden">${periodText}</div>
        </td>
        <td class="py-3 px-2 hidden sm:table-cell whitespace-nowrap">
            ${tontine.status === 'active' ? periodText : 'Termin√©e'}
        </td>
        <td class="py-3 px-2 font-semibold text-gray-900 whitespace-nowrap">
            ${formatCurrency(tontine.amount)}
        </td>
        <td class="py-3 px-2 hidden md:table-cell">
    ${tontine.status === 'completed' ?
                    '<div class="text-sm text-gray-600">Termin√©e</div>' :
                    `<div class="font-medium ${isLate ? 'text-danger' : 'text-gray-900'} whitespace-nowrap">
            ${formatDate(tontine.nextPayment)}
        </div>
        <div class="text-xs ${isLate ? 'text-danger' : 'text-gray-600'}">
            ${isLate ? `En retard de ${Math.abs(daysUntilPayment)} jours` : `Dans ${daysUntilPayment} jours`}
        </div>`}
</td>
        <td class="py-3 px-2">
            <div class="flex items-center gap-1 min-w-[80px]">
                <div class="flex-1 h-2 bg-gray-100 rounded-full overflow-hidden">
                    <div class="h-full bg-green-700 rounded-full" style="width: ${tontine.progress || 0}%"></div>
                </div>
                <span class="text-xs font-medium whitespace-nowrap">${tontine.progress || 0}%</span>
            </div>
            <div class="text-xs text-gray-600 md:hidden mt-1">
                ${formatDate(tontine.nextPayment)}
            </div>
        </td>
        <td class="py-3 px-2">
            ${statusBadge}
        </td>
       <td class="py-3 px-2">
        <div class="flex items-center gap-1">
            <button onclick="viewTontine(${tontine.id})" 
                    class="p-1 hover:bg-gray-100 rounded touch-target transition-colors" 
                    title="Voir les d√©tails">
                <i class="fa-solid fa-eye text-gray-600 text-sm"></i>
            </button>
            ${tontine.status === 'active' ? `
            <button onclick="payTontine(${tontine.id})" 
                    class="p-1 hover:bg-gray-100 rounded touch-target transition-colors" 
                    title="Effectuer un paiement">
                <i class="fa-solid fa-credit-card text-green-700 text-sm"></i>
            </button>
            ` : ''}
        </div>
    </td>
    `;

            tbody.appendChild(row);
        });
    }

    // Mettre √† jour les √©ch√©ances √† venir
    function updateUpcomingPayments() {
        const container = document.getElementById('upcomingPayments');
        if (!container) return;

        if (!appData.tontines || appData.tontines.length === 0) {
            return; // Garder le message par d√©faut
        }

        // Filtrer et trier les √©ch√©ances
        const upcoming = appData.tontines
            .filter(tontine => tontine.status === 'active')
            .sort((a, b) => new Date(a.nextPayment) - new Date(b.nextPayment))
            .slice(0, 4);

        if (upcoming.length === 0) {
            container.innerHTML = `
                <div class="col-span-full bg-gray-50 rounded-lg p-6 border border-gray-200 text-center">
                    <i class="fa-solid fa-calendar-check text-3xl text-gray-300 mb-3 block"></i>
                    <p class="text-gray-600">Aucune √©ch√©ance √† venir</p>
                    <p class="text-sm text-gray-600 mt-1">Tout est √† jour</p>
                </div>
            `;
            return;
        }

        container.innerHTML = '';

        upcoming.forEach(tontine => {
            const days = daysUntil(tontine.nextPayment);
            const isUrgent = days <= 3;
            const isLate = days < 0;

            const card = document.createElement('div');
            card.className = `border rounded-xl p-4 hover:shadow-sm transition-shadow ${isLate ? 'border-danger' : isUrgent ? 'border-warning' : 'border-gray-200'
                }`;

            card.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <div class="min-w-0 flex-1">
                        <div class="font-semibold text-gray-900 text-sm truncate" title="${tontine.name}">
                            ${tontine.name}
                        </div>
                        <div class="text-xs text-gray-600 mt-1">
                            ${formatDate(tontine.nextPayment)}
                        </div>
                    </div>
                    ${isLate ?
                    '<span class="px-2 py-1 text-xs rounded-full bg-danger/10 text-danger flex-shrink-0 ml-2">En retard</span>' :
                    isUrgent ?
                        '<span class="px-2 py-1 text-xs rounded-full bg-warning/10 text-warning flex-shrink-0 ml-2">Urgent</span>' :
                        ''
                }
                </div>
                <div class="text-xs text-gray-600 mt-1">
                    Total restant √† payer
                </div>
                <div class="text-lg font-bold text-green-700 mb-3 truncate">
                    ${formatCurrency(tontine.amount)}
                </div>
                <div class="flex justify-between items-center">
                    <div class="text-sm">
                        <span class="text-gray-600">${isLate ? 'Retard de' : 'Dans'}</span>
                        <span class="font-bold ml-1 ${isLate ? 'text-danger' : 'text-gray-900'}">
                            ${Math.abs(days)} jour${Math.abs(days) > 1 ? 's' : ''}
                        </span>
                    </div>
                    <button onclick="payTontine(${tontine.id})" 
                            class="px-3 py-1.5 text-sm bg-green-700 text-white rounded-lg hover:bg-green-700 
                                   touch-target whitespace-nowrap transition-colors ${isLate ? 'bg-danger hover:bg-red-700' : ''}">
                        ${isLate ? 'R√©gulariser' : 'Payer'}
                    </button>
                </div>
            `;

            container.appendChild(card);
        });
    }

    // Initialiser les graphiques
    function initCharts() {
        const ctx = document.getElementById('savingsChart');
        if (!ctx) return;

        // Donn√©es bas√©es sur vos tontines
        const savingsData = calculateSavingsData();

        try {
            new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Jun'],
                    datasets: [{
                        label: '√âpargne cumul√©e',
                        data: savingsData,
                        borderWidth: 2,
                        borderColor: '#008040',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 3,
                        pointHoverRadius: 5,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => `√âpargne: ${formatCurrency(context.raw)}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: (value) => {
                                    if (value >= 1000000) return (value / 1000000).toFixed(1) + 'M';
                                    if (value >= 1000) return (value / 1000).toFixed(0) + 'k';
                                    return value;
                                }
                            }
                        }
                    }
                }
            });
        } catch (error) {
            console.error('Erreur d\'initialisation du graphique:', error);
        }
    }

    function calculateSavingsData() {
        // Calculer des donn√©es de d√©monstration bas√©es sur vos tontines
        const total = appData.stats.totalBalance || 0;
        return [
            0,
            total * 0.2,
            total * 0.4,
            total * 0.6,
            total * 0.8,
            total
        ];
    }

    // Fonctions utilitaires
    function formatCurrency(amount) {
        return new Intl.NumberFormat('fr-FR').format(amount);
    }

    function formatDate(dateString) {
        try {
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        } catch (e) {
            return '--/--/----';
        }
    }

    function daysUntil(dateString) {
        try {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const targetDate = new Date(dateString);
            targetDate.setHours(0, 0, 0, 0);
            const diffTime = targetDate - today;
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        } catch (e) {
            return 0;
        }
    }

    // Fonctions d'action
    function viewTontine(id) {
        // Redirection vers la page de d√©tail
        window.location.href = `/dashboard/tontines/${id}`;
    }

    function payTontine(id) {
        // Redirection directe si on a l'ID (plus robuste)
        if (id) {
            window.location.href = `/dashboard/tontine/payment/${id}`;
            return;
        }

        // Fallback sur la recherche dans appData si pas d'ID direct
        const tontines = Array.isArray(appData.tontines) ? appData.tontines : Object.values(appData.tontines || {});
        const tontine = tontines.find(t => t.id === id);
        if (tontine) {
            window.location.href = `/dashboard/tontine/payment/${id}`;
        }
    }

    // Initialisation
    document.addEventListener('DOMContentLoaded', function () {
        // Ann√©e courante
        const currentYear = new Date().getFullYear();
        const currentYearEl = document.getElementById('currentYear');
        if (currentYearEl) {
            currentYearEl.textContent = currentYear;
        }

        // Charger les donn√©es
        loadTontines();

        // Initialiser les menus
        initUserMenu();
    });

    function initUserMenu() {
        const menuButton = document.getElementById('userMenuButton');
        const menu = document.getElementById('userMenu');

        if (menuButton && menu) {
            menuButton.addEventListener('click', (e) => {
                e.stopPropagation();
                menu.classList.toggle('hidden');
            });

            document.addEventListener('click', () => menu.classList.add('hidden'));
            menu.addEventListener('click', (e) => e.stopPropagation());
        }
    }

    // Exposer les fonctions globalement
    window.viewTontine = viewTontine;
    window.payTontine = payTontine;

    // Gestion du menu utilisateur
    const userMenuButton = document.getElementById('userMenuButton');
    const userMenu = document.getElementById('userMenu');

    if (userMenuButton && userMenu) {
        // Afficher/cacher le menu au clic
        userMenuButton.addEventListener('click', (e) => {
            e.stopPropagation();
            userMenu.classList.toggle('hidden');
        });

        // Fermer le menu quand on clique en dehors
        document.addEventListener('click', (e) => {
            if (!userMenu.contains(e.target) && e.target !== userMenuButton) {
                userMenu.classList.add('hidden');
            }
        });

        // Emp√™cher la fermeture quand on clique dans le menu
        userMenu.addEventListener('click', (e) => {
            e.stopPropagation();
        });
    }


</script>

<script>
    // Fonction pour afficher la modale de confirmation
    function showWithdrawalModal(totalAPayer) {
        const modal = document.createElement('div');
        modal.id = 'withdrawalModal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
        modal.innerHTML = `
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-md transform transition-all">
                <div class="p-6">
                    <div class="text-center">
                        <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-yellow-100 mb-4">
                            <i class="fas fa-exclamation-circle text-yellow-600 text-2xl"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-900 mb-2">Confirmer le retrait</h3>
                        <p class="text-gray-600 mb-6">
                            √ätes-vous s√ªr de vouloir effectuer un retrait de fonds ?
                        </p>
                        <div class="bg-gray-50 p-4 rounded-lg mb-6 text-left">
                            <p class="text-sm text-gray-600 mb-1">Montant √† retirer :</p>
                            <p class="text-xl font-bold text-gray-900">${new Intl.NumberFormat('fr-FR').format(totalAPayer)} F CFA</p>
                            <p class="text-sm text-gray-600 mt-2">
                                <i class="fas fa-info-circle mr-1"></i>
                                Le traitement prendra 24 √† 48 heures.
                            </p>
                        </div>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-3 mt-6">
                        <button type="button" onclick="closeWithdrawalModal()" class="px-4 py-2.5 border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50 transition-colors flex-1">
                            Annuler
                        </button>
                        <button type="button" onclick="submitWithdrawal()" class="px-4 py-2.5 bg-yellow-600 text-white rounded-lg font-medium hover:bg-yellow-600 transition-colors flex-1">
                            <i class="fas fa-check-circle mr-2"></i>
                            Confirmer
                        </button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        document.body.style.overflow = 'hidden';
    }

    // Fonction pour fermer la modale
    function closeWithdrawalModal() {
        const modal = document.getElementById('withdrawalModal');
        if (modal) {
            modal.remove();
            document.body.style.overflow = '';
        }
    }

    // Fonction pour soumettre le formulaire
    function submitWithdrawal() {
        const tontineId = '{{ getCurrentTontine() ? getCurrentTontine().id : '' }}';
        if (!tontineId) {
            console.error('No tontine found');
            return false;
        }

        // Rediriger vers la page de demande de retrait au lieu de soumettre directement
        window.location.href = '{{ path("app_withdrawal_request", {"id": "PLACEHOLDER"}) }}'.replace('PLACEHOLDER', tontineId);
        return false;

    // Ancien code de soumission de formulaire conserv√© en commentaire pour r√©f√©rence
        /*
        const form = document.createElement('form');
        form.method = 'GET';
        form.action = '{{ path("app_withdrawal_request", {"id": "PLACEHOLDER"}) }}'.replace('PLACEHOLDER', tontineId);
        
        // Add CSRF token if available
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = '_token';
            csrfInput.value = csrfToken;
            form.appendChild(csrfInput);
        }
        
        // Submit the form
        document.body.appendChild(form);
        form.submit();
        */
    }

    // Fonction d'origine qui ouvre la modale
    function requestWithdrawal(totalAPayer) {
        showWithdrawalModal(totalAPayer);
    }
</script>


<script>
			// Fonction pour t√©l√©charger la carte
function downloadCard() { // Vous pouvez utiliser html2canvas pour g√©n√©rer une image de la carte
alert("Fonctionnalit√© de t√©l√©chargement √† impl√©menter avec html2canvas.js");

// Exemple d'impl√©mentation avec html2canvas:
/*
            const card = document.querySelector('.membership-card');
            const tontineCode = '{{ getCurrentTontine() ? getCurrentTontine().tontineCode : 'tontine' }}';
            html2canvas(card).then(canvas => {
                const link = document.createElement('a');
                link.download = 'carte-tontine-' + tontineCode + '.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
            */
    }

    // Fonction pour afficher les infos d'un point ou payer via une modale
    function showPointInfo(pointNumber) {
        {% set currentT = getCurrentTontine() %}
        const currentTontine = {{ currentT ? {
            id: currentT.id,
            name: currentT.name,
            startDate: currentT.startDate ? currentT.startDate|date('Y-m-d') : null,
            frequency: currentT.frequency,
            amountPerPoint: currentT.amountPerPoint|default(0),
            paidPoints: currentT.paidPoints|default(0)
        } | json_encode | raw : 'null' }};

        if (!currentTontine) {
            console.error('Aucune tontine trouv√©e');
            return;
        }

        const paidPoints = currentTontine.paidPoints || 0;
        const isPaid = pointNumber <= paidPoints;
        
        const tontineData = {
            startDate: new Date(currentTontine.startDate || new Date().toISOString()),
            frequency: currentTontine.frequency || 'monthly',
            amountPerPoint: currentTontine.amountPerPoint || 0
        };

        // Calcul de la date d'√©ch√©ance du point
        const interval = tontineData.frequency === 'monthly' ? 'months' : tontineData.frequency === 'weekly' ? 'weeks' : 'days';
        const dueDate = new Date(tontineData.startDate);
        if (interval === 'months') {
            dueDate.setMonth(dueDate.getMonth() + (pointNumber - 1));
        } else if (interval === 'weeks') {
            dueDate.setDate(dueDate.getDate() + ((pointNumber - 1) * 7));
        } else {
            dueDate.setDate(dueDate.getDate() + (pointNumber - 1));
        }

        const amount = tontineData.amountPerPoint.toLocaleString('fr-FR');
        const formattedDate = dueDate.toLocaleDateString('fr-FR');
        
        // Cr√©ation de la modale
        const modalId = 'pointInfoModal';
        let existingModal = document.getElementById(modalId);
        if (existingModal) existingModal.remove();

        const modal = document.createElement('div');
        modal.id = modalId;
        modal.className = 'fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-in fade-in duration-300';
        
        const statusColor = isPaid ? 'emerald' : (pointNumber === paidPoints + 1 ? 'yellow' : 'slate');
        const statusIcon = isPaid ? 'fa-check-double' : (pointNumber === paidPoints + 1 ? 'fa-bolt-lightning' : 'fa-calendar');
        const statusText = isPaid ? '‚úÖ Pay√©' : (pointNumber === paidPoints + 1 ? '‚è≥ √Ä payer' : 'üìÖ √Ä venir');

        modal.innerHTML = `
            <div class="bg-white rounded-[2rem] shadow-2xl w-full max-w-sm overflow-hidden transform transition-all animate-in zoom-in-95 duration-300">
                <div class="bg-${statusColor}-600 p-6 text-white text-center relative overflow-hidden">
                    <div class="absolute -right-4 -top-4 opacity-10 rotate-12 scale-150">
                        <i class="fas ${statusIcon} text-8xl"></i>
                    </div>
                    <div class="relative z-10 text-xs font-bold uppercase tracking-widest opacity-80 mb-1">D√©tails du point</div>
                    <div class="relative z-10 text-3xl font-black italic">#${pointNumber}</div>
                </div>
                
                <div class="p-8 space-y-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <span class="text-[10px] font-black text-slate-400 uppercase tracking-wider">Montant</span>
                            <div class="text-lg font-black text-slate-800">${amount} F</div>
                        </div>
                        <div class="space-y-1">
                            <span class="text-[10px] font-black text-slate-400 uppercase tracking-wider">√âch√©ance</span>
                            <div class="text-lg font-black text-slate-800">${formattedDate}</div>
                        </div>
                    </div>
                    
                    <div class="bg-slate-50 rounded-2xl p-4 border border-slate-100 flex items-center gap-4">
                        <div class="h-10 w-10 rounded-xl bg-white shadow-sm flex items-center justify-center text-${statusColor}-600">
                            <i class="fas ${statusIcon}"></i>
                        </div>
                        <div>
                            <span class="text-[10px] font-black text-slate-400 uppercase tracking-wider">Statut</span>
                            <div class="text-sm font-bold text-slate-700">${statusText}</div>
                        </div>
                    </div>

                    <div class="pt-2 flex flex-col gap-3">
                        ${!isPaid ? `
                            <button onclick="payTontine(${currentTontine.id}); closePointInfoModal();" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-black py-4 px-6 rounded-2xl shadow-lg shadow-emerald-600/20 active:scale-95 transition-all flex items-center justify-center gap-2 group">
                                <span>Payer ce point</span>
                                <i class="fas fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
                            </button>
                        ` : ''}
                        <button onclick="closePointInfoModal()" class="w-full bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold py-3 px-6 rounded-2xl active:scale-95 transition-all">
                            Fermer
                        </button>
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(modal);
        document.body.style.overflow = 'hidden';
    }

    function closePointInfoModal() {
        const modal = document.getElementById('pointInfoModal');
        if (modal) {
            modal.classList.add('animate-out', 'fade-out', 'zoom-out-95');
            setTimeout(() => {
                modal.remove();
                document.body.style.overflow = '';
            }, 300);
        }
    }
    
    // Exposer globalement
    window.closePointInfoModal = closePointInfoModal;

function getPointStatus(pointNumber) {
        const currentTontine = {{ getCurrentTontine() | json_encode | raw }};
        if (!currentTontine) {
            console.error('Aucune tontine trouv√©e');
            return '';
        }

        const paidPoints = currentTontine.paidPoints || 0;
        let status = '';

        if (pointNumber <= paidPoints) {
            status = '‚úÖ Pay√©';
        } else if (pointNumber === paidPoints + 1) {
            status = '‚è≥ √Ä payer';
        } else {
            status = 'üìÖ √Ä venir';
        }

        return status;
    }

    // Am√©lioration de l'impression
    window.addEventListener('beforeprint', () => {
        document.body.classList.add('printing');
    });

    window.addEventListener('afterprint', () => {
        document.body.classList.remove('printing');
    });

    // Gestion du responsive
    function adjustLayout() {
        const container = document.querySelector('.point-grid');
        if (container) {
            const containerWidth = container.offsetWidth;
            const cols = Math.floor(containerWidth / 55); // 45px + 10px gap
            if (cols > 0) {
                container.style.gridTemplateColumns = `repeat(${Math.min(cols, 14)
                    }, minmax(45px, 1fr))`;
            }
        }
    }

    window.addEventListener('resize', adjustLayout);
    window.addEventListener('load', adjustLayout);
</script>