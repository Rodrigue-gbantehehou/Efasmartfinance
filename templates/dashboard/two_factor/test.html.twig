{% extends 'dashboard/base.html.twig' %}

{% block title %}Test 2FA{% endblock %}

{% block contentdashboard %}
<div class="space-y-6">
    <div class="bg-white rounded-lg shadow p-6">
        <h1 class="text-2xl font-bold mb-4">Tester le 2FA</h1>
        
        <div class="space-y-4">
            <div>
                <h2 class="font-semibold mb-2">Informations de debug</h2>
                <pre id="debugInfo" class="bg-gray-100 p-4 rounded text-sm whitespace-pre-wrap">Chargement...</pre>
            </div>
            
            <div>
                <h2 class="font-semibold mb-2">Tester le code</h2>
                <input type="text" id="testCode" class="w-full border border-gray-300 rounded px-3 py-2 mb-2" placeholder="Code 2FA" maxlength="6">
                <button onclick="testCode()" class="bg-blue-500 text-white px-4 py-2 rounded">
                    Tester ce code
                </button>
                <div id="testResult" class="mt-2"></div>
            </div>
            
            <div>
                <h2 class="font-semibold mb-2">Recréer le QR Code</h2>
                <button onclick="recreateQRCode()" class="bg-green-500 text-white px-4 py-2 rounded">
                    Générer un nouveau QR Code
                </button>
                <div id="recreateResult" class="mt-2"></div>
            </div>
            
            <div class="bg-yellow-50 border border-yellow-200 rounded p-4">
                <h3 class="font-semibold text-yellow-800 mb-2">Instructions de dépannage</h3>
                <ol class="text-yellow-700 text-sm space-y-1">
                    <li>1. Allez sur <code>/dashboard/2fa/debug</code> pour voir les logs</li>
                    <li>2. Vérifiez que le temps serveur est synchronisé</li>
                    <li>3. Essayez d'augmenter la tolérance à 2 périodes (60 secondes)</li>
                    <li>4. Vérifiez que le secret est bien en Base32</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<script>
async function loadDebugInfo() {
    try {
        const response = await fetch('{{ path('app_dashboard_2fa_debug') }}');
        const data = await response.json();
        document.getElementById('debugInfo').textContent = JSON.stringify(data, null, 2);
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('debugInfo').textContent = 'Erreur: ' + error.message;
    }
}

async function testCode() {
    const code = document.getElementById('testCode').value;
    if (!code || code.length !== 6) {
        alert('Veuillez entrer un code à 6 chiffres');
        return;
    }
    
    try {
        const formData = new FormData();
        formData.append('code', code);
        
        const response = await fetch('{{ path('app_dashboard_2fa_verify') }}', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        const resultDiv = document.getElementById('testResult');
        if (data.success) {
            resultDiv.innerHTML = `
                <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">
                    ✓ Code valide! ${data.message}
                </div>
            `;
        } else {
            resultDiv.innerHTML = `
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                    ✗ ${data.message}
                </div>
            `;
        }
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('testResult').innerHTML = `
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                Erreur: ${error.message}
            </div>
        `;
    }
}

async function recreateQRCode() {
    try {
        const response = await fetch('{{ path('app_dashboard_2fa_enable') }}');
        
        if (response.ok) {
            window.location.href = '{{ path('app_dashboard_2fa_enable') }}';
        } else {
            document.getElementById('recreateResult').innerHTML = `
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                    Erreur lors de la recréation
                </div>
            `;
        }
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('recreateResult').innerHTML = `
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                Erreur: ${error.message}
            </div>
        `;
    }
}

// Charger les informations au démarrage
loadDebugInfo();
</script>
{% endblock %}