{% extends 'dashboard/base.html.twig' %}

{% block title %}Sécurité de Compte - EFA Smart Finance{% endblock %}

{% block contentdashboard %}
<div class="space-y-8 max-w-6xl mx-auto px-4 py-8 animate-fade-in-up">
    <!-- Hero Section with Animated Gradient -->
    <div class="relative overflow-hidden bg-green-900 rounded-[3rem] p-10 sm:p-16 text-white shadow-2xl shadow-green-900/40">
        <!-- Abstract Background Patterns -->
        <div class="absolute top-0 right-0 w-full h-full opacity-20 pointer-events-none">
            <svg class="absolute -top-24 -right-24 w-96 h-96 text-green-500/20" fill="currentColor" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="50" />
            </svg>
            <div class="absolute top-1/2 left-1/4 w-64 h-64 bg-emerald-500/10 rounded-full blur-3xl animate-pulse"></div>
        </div>
        
        <div class="relative z-10 flex flex-col lg:flex-row lg:items-center justify-between gap-12">
            <div class="max-w-xl">
                <div class="inline-flex items-center space-x-3 bg-white/5 backdrop-blur-xl px-4 py-2 rounded-2xl border border-white/10 mb-8 transform hover:scale-105 transition-transform">
                    <div class="relative flex h-3 w-3">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full {% if isTwoFactorEnabled %}bg-green-400{% else %}bg-yellow-400{% endif %} opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-3 w-3 {% if isTwoFactorEnabled %}bg-green-500{% else %}bg-yellow-500{% endif %}"></span>
                    </div>
                    <span class="text-xs font-black uppercase tracking-[0.2em] text-white/80">
                        {% if isTwoFactorEnabled %}Protection Niveau 2 Active{% else %}Sécurité Critique : Action Requise{% endif %}
                    </span>
                </div>
                
                <h1 class="text-4xl sm:text-6xl font-black mb-6 tracking-tighter leading-none">
                    Blindez votre <br/><span class="text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-yellow-300">Patrimoine Numérique</span>
                </h1>
                
                <p class="text-white text-lg sm:text-xl font-medium leading-relaxed mb-10">
                    L'authentification à deux facteurs par e-mail ajoute un verrou inviolable. Recevez vos codes de sécurité instantanément par e-mail pour valider vos connexions sensibles.
                </p>

                <div class="flex flex-wrap gap-4">
                    {% if isTwoFactorEnabled %}
                        <button onclick="openModal('disableModal')" class="bg-white/10 hover:bg-yellow-500/20 backdrop-blur-xl text-white border border-white/10 font-black py-4 px-8 rounded-2xl transition-all flex items-center group">
                            <i class="fas fa-lock-open mr-3 transition-transform group-hover:rotate-12"></i>
                            Désactiver la protection
                        </button>
                    {% else %}
                        <a href="{{ path('app_dashboard_2fa_enable') }}" class="bg-yellow-500 hover:bg-yellow-400 text-green-900 font-black py-5 px-12 rounded-2xl transition-all shadow-2xl shadow-yellow-500/40 flex items-center group scale-105">
                            <i class="fas fa-shield-alt mr-3 group-hover:scale-125 transition-transform"></i>
                            Sécuriser mon compte
                        </a>
                    {% endif %}
                </div>
            </div>
            
            <div class="hidden lg:block relative">
                <div class="w-80 h-80 bg-gradient-to-br from-green-700/40 to-yellow-500/5 rounded-[4rem] border border-white/10 flex items-center justify-center backdrop-blur-sm">
                    <i class="fas fa-user-shield text-9xl text-yellow-500 drop-shadow-2xl animate-float"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats & Information Grid -->
    <div class="grid lg:grid-cols-12 gap-8">
        <!-- Status Card -->
        <div class="lg:col-span-4">
            <div class="bg-white rounded-[2.5rem] p-10 shadow-xl shadow-slate-200/50 border border-slate-100 h-full transform hover:shadow-2xl transition-all">
                <h2 class="text-2xl font-black text-green-900 mb-8 flex items-center">
                    <span class="w-10 h-10 bg-green-100 rounded-xl flex items-center justify-center mr-4">
                        <i class="fas fa-fingerprint text-green-700 text-lg"></i>
                    </span>
                    Votre Configuration
                </h2>

                <div class="space-y-6">
                    <div class="p-6 rounded-3xl {% if isTwoFactorEnabled %}bg-green-50 border-green-100{% else %}bg-slate-50 border-slate-100{% endif %} border-2 transition-colors">
                        <p class="text-[10px] font-black uppercase tracking-widest mb-2 {% if isTwoFactorEnabled %}text-green-600{% else %}text-slate-400{% endif %}">Méthode Activée</p>
                        <p class="text-lg font-black text-slate-900">
                            {% if isTwoFactorEnabled %}Protection par E-mail{% else %}Aucune (Vulnérable){% endif %}
                        </p>
                    </div>

                    <div class="p-6 bg-slate-50 rounded-3xl border-2 border-slate-100">
                        <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest mb-2">Dernière Vérification</p>
                        <p class="text-sm font-bold text-slate-700">
                            {% if twoFactorAuth and twoFactorAuth.lastUsedAt %}{{ twoFactorAuth.lastUsedAt|date('d/m/Y à H:i') }}{% else %}En attente de première connexion{% endif %}
                        </p>
                    </div>

                    {% if not isTwoFactorEnabled %}
                    <div class="bg-amber-50 rounded-3xl p-6 border-2 border-amber-100">
                        <div class="flex items-center space-x-3 text-amber-600 mb-2">
                            <i class="fas fa-exclamation-circle text-xl"></i>
                            <span class="font-black text-xs uppercase tracking-wider">Alerte Sécurité</span>
                        </div>
                        <p class="text-amber-900/70 text-sm font-medium leading-relaxed">
                            Sans 2FA, votre compte est 80% plus susceptible d'être compromis.
                        </p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Backup Codes Card -->
        <div class="lg:col-span-8">
            <div class="bg-white rounded-[2.5rem] p-10 shadow-xl shadow-slate-200/50 border border-slate-100 h-full relative overflow-hidden group">
                {% if not isTwoFactorEnabled %}
                <div class="absolute inset-0 bg-white/80 backdrop-blur-md z-20 flex flex-col items-center justify-center p-12 text-center transition-all group-hover:bg-white/90">
                    <div class="w-20 h-20 bg-slate-50 rounded-3xl shadow-inner flex items-center justify-center mb-6 border border-slate-100">
                        <i class="fas fa-lock text-slate-300 text-3xl"></i>
                    </div>
                    <h3 class="text-2xl font-black text-green-900 mb-2">Clés de secours inaccessibles</h3>
                    <p class="text-slate-500 max-w-sm font-medium leading-relaxed">
                        Activez d'abord la protection 2FA pour générer et voir vos codes de secours permanents.
                    </p>
                </div>
                {% endif %}

                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-6 mb-10">
                    <div>
                        <h2 class="text-2xl font-black text-green-900 flex items-center">
                            <span class="w-10 h-10 bg-green-100 rounded-xl flex items-center justify-center mr-4">
                                <i class="fas fa-key text-green-600 text-lg"></i>
                            </span>
                            Clés de Secours
                        </h2>
                    </div>
                    
                    <div class="flex items-center px-4 py-2 bg-slate-950 rounded-2xl border border-slate-800 shadow-xl">
                        <span class="text-slate-500 text-[10px] font-black uppercase tracking-widest mr-3">Disponibles</span>
                        <span class="text-green-500 font-black text-lg">{{ backupCodes|length }}</span>
                        <span class="text-slate-600 font-bold text-sm mx-1">/</span>
                        <span class="text-slate-600 font-bold text-sm">10</span>
                    </div>
                </div>

                <div class="grid grid-cols-2 sm:grid-cols-5 gap-4 mb-10">
                    {% for code in backupCodes %}
                    <div class="relative overflow-hidden bg-slate-50 border-2 border-slate-100 rounded-2xl p-4 text-center group/code transition-all hover:bg-white hover:border-yellow-500 hover:shadow-lg hover:-translate-y-1">
                        <span class="font-mono font-black text-slate-800 tracking-wider transition-all group-hover/code:scale-110 block">{{ code }}</span>
                    </div>
                    {% endfor %}
                    {% for i in range(1, 10 - (backupCodes|length ?: 0)) %}
                    <div class="bg-slate-50/50 border-2 border-dashed border-slate-100 rounded-2xl p-4 text-center">
                        <span class="text-slate-200 font-black tracking-widest italic">------</span>
                    </div>
                    {% endfor %}
                </div>

                <div class="flex flex-col sm:flex-row gap-4 pt-8 border-t border-slate-100">
                    <button onclick="openModal('regenerateModal')" class="flex-1 bg-green-900 hover:bg-yellow-500 text-white font-black py-4 px-8 rounded-2xl transition-all shadow-xl shadow-slate-200 flex items-center justify-center group active:scale-95">
                        <i class="fas fa-sync-alt mr-3 group-hover:rotate-180 transition-transform duration-700"></i>
                        Vider & Régénérer
                    </button>
                    <a href="{{ path('app_dashboard_2fa_success') }}" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-800 font-black py-4 px-8 rounded-2xl transition-all flex items-center justify-center active:scale-95">
                        <i class="fas fa-file-export mr-3"></i>
                        Gérer les exports
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Guide & Trust Section -->
    <div class="bg-white rounded-[2.5rem] p-10 shadow-xl shadow-slate-200/50 border border-slate-100">
        <h2 class="text-2xl font-black text-slate-900 mb-10 text-center">Protocoles de <span class="text-green-700">Confiance</span></h2>
        <div class="grid md:grid-cols-3 gap-12">
            {% for item in [
                {icon: 'bolt', title: 'Code Instantané', desc: 'Recevez votre code de sécurité par e-mail en quelques secondes lors de chaque connexion.'},
                {icon: 'shield-halved', title: 'Protection Robuste', desc: 'Une double barrière de sécurité pour empêcher tout accès non autorisé à vos finances.'},
                {icon: 'circle-check', title: 'Simplicité d\'Utilisation', desc: 'Plus besoin d\'application tierce, tout se passe directement dans votre boîte mail.'}
            ] %}
            <div class="text-center group">
                <div class="w-16 h-16 bg-yellow-50 rounded-[1.5rem] flex items-center justify-center mx-auto mb-6 transform group-hover:scale-110 group-hover:bg-green-700 group-hover:text-white transition-all duration-300">
                    <i class="fas fa-{{ item.icon }} text-2xl text-green-700 transition-colors"></i>
                </div>
                <h3 class="text-lg font-black text-slate-900 mb-2">{{ item.title }}</h3>
                <p class="text-slate-500 text-sm font-medium leading-relaxed">{{ item.desc }}</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Modals -->
<!-- Global Overlay -->
<div id="modalOverlay" class="fixed inset-0 bg-slate-950/80 backdrop-blur-md z-[90] hidden opacity-0 transition-opacity duration-300"></div>

<!-- Disable Modal -->
<div id="disableModal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-[100] hidden flex flex-col w-full max-w-md p-4 animate-modal-pop">
    <div class="bg-white rounded-[2.5rem] p-8 sm:p-10 shadow-3xl">
        <div class="text-center mb-10">
            <div class="w-20 h-20 bg-red-50 rounded-3xl flex items-center justify-center mx-auto mb-6 border border-red-100">
                <i class="fas fa-bolt text-red-500 text-3xl"></i>
            </div>
            <h3 class="text-2xl font-black text-slate-900">Niveau de sécurité réduit ?</h3>
            <p class="text-slate-500 mt-2 font-medium">Vous êtes sur le point de retirer votre protection 2FA.</p>
        </div>

        <form id="disableForm" onsubmit="handleFormSubmit(event, '{{ path('app_dashboard_2fa_disable') }}', 'disableModal')" class="space-y-6">
            <div class="relative group">
                <i class="fas fa-lock absolute left-5 top-1/2 -translate-y-1/2 text-slate-300 transition-colors group-focus-within:text-red-500"></i>
                <input type="password" name="password" required placeholder="Mot de passe confidentiel" class="w-full pl-12 pr-6 py-5 bg-slate-50 border-2 border-slate-50 rounded-2xl focus:border-red-500 focus:bg-white focus:ring-[12px] focus:ring-red-50 transition-all outline-none font-bold">
            </div>
            <div class="flex gap-4">
                <button type="button" onclick="closeModal('disableModal')" class="flex-1 py-5 px-6 font-bold text-slate-400 hover:text-slate-600 transition-all uppercase tracking-widest text-xs">
                    Annuler
                </button>
                <button type="submit" class="flex-2 bg-red-500 hover:bg-red-600 text-white font-black py-5 px-8 rounded-2xl transition-all shadow-xl shadow-red-200 active:scale-95">
                    Désactiver
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Regenerate Modal -->
<div id="regenerateModal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-[100] hidden flex flex-col w-full max-w-md p-4 animate-modal-pop">
    <div class="bg-white rounded-[2.5rem] p-8 sm:p-10 shadow-3xl">
        <div class="text-center mb-10">
            <div class="w-20 h-20 bg-blue-50 rounded-3xl flex items-center justify-center mx-auto mb-6 border border-blue-100">
                <i class="fas fa-sync-alt text-blue-500 text-3xl"></i>
            </div>
            <h3 class="text-2xl font-black text-slate-900">Remplacement des clés</h3>
            <p class="text-slate-500 mt-2 font-medium">L'intégralité de vos anciens codes deviendra invalide.</p>
        </div>

        <form id="regenerateForm" onsubmit="handleFormSubmit(event, '{{ path('app_dashboard_2fa_regenerate_backup') }}', 'regenerateModal')" class="space-y-6">
            <div class="relative group">
                <i class="fas fa-shield absolute left-5 top-1/2 -translate-y-1/2 text-slate-300 transition-colors group-focus-within:text-blue-500"></i>
                <input type="password" name="password" required placeholder="Mot de passe personnel" class="w-full pl-12 pr-6 py-5 bg-slate-50 border-2 border-slate-50 rounded-2xl focus:border-blue-500 focus:bg-white focus:ring-[12px] focus:ring-blue-50 transition-all outline-none font-bold">
            </div>
            <div class="flex gap-4">
                <button type="button" onclick="closeModal('regenerateModal')" class="flex-1 py-5 px-6 font-bold text-slate-400 hover:text-slate-600 transition-all uppercase tracking-widest text-xs">
                    Annuler
                </button>
                <button type="submit" class="flex-2 bg-slate-900 hover:bg-black text-white font-black py-5 px-8 rounded-2xl transition-all shadow-xl shadow-slate-200 active:scale-95">
                    Générer
                </button>
            </div>
        </form>
    </div>
</div>

<style>
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(30px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in-up { animation: fadeInUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    
    @keyframes modalPop {
        from { transform: translate(-50%, -40%) scale(0.95); opacity: 0; }
        to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }
    .animate-modal-pop { animation: modalPop 0.4s cubic-bezier(0.17, 0.67, 0.1, 1.2) forwards; }
    
    @keyframes float {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-10px); }
    }
    .animate-float { animation: float 4s ease-in-out infinite; }

    .shadow-3xl { box-shadow: 0 35px 60px -15px rgba(15, 23, 42, 0.3); }
</style>

<script>
function openModal(id) {
    const modal = document.getElementById(id);
    const overlay = document.getElementById('modalOverlay');
    
    overlay.classList.remove('hidden');
    setTimeout(() => overlay.classList.add('opacity-100'), 10);
    
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closeModal(id) {
    const modal = document.getElementById(id);
    const overlay = document.getElementById('modalOverlay');
    
    overlay.classList.remove('opacity-100');
    setTimeout(() => {
        overlay.classList.add('hidden');
        modal.classList.add('hidden');
    }, 300);
    
    document.body.style.overflow = '';
}

async function handleFormSubmit(event, url, modalId) {
    event.preventDefault();
    const form = event.target;
    const btn = form.querySelector('button[type="submit"]');
    const originalText = btn.innerHTML;
    const formData = new FormData(form);

    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-circle-notch animate-spin text-xl"></i>';

    try {
        const response = await fetch(url, {
            method: 'POST',
            body: formData,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });
        const data = await response.json();

        if (data.success) {
            btn.innerHTML = '<i class="fas fa-check text-xl"></i>';
            btn.classList.add('bg-green-500', 'scale-105');
            setTimeout(() => {
                closeModal(modalId);
                location.reload();
            }, 800);
        } else {
            alert(data.message || 'Validation échouée');
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    } catch (err) {
        alert('Instabilité réseau détectée');
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}
</script>
{% endblock %}