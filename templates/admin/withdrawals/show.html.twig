{% extends 'admin/base.html.twig' %}

{% block title %}Détails du retrait #{{ withdrawal.id }} - EFA SMART FINANCE{% endblock %}

{% block contentadmin %}
<div class="min-h-screen bg-green-50-gray-50/50 pb-20">
    <!-- Header Premium -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-30">
        <div class="px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-20">
                <div class="flex items-center gap-4">
                    <a href="{{ path('admin_withdrawals') }}" class="h-10 w-10 flex items-center justify-center rounded-xl border border-gray-200 text-gray-600 hover:text-green-700 hover:border-green-200 transition-all">
                        <i class="fa-solid fa-arrow-left"></i>
                    </a>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">Demande de Retrait #{{ withdrawal.id }}</h1>
                        <p class="text-xs text-gray-600">Soumise le {{ withdrawal.requestedAt|date('d F Y à H:i') }}</p>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    {% if withdrawal.statut == 'approved' %}
                        <span class="px-4 py-2 rounded-xl text-sm font-bold bg-green-100 text-green-700 flex items-center gap-2">
                            <i class="fa-solid fa-check-circle"></i> Approuvé
                        </span>
                    {% elseif withdrawal.statut == 'rejected' %}
                        <span class="px-4 py-2 rounded-xl text-sm font-bold bg-red-100 text-red-700 flex items-center gap-2">
                            <i class="fa-solid fa-circle-xmark"></i> Rejeté
                        </span>
                    {% else %}
                        <span class="px-4 py-2 rounded-xl text-sm font-bold bg-yellow-100 text-yellow-700 flex items-center gap-2">
                            <i class="fa-solid fa-clock"></i> En attente de validation
                        </span>
                    {% endif %}
                </div>
            </div>
        </div>
    </header>

    <main class="py-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                <!-- Main Details Card -->
                <div class="lg:col-span-2 space-y-8">
                    <div class="bg-white rounded-[2.5rem] shadow-sm border border-gray-100 overflow-hidden">
                        <div class="p-8 md:p-10">
                            <h2 class="text-lg font-bold text-gray-900 mb-8 flex items-center gap-2">
                                <i class="fa-solid fa-receipt text-green-600"></i>
                                Récapitulatif Financier
                            </h2>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                                <div class="space-y-6">
                                    {# Calcul automatique si les champs ne sont pas encore bien renseignés #}
                                    {% set displayFee = withdrawal.totalAmount - withdrawal.amount %}
                                    {% set displayGross = withdrawal.totalAmount %}
                                    
                                    {% if displayFee == 0 and withdrawal.tontine and withdrawal.tontine.frequency == 'daily' %}
                                        {% set displayFee = withdrawal.tontine.deductedServiceFee %}
                                        {% set displayGross = withdrawal.amount + displayFee %}
                                    {% endif %}

                                    <div>
                                        <p class="text-xs font-bold text-gray-600 uppercase tracking-wider mb-1">Montant Brut Demandé</p>
                                        <p class="text-2xl font-extrabold text-gray-900">{{ displayGross|number_format(0, ',', ' ') }} FCFA</p>
                                    </div>
                                    <div>
                                        <p class="text-xs font-bold text-gray-600 uppercase tracking-wider mb-1">Frais de Gestion (Tontine)</p>
                                        <p class="text-xl font-bold text-red-500">- {{ displayFee|number_format(0, ',', ' ') }} FCFA</p>
                                    </div>
                                </div>
                                <div class="bg-green-50 rounded-3xl p-8 flex flex-col justify-center">
                                    <p class="text-xs font-bold text-green-600 uppercase tracking-wider mb-1">Montant Net à Transférer</p>
                                    <p class="text-4xl font-extrabold text-green-700">{{ withdrawal.amount|number_format(0, ',', ' ') }} FCFA</p>
                                    <div class="mt-4 flex items-center gap-2 text-green-600/70 text-sm">
                                        <i class="fa-solid fa-shield-check"></i>
                                        <span>Calcul vérifié par le système</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {% if withdrawal.statut == 'pending' %}
                        <div class="px-8 py-8 bg-gray-50 border-t border-gray-100">
                            <div class="flex flex-col sm:flex-row gap-4">
                                <form method="post" action="{{ path('admin_withdrawal_approve', {'id': withdrawal.id}) }}" class="flex-1" onsubmit="return confirm('Confirmer l\'approbation de ce retrait ?');">
                                    <input type="hidden" name="_token" value="{{ csrf_token('approve' ~ withdrawal.id) }}">
                                    <button type="submit" class="w-full flex items-center justify-center gap-2 px-6 py-4 bg-green-700 text-white rounded-2xl font-bold hover:bg-green-800 transition-all shadow-lg shadow-green-200">
                                        <i class="fa-solid fa-check-circle"></i>
                                        Approuver le retrait
                                    </button>
                                </form>
                                <form method="post" action="{{ path('admin_withdrawal_reject', {'id': withdrawal.id}) }}" class="flex-1" onsubmit="return confirm('Êtes-vous sûr de vouloir rejeter cette demande ?');">
                                    <input type="hidden" name="_token" value="{{ csrf_token('reject' ~ withdrawal.id) }}">
                                    <button type="submit" class="w-full flex items-center justify-center gap-2 px-6 py-4 bg-white text-red-600 border-2 border-red-100 rounded-2xl font-bold hover:bg-red-50 hover:border-red-200 transition-all">
                                        <i class="fa-solid fa-times-circle"></i>
                                        Rejeter la demande
                                    </button>
                                </form>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    {% if withdrawal.processedAt %}
                    <div class="bg-white rounded-[2rem] shadow-sm border border-gray-100 p-8">
                        <h2 class="text-lg font-bold text-gray-900 mb-6 flex items-center gap-2">
                            <i class="fa-solid fa-timeline text-green-600"></i>
                            Journal de Traitement
                        </h2>
                        <div class="flex items-start gap-4">
                            <div class="h-10 w-10 rounded-full bg-green-50 flex items-center justify-center flex-shrink-0">
                                <i class="fa-solid fa-user-shield text-green-600"></i>
                            </div>
                            <div>
                                <p class="text-sm font-bold text-gray-900">Traité par {{ withdrawal.administrateur.fullName }}</p>
                                <p class="text-sm text-gray-600">Action : {{ withdrawal.statut|capitalize }}</p>
                                <p class="text-xs text-gray-600 mt-1">Le {{ withdrawal.processedAt|date('d/m/Y à H:i') }}</p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- User Details Card -->
                <div class="space-y-8">
                    <div class="bg-white rounded-[2rem] shadow-sm border border-gray-100 p-8">
                        <h2 class="text-lg font-bold text-gray-900 mb-6">Informations Utilisateur</h2>
                        <div class="flex flex-col items-center mb-8">
                            <div class="h-24 w-24 rounded-3xl bg-green-100 flex items-center justify-center text-3xl font-extrabold text-green-700 mb-4 shadow-inner">
                                {{ withdrawal.utilisateur.firstname|first|upper }}{{ withdrawal.utilisateur.lastname|first|upper }}
                            </div>
                            <h3 class="text-xl font-bold text-gray-900">{{ withdrawal.utilisateur.fullName }}</h3>
                            <p class="text-sm text-gray-600">{{ withdrawal.utilisateur.email }}</p>
                        </div>

                        <div class="space-y-6 border-t border-gray-50 pt-6">
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-gray-600">UUID</span>
                                <span class="font-mono text-gray-900 bg-gray-50 px-2 py-0.5 rounded text-xs">{{ withdrawal.utilisateur.uuid }}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-gray-600">Téléphone</span>
                                <span class="font-bold text-gray-900">{{ withdrawal.utilisateur.phoneNumber ?? 'N/A' }}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-gray-600">Compte vérifié</span>
                                {% if withdrawal.utilisateur.isVerified %}
                                    <span class="text-green-600 font-bold flex items-center gap-1">
                                        <i class="fa-solid fa-circle-check"></i> Oui
                                    </span>
                                {% else %}
                                    <span class="text-red-500 font-bold flex items-center gap-1">
                                        <i class="fa-solid fa-circle-xmark"></i> Non
                                    </span>
                                {% endif %}
                            </div>
                        </div>

                        <div class="mt-10">
                            <a href="{{ path('admin_dashboard') }}?user={{ withdrawal.utilisateur.id }}" class="w-full flex items-center justify-center gap-2 px-6 py-3 bg-gray-50 text-gray-700 rounded-xl font-bold hover:bg-gray-100 transition-all text-sm">
                                <i class="fa-solid fa-user-gear"></i>
                                Gérer cet utilisateur
                            </a>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-br from-green-600 to-green-700 rounded-[2rem] shadow-lg p-8 text-white">
                        <i class="fa-solid fa-lightbulb text-green-200 text-3xl mb-4"></i>
                        <h3 class="text-lg font-bold mb-2">Note de sécurité</h3>
                        <p class="text-sm text-green-100 leading-relaxed">
                            Veuillez vérifier les informations de paiement de l'utilisateur avant d'approuver le transfert de fonds de {{ withdrawal.amount|number_format(0, ',', ' ') }} FCFA.
                        </p>
                    </div>
                </div>

            </div>
        </div>
    </main>
</div>
{% endblock %}
