{# templates/dashboard/admin/dashboard.html.twig #}
{% extends 'admin/base.html.twig' %}

{% block title %}Logs d'audit - Administration{% endblock %}

{% block contentadmin %}
<div class="space-y-6 p-4 md:p-6">
    <!-- En-tête -->
    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Logs d'audit</h1>
            <p class="text-sm text-gray-600 mt-1">Historique des actions et modifications</p>
        </div>
        <div class="flex items-center gap-3">
            <button id="clear-filters" 
                    class="hidden sm:inline-flex items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                <i class="fas fa-filter-circle-xmark mr-2"></i>
                Réinitialiser
            </button>
            <a href="{{ path('admin_audit_logs', {'export': 'csv'}) }}" 
               class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors duration-200">
                <i class="fas fa-download mr-2"></i>
                Exporter CSV
            </a>
        </div>
    </div>

    <!-- Filtres -->
    <div class="bg-white rounded-lg shadow p-4">
        <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
            <!-- Recherche -->
            <div class="md:col-span-4">
                <label for="search" class="block text-sm font-medium text-gray-700 mb-1">Rechercher</label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-search text-gray-400"></i>
                    </div>
                    <input type="text" 
                           id="search" 
                           class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500 sm:text-sm"
                           placeholder="Utilisateur, description...">
                </div>
            </div>

            <!-- Type d'action -->
            <div class="md:col-span-2">
                <label for="action-type" class="block text-sm font-medium text-gray-700 mb-1">Type d'action</label>
                <select id="action-type" 
                        class="block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 sm:text-sm">
                    <option value="">Toutes les actions</option>
                    <option value="create">Création</option>
                    <option value="update">Modification</option>
                    <option value="delete">Suppression</option>
                    <option value="login">Connexion</option>
                    <option value="logout">Déconnexion</option>
                </select>
            </div>

            <!-- Rôle utilisateur -->
            <div class="md:col-span-2">
                <label for="user-role" class="block text-sm font-medium text-gray-700 mb-1">Rôle</label>
                <select id="user-role" 
                        class="block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 sm:text-sm">
                    <option value="">Tous les rôles</option>
                    <option value="admin">Administrateur</option>
                    <option value="user">Utilisateur</option>
                    <option value="moderator">Modérateur</option>
                </select>
            </div>

            <!-- Date -->
            <div class="md:col-span-2">
                <label for="date-filter" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                <input type="date" 
                       id="date-filter" 
                       class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 sm:text-sm">
            </div>

            <!-- Filtres avancés -->
            <div class="md:col-span-2 flex items-end">
                <button id="advanced-filters-toggle" 
                        class="w-full inline-flex items-center justify-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                    <i class="fas fa-sliders-h mr-2"></i>
                    Avancés
                </button>
            </div>
        </div>

        <!-- Filtres avancés (cachés par défaut) -->
        <div id="advanced-filters" class="hidden mt-4 pt-4 border-t border-gray-200">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label for="ip-filter" class="block text-sm font-medium text-gray-700 mb-1">Adresse IP</label>
                    <input type="text" 
                           id="ip-filter" 
                           class="block w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500 sm:text-sm"
                           placeholder="192.168.1.1">
                </div>
                <div>
                    <label for="entity-filter" class="block text-sm font-medium text-gray-700 mb-1">Entité</label>
                    <input type="text" 
                           id="entity-filter" 
                           class="block w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500 sm:text-sm"
                           placeholder="User, Product...">
                </div>
                <div>
                    <label for="results-per-page" class="block text-sm font-medium text-gray-700 mb-1">Résultats/page</label>
                    <select id="results-per-page" 
                            class="block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 sm:text-sm">
                        <option value="10">10</option>
                        <option value="25" selected>25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistiques -->
    <div id="stats" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="bg-white rounded-lg shadow p-4">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="p-2 bg-green-100 rounded-lg">
                        <i class="fas fa-history text-green-600 text-lg"></i>
                    </div>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Total des logs</p>
                    <p class="text-2xl font-bold text-gray-900" id="total-logs">{{ logs|length }}</p>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="p-2 bg-green-100 rounded-lg">
                        <i class="fas fa-plus-circle text-green-600 text-lg"></i>
                    </div>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Créations</p>
                    <p class="text-2xl font-bold text-gray-900" id="create-count">0</p>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="p-2 bg-yellow-100 rounded-lg">
                        <i class="fas fa-edit text-yellow-600 text-lg"></i>
                    </div>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Modifications</p>
                    <p class="text-2xl font-bold text-gray-900" id="update-count">0</p>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="p-2 bg-red-100 rounded-lg">
                        <i class="fas fa-trash text-red-600 text-lg"></i>
                    </div>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Suppressions</p>
                    <p class="text-2xl font-bold text-gray-900" id="delete-count">0</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Tableau des logs -->
    <div class="bg-white shadow rounded-lg overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer sortable" data-sort="user">
                            Utilisateur <i class="fas fa-sort ml-1"></i>
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer sortable" data-sort="action">
                            Action <i class="fas fa-sort ml-1"></i>
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Détails</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer sortable" data-sort="date">
                            Date <i class="fas fa-sort ml-1"></i>
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">IP</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="logs-table-body">
                    {% for log in logs %}
                    <tr class="log-entry hover:bg-gray-50 transition-colors duration-150"
                        data-action="{{ log.actions|lower }}"
                        data-role="{{ log.utilisateur ? (log.utilisateur.roles[0]|replace({'ROLE_': ''})|lower) : 'system' }}"
                        data-date="{{ log.createdAt ? log.createdAt|date('Y-m-d') : '' }}"
                        data-ip="{{ log.ipAdress }}"
                        data-entity="{{ log.entityType|default('')|lower }}"
                        data-user="{{ (log.utilisateur ? (log.utilisateur.firstName ~ ' ' ~ log.utilisateur.lastName)|trim : 'Système')|lower }}">
                        <td class="px-6 py-4">
                            <div class="flex items-center">
                             
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">
                                        {{ log.utilisateur ? (log.utilisateur.firstName ~ ' ' ~ log.utilisateur.lastName)|trim : 'Système' }}
                                    </div>
                                    <div class="text-sm text-gray-500">
                                        {{ log.utilisateur ? log.utilisateur.email : 'Système' }}
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex items-center">
                                <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full 
                                    {% if log.actions == 'create' %}bg-green-100 text-green-800
                                    {% elseif log.actions == 'update' %}bg-yellow-100 text-yellow-800
                                    {% elseif log.actions == 'delete' %}bg-red-100 text-red-800
                                    {% elseif log.actions == 'login' %}bg-green-100 text-green-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    <i class="mr-1 fas 
                                        {% if log.actions == 'create' %}fa-plus-circle
                                        {% elseif log.actions == 'update' %}fa-edit
                                        {% elseif log.actions == 'delete' %}fa-trash
                                        {% elseif log.actions == 'login' %}fa-sign-in-alt
                                        {% else %}fa-info-circle{% endif %}"></i>
                                    {{ log.actions|capitalize }}
                                </span>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="max-w-xs">
                                <div class="text-sm text-gray-900 truncate" title="{{ log.description }}">
                                    {{ log.description }}
                                </div>
                                {% if log.entityType %}
                                <div class="text-xs text-gray-500 mt-1">
                                    <i class="fas fa-cube mr-1"></i>
                                    {{ log.entityType }}
                                </div>
                                {% endif %}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">
                                {{ log.createdAt ? log.createdAt|date('d/m/Y') : '' }}
                            </div>
                            <div class="text-xs text-gray-500">
                                {{ log.createdAt ? log.createdAt|date('H:i:s') : '' }}
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900 font-mono" title="{{ log.ipAdress }}">
                                {{ log.ipAdress }}
                            </div>
                            {% if log.userAgent %}
                            <div class="text-xs text-gray-500 truncate max-w-xs" title="{{ log.userAgent }}">
                                <i class="fas fa-desktop mr-1"></i>
                                {{ log.userAgent }}
                            </div>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button class="view-log-details text-green-600 hover:text-green-900 mr-3"
                                    data-log-id="{{ log.id }}"
                                    title="Voir les détails">
                                <i class="fas fa-eye"></i>
                            </button>
                            <a href="{{ path('admin_audit_log_detail', {'id': log.id}) }}" 
                               class="text-indigo-600 hover:text-indigo-900"
                               title="Ouvrir la page de détails">
                                <i class="fas fa-external-link-alt"></i>
                            </a>
                        </td>
                    </tr>
                    {% else %}
                    <tr id="no-results">
                        <td colspan="6" class="px-6 py-12 text-center">
                            <div class="flex flex-col items-center justify-center">
                                <i class="fas fa-clipboard-list text-gray-300 text-4xl mb-3"></i>
                                <p class="text-gray-500 font-medium">Aucun log d'audit trouvé</p>
                                <p class="text-gray-400 text-sm mt-1">Les logs apparaîtront ici</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if logs|length > 0 %}
        <div class="bg-white px-4 py-3 border-t border-gray-200 sm:px-6">
            <div class="flex flex-col sm:flex-row items-center justify-between">
                <div class="mb-4 sm:mb-0">
                    <p class="text-sm text-gray-700">
                        Affichage de <span class="font-medium" id="start-index">1</span> à 
                        <span class="font-medium" id="end-index">{{ logs|length }}</span> sur 
                        <span class="font-medium" id="total-count">{{ logs|length }}</span> résultats
                        (<span class="font-medium" id="filtered-count">{{ logs|length }}</span> filtrés)
                    </p>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-sm text-gray-700 mr-2">Page</span>
                    <select id="page-select" class="text-sm border-gray-300 rounded focus:ring-green-500 focus:border-green-500">
                        {% for i in 1..((logs|length / 25)|round(0, 'ceil')) %}
                        <option value="{{ i }}">{{ i }}</option>
                        {% endfor %}
                    </select>
                    <span class="text-sm text-gray-700 ml-2">
                        sur {{ ((logs|length / 25)|round(0, 'ceil')) }}
                    </span>
                    <button id="prev-page" class="p-2 text-gray-500 hover:text-gray-700 disabled:opacity-50" disabled>
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button id="next-page" class="p-2 text-gray-500 hover:text-gray-700">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal de détails -->
<div id="log-details-modal" class="hidden fixed inset-0 overflow-y-auto z-50">
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                                Détails du log
                            </h3>
                            <button type="button" id="close-modal" class="text-gray-400 hover:text-gray-500">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <div class="mt-2 space-y-4" id="modal-content">
                            <!-- Contenu chargé dynamiquement -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" id="modal-close-btn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 sm:ml-3 sm:w-auto sm:text-sm">
                    Fermer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const logs = Array.from(document.querySelectorAll('.log-entry'));
    const resultsPerPage = parseInt(document.getElementById('results-per-page').value) || 25;
    let currentPage = 1;
    let currentSort = { column: 'date', direction: 'desc' };

    // Initialiser les compteurs
    updateStats();

    // Fonction de filtrage
    function filterLogs() {
        const searchTerm = document.getElementById('search').value.toLowerCase();
        const actionType = document.getElementById('action-type').value.toLowerCase();
        const userRole = document.getElementById('user-role').value.toLowerCase();
        const dateFilter = document.getElementById('date-filter').value;
        const ipFilter = document.getElementById('ip-filter')?.value.toLowerCase() || '';
        const entityFilter = document.getElementById('entity-filter')?.value.toLowerCase() || '';

        logs.forEach(row => {
            const action = row.dataset.action || '';
            const role = row.dataset.role || '';
            const date = row.dataset.date || '';
            const ip = row.dataset.ip || '';
            const entity = row.dataset.entity || '';
            const user = row.dataset.user || '';
            const details = row.querySelector('td:nth-child(3)').textContent.trim().toLowerCase();

            const matchesSearch = !searchTerm || 
                details.includes(searchTerm) || 
                user.includes(searchTerm);

            const matchesAction = !actionType || action === actionType;
            const matchesRole = !userRole || role === userRole;
            const matchesDate = !dateFilter || date === dateFilter;
            const matchesIp = !ipFilter || ip.includes(ipFilter);
            const matchesEntity = !entityFilter || entity.includes(entityFilter);

            row.style.display = (matchesSearch && matchesAction && matchesRole && 
                               matchesDate && matchesIp && matchesEntity) ? '' : 'none';
        });

        updateStats();
        updatePagination();
        updateVisibleRows();
    }

    // Mettre à jour les statistiques
    function updateStats() {
        const visibleLogs = logs.filter(row => row.style.display !== 'none');
        document.getElementById('filtered-count').textContent = visibleLogs.length;

        const createCount = visibleLogs.filter(row => row.dataset.action === 'create').length;
        const updateCount = visibleLogs.filter(row => row.dataset.action === 'update').length;
        const deleteCount = visibleLogs.filter(row => row.dataset.action === 'delete').length;

        document.getElementById('create-count').textContent = createCount;
        document.getElementById('update-count').textContent = updateCount;
        document.getElementById('delete-count').textContent = deleteCount;

        // Afficher/masquer le message "Aucun résultat"
        const noResults = document.getElementById('no-results');
        if (visibleLogs.length === 0 && noResults) {
            noResults.style.display = '';
        } else if (noResults) {
            noResults.style.display = 'none';
        }
    }

    // Pagination
    function updatePagination() {
        const visibleLogs = logs.filter(row => row.style.display !== 'none');
        const totalPages = Math.ceil(visibleLogs.length / resultsPerPage);
        
        // Mettre à jour le sélecteur de page
        const pageSelect = document.getElementById('page-select');
        if (pageSelect) {
            pageSelect.innerHTML = '';
            for (let i = 1; i <= totalPages; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                option.selected = i === currentPage;
                pageSelect.appendChild(option);
            }
        }

        // Activer/désactiver les boutons de navigation
        document.getElementById('prev-page').disabled = currentPage === 1;
        document.getElementById('next-page').disabled = currentPage === totalPages;

        // Mettre à jour les indices
        const start = (currentPage - 1) * resultsPerPage + 1;
        const end = Math.min(currentPage * resultsPerPage, visibleLogs.length);
        
        document.getElementById('start-index').textContent = start;
        document.getElementById('end-index').textContent = end;
        document.getElementById('total-count').textContent = visibleLogs.length;
    }

    function updateVisibleRows() {
        const visibleLogs = logs.filter(row => row.style.display !== 'none');
        const startIndex = (currentPage - 1) * resultsPerPage;
        const endIndex = startIndex + resultsPerPage;

        logs.forEach(row => {
            if (row.style.display !== 'none') {
                const rowIndex = visibleLogs.indeF CFA(row);
                row.style.display = (rowIndex >= startIndex && rowIndex < endIndex) ? '' : 'none';
            }
        });
    }

    // Tri des colonnes
    document.querySelectorAll('.sortable').forEach(header => {
        header.addEventListener('click', function() {
            const column = this.dataset.sort;
            const direction = currentSort.column === column && currentSort.direction === 'asc' ? 'desc' : 'asc';
            
            currentSort = { column, direction };
            
            // Mettre à jour les icônes
            document.querySelectorAll('.sortable i').forEach(icon => {
                icon.className = 'fas fa-sort ml-1';
            });
            
            const icon = this.querySelector('i');
            icon.className = direction === 'asc' ? 'fas fa-sort-up ml-1' : 'fas fa-sort-down ml-1';
            
            sortLogs(column, direction);
        });
    });

    function sortLogs(column, direction) {
        const visibleLogs = logs.filter(row => row.style.display !== 'none');
        
        visibleLogs.sort((a, b) => {
            let aValue, bValue;
            
            switch(column) {
                case 'user':
                    aValue = a.dataset.user || '';
                    bValue = b.dataset.user || '';
                    break;
                case 'action':
                    aValue = a.dataset.action || '';
                    bValue = b.dataset.action || '';
                    break;
                case 'date':
                    aValue = a.dataset.date || '';
                    bValue = b.dataset.date || '';
                    break;
                default:
                    return 0;
            }
            
            if (direction === 'asc') {
                return aValue.localeCompare(bValue);
            } else {
                return bValue.localeCompare(aValue);
            }
        });
        
        // Réorganiser le DOM
        const tbody = document.querySelector('tbody');
        visibleLogs.forEach(row => {
            tbody.appendChild(row);
        });
        
        updateVisibleRows();
    }

    // Événements
    document.getElementById('search').addEventListener('input', debounce(filterLogs, 300));
    document.getElementById('action-type').addEventListener('change', filterLogs);
    document.getElementById('user-role').addEventListener('change', filterLogs);
    document.getElementById('date-filter').addEventListener('change', filterLogs);
    
    if (document.getElementById('ip-filter')) {
        document.getElementById('ip-filter').addEventListener('input', debounce(filterLogs, 300));
    }
    
    if (document.getElementById('entity-filter')) {
        document.getElementById('entity-filter').addEventListener('input', debounce(filterLogs, 300));
    }

    // Filtres avancés
    document.getElementById('advanced-filters-toggle').addEventListener('click', function() {
        const advancedFilters = document.getElementById('advanced-filters');
        const icon = this.querySelector('i');
        
        if (advancedFilters.classList.contains('hidden')) {
            advancedFilters.classList.remove('hidden');
            icon.className = 'fas fa-sliders-h mr-2';
        } else {
            advancedFilters.classList.add('hidden');
            icon.className = 'fas fa-sliders-h mr-2';
        }
    });

    // Réinitialiser les filtres
    document.getElementById('clear-filters').addEventListener('click', function() {
        document.getElementById('search').value = '';
        document.getElementById('action-type').value = '';
        document.getElementById('user-role').value = '';
        document.getElementById('date-filter').value = '';
        
        if (document.getElementById('ip-filter')) {
            document.getElementById('ip-filter').value = '';
        }
        
        if (document.getElementById('entity-filter')) {
            document.getElementById('entity-filter').value = '';
        }
        
        document.getElementById('results-per-page').value = '25';
        
        const advancedFilters = document.getElementById('advanced-filters');
        if (!advancedFilters.classList.contains('hidden')) {
            advancedFilters.classList.add('hidden');
        }
        
        filterLogs();
    });

    // Pagination
    document.getElementById('prev-page').addEventListener('click', function() {
        if (currentPage > 1) {
            currentPage--;
            updatePagination();
            updateVisibleRows();
        }
    });

    document.getElementById('next-page').addEventListener('click', function() {
        const visibleLogs = logs.filter(row => row.style.display !== 'none');
        const totalPages = Math.ceil(visibleLogs.length / resultsPerPage);
        
        if (currentPage < totalPages) {
            currentPage++;
            updatePagination();
            updateVisibleRows();
        }
    });

    if (document.getElementById('page-select')) {
        document.getElementById('page-select').addEventListener('change', function() {
            currentPage = parseInt(this.value);
            updatePagination();
            updateVisibleRows();
        });
    }

    // Modal de détails
    document.querySelectorAll('.view-log-details').forEach(button => {
        button.addEventListener('click', function() {
            const logId = this.dataset.logId;
            // Ici, vous pouvez charger les détails via AJAX ou afficher des données existantes
            showLogDetails(logId);
        });
    });

    function showLogDetails(logId) {
        const modal = document.getElementById('log-details-modal');
        const modalContent = document.getElementById('modal-content');
        
        // Pour l'exemple, on affiche des données statiques
        // En production, vous feriez une requête AJAX
        modalContent.innerHTML = `
            <div class="space-y-3">
                <div>
                    <h4 class="text-sm font-medium text-gray-500">Description complète</h4>
                    <p class="mt-1 text-sm text-gray-900">Description détaillée de l'action...</p>
                </div>
                <div>
                    <h4 class="text-sm font-medium text-gray-500">Données avant modification</h4>
                    <pre class="mt-1 text-xs bg-gray-50 p-2 rounded overflow-auto max-h-32">{"id": 123, "name": "Ancien nom"}</pre>
                </div>
                <div>
                    <h4 class="text-sm font-medium text-gray-500">Données après modification</h4>
                    <pre class="mt-1 text-xs bg-gray-50 p-2 rounded overflow-auto max-h-32">{"id": 123, "name": "Nouveau nom"}</pre>
                </div>
            </div>
        `;
        
        modal.classList.remove('hidden');
    }

    // Fermer le modal
    document.getElementById('close-modal').addEventListener('click', closeModal);
    document.getElementById('modal-close-btn').addEventListener('click', closeModal);

    function closeModal() {
        document.getElementById('log-details-modal').classList.add('hidden');
    }

    // Fermer le modal avec ESC
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeModal();
        }
    });

    // Débounce helper
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // Initialiser
    updatePagination();
    updateVisibleRows();
});
</script>
{% endblock %}