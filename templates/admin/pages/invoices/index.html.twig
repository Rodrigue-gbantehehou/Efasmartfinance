{% extends 'admin/base.html.twig' %}

{% block title %}Gestion des Factures{% endblock %}

{% block contentadmin %}
<div class="min-h-screen bg-green-50 from-slate-50 via-green-50/30 to-slate-100 font-poppins p-8">
    <div class="max-w-7xl mx-auto">
        
        {# Header #}
        <div class="mb-8">
            <h1 class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-green-600 to-green-800 mb-2">
                üìÑ Gestion des Factures
            </h1>
            <p class="text-slate-600 text-lg">Consultez, renvoyez et t√©l√©chargez vos factures</p>
        </div>

        {# Stats Cards #}
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-3xl p-6 shadow-lg border-2 border-green-100">
                <div class="text-3xl font-black text-slate-800">{{ totalFactures }}</div>
                <div class="text-sm text-slate-500 font-semibold">Total Factures</div>
            </div>
            <div class="bg-white rounded-3xl p-6 shadow-lg border-2 border-green-100">
                <div class="text-3xl font-black text-green-600">{{ totalPayees }}</div>
                <div class="text-sm text-slate-500 font-semibold">Pay√©es</div>
            </div>
            <div class="bg-white rounded-3xl p-6 shadow-lg border-2 border-orange-100">
                <div class="text-3xl font-black text-orange-600">{{ totalImpayees }}</div>
                <div class="text-sm text-slate-500 font-semibold">En attente</div>
            </div>
            <div class="bg-white rounded-3xl p-6 shadow-lg border-2 border-green-100">
                <div class="text-3xl font-black text-green-600">{{ montantTotal|number_format(0, ',', ' ') }}</div>
                <div class="text-sm text-slate-500 font-semibold">FCFA Total</div>
            </div>
        </div>

        {# Filters #}
        <div class="bg-white rounded-3xl p-6 shadow-lg border-2 border-slate-100 mb-8">
            <form method="get" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Recherche</label>
                    <input type="text" name="search" value="{{ filters.search }}" placeholder="Num√©ro, email, nom..." 
                           class="w-full px-4 py-2 border-2 border-slate-200 rounded-xl focus:border-green-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Statut</label>
                    <select name="statut" class="w-full px-4 py-2 border-2 border-slate-200 rounded-xl focus:border-green-500 focus:outline-none">
                        <option value="">Tous</option>
                        <option value="payee" {{ filters.statut == 'payee' ? 'selected' : '' }}>Pay√©e</option>
                        <option value="impayee" {{ filters.statut == 'impayee' ? 'selected' : '' }}>Impay√©e</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Date d√©but</label>
                    <input type="date" name="date_debut" value="{{ filters.date_debut }}" 
                           class="w-full px-4 py-2 border-2 border-slate-200 rounded-xl focus:border-green-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Date fin</label>
                    <input type="date" name="date_fin" value="{{ filters.date_fin }}" 
                           class="w-full px-4 py-2 border-2 border-slate-200 rounded-xl focus:border-green-500 focus:outline-none">
                </div>
                <div class="md:col-span-4 flex gap-3">
                    <button type="submit" class="px-6 py-2 bg-green-500 text-white rounded-xl hover:bg-green-600 transition-colors font-semibold">
                        üîç Filtrer
                    </button>
                    <a href="{{ path('admin_invoices') }}" class="px-6 py-2 bg-slate-200 text-slate-700 rounded-xl hover:bg-slate-300 transition-colors font-semibold">
                        ‚Üª R√©initialiser
                    </a>
                </div>
            </form>
        </div>

        {# Invoices Table #}
        <div class="bg-white rounded-3xl p-8 shadow-lg border-2 border-slate-100">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-slate-800">üìã Liste des Factures</h2>
                <button onclick="downloadSelected()" class="px-4 py-2 bg-emerald-500 text-white rounded-xl hover:bg-emerald-600 transition-colors font-semibold">
                    ‚¨á T√©l√©charger s√©lection
                </button>
            </div>

            <form id="bulkForm" method="post" action="{{ path('admin_invoices_bulk_download') }}">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b-2 border-slate-200">
                                <th class="text-left py-4 px-4">
                                    <input type="checkbox" id="selectAll" class="w-5 h-5 rounded border-2 border-slate-300">
                                </th>
                                <th class="text-left py-4 px-4 font-bold text-slate-700">Num√©ro</th>
                                <th class="text-left py-4 px-4 font-bold text-slate-700">Client</th>
                                <th class="text-left py-4 px-4 font-bold text-slate-700">Date</th>
                                <th class="text-left py-4 px-4 font-bold text-slate-700">Montant TTC</th>
                                <th class="text-left py-4 px-4 font-bold text-slate-700">Statut</th>
                                <th class="text-left py-4 px-4 font-bold text-slate-700">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for facture in factures %}
                                <tr class="border-b border-slate-100 hover:bg-slate-50 transition-colors">
                                    <td class="py-4 px-4">
                                        <input type="checkbox" name="invoice_ids[]" value="{{ facture.id }}" class="invoice-checkbox w-5 h-5 rounded border-2 border-slate-300">
                                    </td>
                                    <td class="py-4 px-4 font-mono text-sm font-bold text-green-600">{{ facture.numero }}</td>
                                    <td class="py-4 px-4">
                                        {% if facture.client %}
                                            <div class="font-semibold text-slate-800">{{ facture.client.firstname }} {{ facture.client.lastname }}</div>
                                            <div class="text-sm text-slate-500">{{ facture.client.email }}</div>
                                        {% else %}
                                            <span class="text-slate-400">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td class="py-4 px-4 text-slate-600">{{ facture.dateEmission|date('d/m/Y') }}</td>
                                    <td class="py-4 px-4 font-bold text-emerald-600">{{ facture.montantTTC|number_format(0, ',', ' ') }} FCFA</td>
                                    <td class="py-4 px-4">
                                        {% if facture.statut == 'payee' %}
                                            <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-semibold">‚úì Pay√©e</span>
                                        {% else %}
                                            <span class="px-3 py-1 bg-orange-100 text-orange-700 rounded-full text-sm font-semibold">‚è≥ En attente</span>
                                        {% endif %}
                                    </td>
                                    <td class="py-4 px-4">
                                        <div class="flex gap-2">
                                            <a href="{{ path('admin_invoice_show', {id: facture.id}) }}" 
                                               class="px-3 py-1 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors text-sm font-semibold"
                                               title="Voir d√©tails">
                                                üëÅÔ∏è
                                            </a>
                                            <a href="{{ path('admin_invoice_download', {id: facture.id}) }}" 
                                               class="px-3 py-1 bg-emerald-100 text-emerald-700 rounded-lg hover:bg-emerald-200 transition-colors text-sm font-semibold"
                                               title="T√©l√©charger">
                                                ‚¨á
                                            </a>
                                            <button type="button" onclick="resendInvoice({{ facture.id }}, '{{ facture.numero }}', '{{ csrf_token('resend' ~ facture.id) }}')" 
                                                    class="px-3 py-1 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors text-sm font-semibold"
                                                    title="Renvoyer par email">
                                                ‚úâÔ∏è
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            {% else %}
                                <tr>
                                    <td colspan="7" class="py-12 text-center text-slate-400">
                                        Aucune facture trouv√©e
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </form>
        </div>

    </div>
</div>

<style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;900&display=swap');
    .font-poppins { font-family: 'Poppins', sans-serif; }
</style>

<script>
// Select all checkboxes
document.getElementById('selectAll')?.addEventListener('change', function() {
    document.querySelectorAll('.invoice-checkbox').forEach(cb => cb.checked = this.checked);
});

// Download selected invoices
function downloadSelected() {
    const selected = document.querySelectorAll('.invoice-checkbox:checked');
    if (selected.length === 0) {
        alert('Veuillez s√©lectionner au moins une facture');
        return;
    }
    document.getElementById('bulkForm').submit();
}

// Resend invoice
function resendInvoice(id, numero, tokenValue) {
    if (!confirm(`Voulez-vous vraiment renvoyer la facture ${numero} par email ?`)) {
        return;
    }
    
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/admin/invoices/${id}/resend`;
    
    const token = document.createElement('input');
    token.type = 'hidden';
    token.name = '_token';
    token.value = tokenValue;
    form.appendChild(token);
    
    document.body.appendChild(form);
    form.submit();
}
</script>
{% endblock %}
