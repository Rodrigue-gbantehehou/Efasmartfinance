<!-- Mobile Drawer -->
<div id="drawer" class="fixed inset-0 z-50 hidden">
  <div id="drawerBackdrop" class="absolute inset-0 bg-black/50"></div>
  <aside
    class="absolute top-0 left-0 bottom-0 w-72 bg-gradient-to-b from-green-700 via-green-600 to-green-700 border-r border-green-800 flex flex-col shadow-xl">
    <div class="px-5 py-4 flex items-center gap-3 border-b border-green-500/30">
      <a href="{{path('app_home')}}">
        <img src="{{asset ('images/estm.png')}}" alt="Logo" class="h-20 brightness-0 invert" />
      </a>

    </div>

    <div class="px-4 py-3 border-y border-green-500/30">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-full bg-white/20 flex items-center justify-center text-white backdrop-blur-sm">
          <i class="fa-solid fa-user"></i>
        </div>
        <div>
          <div class="font-semibold text-sm text-white">Bienvenue, <span>{{ app.user.firstname ~ ' ' ~ app.user.lastname
              }}</span></div>
          <div class="text-xs text-green-100">Complet depuis 2024</div>
        </div>
      </div>
    </div>

    <nav class="mt-2 px-3 pb-4 space-y-6 flex-1 overflow-y-auto scrollbar-hide">
      
      {# 1. PÔLE MÉTIER #}
      {% if is_granted('VIEW_MODULE', 'dashboard') or is_granted('VIEW_MODULE', 'tontines') or is_granted('VIEW_MODULE', 'withdrawals') or is_granted('VIEW_MODULE', 'caisse') %}
      <div>
        <h3 class="px-4 text-[10px] font-bold text-green-300/60 uppercase tracking-widest mb-2">Pôle Métier</h3>
        <div class="space-y-1">
          {% if is_granted('VIEW_MODULE', 'dashboard') %}
            {% if is_granted('ROLE_CAISSIER') and not is_granted('ROLE_FINANCE') and not is_granted('ROLE_ADMIN') %}
            <a href="{{ path('admin_caisse_dashboard') }}"
              class="flex items-center px-4 py-2.5 rounded-xl transition-all duration-200 group {{ app.request.get('_route') == 'admin_caisse_dashboard' ? 'bg-white/20 text-white shadow-lg' : 'text-white/80 hover:bg-white/10 hover:text-white' }}">
              <i class="fas fa-chart-line w-6 text-sm"></i>
              <span class="ml-3 text-sm font-medium">Tableau de Bord</span>
            </a>
            {% else %}
            <a href="{{ path('admin_dashboard') }}"
              class="flex items-center px-4 py-2.5 rounded-xl transition-all duration-200 group {{ app.request.get('_route') == 'admin_dashboard' ? 'bg-white/20 text-white shadow-lg' : 'text-white/80 hover:bg-white/10 hover:text-white' }}">
              <i class="fas fa-home w-6 text-sm"></i>
              <span class="ml-3 text-sm font-medium">Vue d'ensemble</span>
            </a>
            {% endif %}
          {% endif %}

          {% if is_granted('VIEW_MODULE', 'tontines') %}
          <a href="{{ path('admin_tontine_index') }}"
            class="flex items-center px-4 py-2.5 rounded-xl transition-all duration-200 group {{ app.request.get('_route') starts with 'admin_tontine' ? 'bg-white/20 text-white shadow-lg' : 'text-white/80 hover:bg-white/10 hover:text-white' }}">
            <i class="fa-solid fa-piggy-bank w-6 text-sm"></i>
            <span class="ml-3 text-sm font-medium">Gestion Tontines</span>
          </a>
          {% endif %}

          {% if is_granted('VIEW_MODULE', 'withdrawals') %}
          <a href="{{ path('admin_withdrawals') }}"
            class="flex items-center justify-between px-4 py-2.5 rounded-xl transition-all duration-200 group {{ app.request.get('_route') starts with 'admin_withdrawals' ? 'bg-white/20 text-white shadow-lg' : 'text-white/80 hover:bg-white/10 hover:text-white' }}">
            <div class="flex items-center">
              <i class="fa-solid fa-hand-holding-dollar w-6 text-sm"></i>
              <span class="ml-3 text-sm font-medium">Opérations Retraits</span>
            </div>
            {{ render(controller('App\\Controller\\Admin\\WithdrawalAdminController::countPendingWithdrawals')) }}
          </a>
          {% endif %}

          {% if is_granted('VIEW_MODULE', 'caisse') %}
          <a href="{{ path('admin_caisse_index') }}"
            class="flex items-center px-4 py-2.5 rounded-xl transition-all duration-200 group {{ app.request.get('_route') starts with 'admin_caisse' ? 'bg-white/20 text-white shadow-lg border-l-4 border-amber-400' : 'text-white/80 hover:bg-white/10 hover:text-white' }}">
            <i class="fa-solid fa-cash-register w-6 text-sm"></i>
            <span class="ml-3 text-sm font-bold text-amber-100">Guichet Caisse</span>
          </a>
          {% endif %}
        </div>
      </div>
      {% endif %}

      {# 2. PÔLE FINANCIER #}
      {% if is_granted('VIEW_MODULE', 'financial') or is_granted('VIEW_MODULE', 'transactions') or is_granted('VIEW_MODULE', 'invoices') %}
      <div>
        <h3 class="px-4 text-[10px] font-bold text-green-300/60 uppercase tracking-widest mb-2">Pôle Financier</h3>
        <div class="space-y-1">
          {% if is_granted('VIEW_MODULE', 'financial') %}
          <a href="{{ path('admin_financial_dashboard') }}"
            class="flex items-center px-4 py-2.5 rounded-xl transition-all duration-200 group {{ app.request.get('_route') == 'admin_financial_dashboard' ? 'bg-white/20 text-white shadow-lg' : 'text-white/80 hover:bg-white/10 hover:text-white' }}">
            <i class="fa-solid fa-chart-pie w-6 text-sm"></i>
            <span class="ml-3 text-sm font-medium">Pilote Trésorerie</span>
          </a>
          {% endif %}

          {% if is_granted('VIEW_MODULE', 'transactions') %}
          <a href="{{ path('admin_transactions') }}"
            class="flex items-center px-4 py-2.5 rounded-xl transition-all duration-200 group {{ app.request.get('_route') starts with 'admin_transactions' ? 'bg-white/20 text-white shadow-lg' : 'text-white/80 hover:bg-white/10 hover:text-white' }}">
            <i class="fa-solid fa-money-bill-transfer w-6 text-sm"></i>
            <span class="ml-3 text-sm font-medium italic">Flux & Frais Unifiés</span>
          </a>
          {% endif %}

          {% if is_granted('VIEW_MODULE', 'invoices') %}
          <a href="{{ path('admin_invoices') }}"
            class="flex items-center px-4 py-2.5 rounded-xl transition-all duration-200 group {{ app.request.get('_route') starts with 'admin_invoice' ? 'bg-white/20 text-white shadow-lg' : 'text-white/80 hover:bg-white/10 hover:text-white' }}">
            <i class="fa-solid fa-file-invoice w-6 text-sm"></i>
            <span class="ml-3 text-sm font-medium">Facturation</span>
          </a>
          {% endif %}
        </div>
      </div>
      {% endif %}

      {# 3. PÔLE CLIENTS #}
      {% if is_granted('VIEW_MODULE', 'users') or is_granted('VIEW_MODULE', 'support') or is_granted('VIEW_MODULE', 'broadcast') %}
      <div>
        <h3 class="px-4 text-[10px] font-bold text-green-300/60 uppercase tracking-widest mb-2">Pôle Clients</h3>
        <div class="space-y-1">
          {% if is_granted('VIEW_MODULE', 'users') %}
          <a href="{{ path('admin_users', {'group': 'clients'}) }}"
            class="flex items-center justify-between px-4 py-2.5 rounded-xl transition-all duration-200 group {{ app.request.get('_route') starts with 'admin_users' and app.request.query.get('group') != 'staff' ? 'bg-white/20 text-white shadow-lg' : 'text-white/80 hover:bg-white/10 hover:text-white' }}">
            <div class="flex items-center">
              <i class="fa-solid fa-users w-6 text-sm"></i>
              <span class="ml-3 text-sm font-medium">Annuaire Clients</span>
            </div>
            {{ render(controller('App\\Controller\\Admin\\DashboardAdminController::countPendingActivations')) }}
          </a>
          <a href="{{ path('admin_users', {'group': 'staff'}) }}"
            class="flex items-center px-4 py-2.5 rounded-xl transition-all duration-200 group {{ app.request.get('_route') starts with 'admin_users' and app.request.query.get('group') == 'staff' ? 'bg-white/20 text-white shadow-lg' : 'text-white/80 hover:bg-white/10 hover:text-white' }}">
            <i class="fa-solid fa-user-shield w-6 text-sm"></i>
            <span class="ml-3 text-sm font-medium">Gestion Équipe</span>
          </a>
          {% endif %}

          {% if is_granted('VIEW_MODULE', 'support') %}
          <a href="{{ path('admin_support') }}"
            class="flex items-center px-4 py-2.5 rounded-xl transition-all duration-200 group {{ app.request.get('_route') starts with 'admin_support' ? 'bg-white/20 text-white shadow-lg' : 'text-white/80 hover:bg-white/10 hover:text-white' }}">
            <i class="fa-solid fa-headset w-6 text-sm"></i>
            <span class="ml-3 text-sm font-medium">Support Client</span>
          </a>
          {% endif %}

          {% if is_granted('VIEW_MODULE', 'broadcast') %}
          <a href="{{ path('admin_broadcast') }}"
            class="flex items-center px-4 py-2.5 rounded-xl transition-all duration-200 group {{ app.request.get('_route') starts with 'admin_broadcast' ? 'bg-white/20 text-white shadow-lg' : 'text-white/80 hover:bg-white/10 hover:text-white' }}">
            <i class="fa-solid fa-bullhorn w-6 text-sm"></i>
            <span class="ml-3 text-sm font-medium">Broadcast</span>
          </a>
          {% endif %}
        </div>
      </div>
      {% endif %}

      {# 4. PÔLE SÉCURITÉ & SYSTÈME #}
      {% if is_granted('ROLE_SUPER_ADMIN') or is_granted('VIEW_MODULE', 'audit') or is_granted('VIEW_MODULE', 'settings') or is_granted('VIEW_MODULE', 'maintenance') %}
      <div>
        <h3 class="px-4 text-[10px] font-bold text-green-300/60 uppercase tracking-widest mb-2">Sécurité & Système</h3>
        <div class="space-y-1">
          {% if is_granted('ROLE_SUPER_ADMIN') %}
          <a href="{{ path('admin_reconciliation_index') }}"
            class="flex items-center px-4 py-2.5 rounded-xl transition-all duration-200 group {{ app.request.get('_route') starts with 'admin_reconciliation' ? 'bg-white/20 text-white shadow-lg border-l-4 border-red-500' : 'text-white/80 hover:bg-white/10 hover:text-white' }}">
            <i class="fa-solid fa-scale-balanced w-6 text-sm"></i>
            <span class="ml-3 text-sm font-bold">Audit de Cohérence</span>
          </a>
          <a href="{{ path('admin_permissions_index') }}"
            class="flex items-center px-4 py-2.5 rounded-xl transition-all duration-200 group {{ app.request.get('_route') starts with 'admin_permissions' ? 'bg-white/20 text-white shadow-lg border-l-4 border-amber-400' : 'text-white/80 hover:bg-white/10 hover:text-white' }}">
            <i class="fa-solid fa-shield-halved w-6 text-sm"></i>
            <span class="ml-3 text-sm font-bold">Gestion des Accès</span>
          </a>
          {% endif %}

          {% if is_granted('VIEW_MODULE', 'audit') %}
          <a href="{{ path('admin_audit_logs') }}"
            class="flex items-center px-4 py-2.5 rounded-xl transition-all duration-200 group {{ app.request.get('_route') starts with 'admin_audit' ? 'bg-white/20 text-white shadow-lg' : 'text-white/80 hover:bg-white/10 hover:text-white' }}">
            <i class="fa-solid fa-clipboard-list w-6 text-sm"></i>
            <span class="ml-3 text-sm font-medium">Journaux d'Audit</span>
          </a>
          {% endif %}

          {% if is_granted('VIEW_MODULE', 'settings') %}
          <a href="{{ path('admin_settings') }}"
            class="flex items-center px-4 py-2.5 rounded-xl transition-all duration-200 group {{ app.request.get('_route') starts with 'admin_settings' ? 'bg-white/20 text-white shadow-lg' : 'text-white/80 hover:bg-white/10 hover:text-white' }}">
            <i class="fa-solid fa-sliders w-6 text-sm"></i>
            <span class="ml-3 text-sm font-medium">Paramètres</span>
          </a>
          {% endif %}

          {% if is_granted('VIEW_MODULE', 'maintenance') %}
          <a href="{{ path('admin_maintenance') }}"
            class="flex items-center px-4 py-2.5 rounded-xl transition-all duration-200 group {{ app.request.get('_route') starts with 'admin_maintenance' ? 'bg-white/20 text-white shadow-lg' : 'text-white/80 hover:bg-white/10 hover:text-white' }}">
            <i class="fa-solid fa-wrench w-6 text-sm"></i>
            <span class="ml-3 text-sm font-medium">Santé & Maintenance</span>
          </a>
          {% endif %}
        </div>
      </div>
      {% endif %}
    </nav>

    <div class="p-4 border-t border-green-500/30">
      <a href="{{path('app_logout')}}"
        class="w-full inline-flex items-center justify-center gap-2 px-3 py-3 rounded-lg border border-white/30 hover:bg-white/10 text-white touch-target transition-all duration-200">
        <i class="fa-solid fa-right-from-bracket"></i> <span>Se déconnecter</span>
      </a>
      <p class="text-xs text-green-100 text-center mt-3">© <span id="year2"></span> Efa Smart Finance</p>
    </div>
  </aside>
</div>