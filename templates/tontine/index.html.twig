{% extends 'base.html.twig' %}

{% block title %}Créer une Tontine - EFA{% endblock %}

{% block body %}
<div class="min-h-screen bg-gray-50">
  <main class="max-w-2xl mx-auto px-4 py-8">
    <!-- En-tête -->
    <div class="mb-8 text-center">
      <h1 class="text-2xl font-bold text-gray-800 mb-2">Créer une nouvelle tontine</h1>
      <p class="text-gray-600">Choisissez le type qui correspond à vos revenus</p>
    </div>

    <!-- Indicateur de progression -->
    <div class="flex items-center mb-8">
      <div class="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
        <div id="progress" class="h-full bg-green-500 rounded-full transition-all duration-300" style="width: 33%"></div>
      </div>
      <div class="ml-4 text-sm text-green-600 font-medium">
        Étape <span id="stepNum">1</span>/3
      </div>
    </div>

    <!-- Carte unique -->
    <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
      <!-- ÉTAPE 1 : Type de tontine -->
      <div id="step1" class="step active">
        <h2 class="text-lg font-semibold text-gray-800 mb-6">Quel type de tontine ?</h2>
        
        <div class="space-y-4 mb-8">
          <!-- Tontine Journalière -->
          <label class="block tontine-type-card">
            <input type="radio" name="tontineType" value="daily" class="sr-only">
            <div class="tontine-card p-5 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-green-400 transition-all">
              <div class="flex items-start">
                <div class="flex-shrink-0 mr-4">
                  <div class="w-12 h-12 rounded-lg bg-blue-100 flex items-center justify-center">
                    <svg class="w-6 h-6 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                    </svg>
                  </div>
                </div>
                <div class="flex-1">
                  <div class="flex justify-between items-start">
                    <div>
                      <h3 class="font-bold text-gray-800"> Tontine Journalière</h3>
                      <p class="text-sm text-gray-600 mt-1">Versement chaque jour</p>
                    </div>
                    <div class="checkmark w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center">
                      <svg class="w-4 h-4 text-white opacity-0" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                      </svg>
                    </div>
                  </div>
                  <div class="mt-3 pt-3 border-t border-gray-100">
                    <div class="flex flex-wrap gap-2 mb-2">
                      <span class="px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded">Durée: 1-12 mois</span>
                      <span class="px-2 py-1 text-xs bg-gray-100 text-gray-700 rounded">Versement: quotidien</span>
                    </div>
                    <p class="text-sm text-gray-600">
                      <span class="font-medium">Pour qui:</span> Ceux qui gagnent de l'argent tous les jours (commerçants, vendeurs ambulants…)
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </label>

          <!-- Tontine Hebdomadaire -->
          <label class="block tontine-type-card">
            <input type="radio" name="tontineType" value="weekly" class="sr-only">
            <div class="tontine-card p-5 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-green-400 transition-all">
              <div class="flex items-start">
                <div class="flex-shrink-0 mr-4">
                  <div class="w-12 h-12 rounded-lg bg-green-100 flex items-center justify-center">
                    <svg class="w-6 h-6 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/>
                    </svg>
                  </div>
                </div>
                <div class="flex-1">
                  <div class="flex justify-between items-start">
                    <div>
                      <h3 class="font-bold text-gray-800"> Tontine Hebdomadaire</h3>
                      <p class="text-sm text-gray-600 mt-1">Versement chaque semaine</p>
                    </div>
                    <div class="checkmark w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center">
                      <svg class="w-4 h-4 text-white opacity-0" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                      </svg>
                    </div>
                  </div>
                  <div class="mt-3 pt-3 border-t border-gray-100">
                    <div class="flex flex-wrap gap-2 mb-2">
                      <span class="px-2 py-1 text-xs bg-green-100 text-green-700 rounded">Durée: 1-12 mois</span>
                      <span class="px-2 py-1 text-xs bg-gray-100 text-gray-700 rounded">Versement: hebdomadaire</span>
                    </div>
                    <p class="text-sm text-gray-600">
                      <span class="font-medium">Pour qui:</span> Ceux qui reçoivent des revenus chaque semaine (artisans, prestataires…)
                    </p>
                    <div class="mt-2 p-2 bg-yellow-50 border border-yellow-100 rounded">
                      <p class="text-xs text-yellow-700">
                        <span class="font-medium">Avantage:</span> Bon équilibre entre la tontine journalière et mensuelle
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </label>

          <!-- Tontine Mensuelle -->
          <label class="block tontine-type-card">
            <input type="radio" name="tontineType" value="monthly" class="sr-only">
            <div class="tontine-card p-5 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-green-400 transition-all">
              <div class="flex items-start">
                <div class="flex-shrink-0 mr-4">
                  <div class="w-12 h-12 rounded-lg bg-purple-100 flex items-center justify-center">
                    <svg class="w-6 h-6 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z"/>
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z" clip-rule="evenodd"/>
                    </svg>
                  </div>
                </div>
                <div class="flex-1">
                  <div class="flex justify-between items-start">
                    <div>
                      <h3 class="font-bold text-gray-800"> Tontine Mensuelle</h3>
                      <p class="text-sm text-gray-600 mt-1">Versement une fois par mois</p>
                    </div>
                    <div class="checkmark w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center">
                      <svg class="w-4 h-4 text-white opacity-0" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                      </svg>
                    </div>
                  </div>
                  <div class="mt-3 pt-3 border-t border-gray-100">
                    <div class="flex flex-wrap gap-2 mb-2">
                      <span class="px-2 py-1 text-xs bg-purple-100 text-purple-700 rounded">Durée: 3-12 mois</span>
                      <span class="px-2 py-1 text-xs bg-gray-100 text-gray-700 rounded">Versement: mensuel</span>
                    </div>
                    <p class="text-sm text-gray-600">
                      <span class="font-medium">Pour qui:</span> Les salariés ou ceux qui ont un revenu mensuel
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </label>
        </div>

        <div class="mt-8 p-4 bg-blue-50 border border-blue-100 rounded-lg">
          <p class="text-sm text-blue-700 flex items-start">
            <svg class="w-5 h-5 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
            </svg>
            <span>Vous pouvez créer jusqu'à <strong>3 tontines</strong> différentes selon vos besoins.</span>
          </p>
        </div>
      </div>

      <!-- ÉTAPE 2 : Configuration -->
      <div id="step2" class="step hidden">
        <div class="mb-6">
          <div class="flex items-center gap-3 mb-2">
            <div id="typeIcon" class="w-10 h-10 rounded-lg flex items-center justify-center bg-blue-100">
              <!-- Icône dynamique -->
              <span class="text-2xl"> <i class="fas fa-calendar"></i></span>
            </div>
            <div>
              <h2 class="text-lg font-semibold text-gray-800">Configurez votre tontine</h2>
              <p id="typeDescription" class="text-sm text-gray-600">Sélectionnez la durée et le montant</p>
            </div>
          </div>
        </div>

        <div class="space-y-6">
          <!-- Durée avec contraintes -->
<div class="w-full">
  <label for="duration" class="block text-sm font-medium text-gray-700 mb-2">
    Durée :
    <span id="months" class="text-green-600 font-semibold">3 mois</span>
  </label>

  <input
    type="number"
    id="duration"
    min="1"
    max="12"
    value="3"
    class="w-full appearance-none border border-gray-300 rounded-md px-3 py-2 text-sm
           focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500"
  >


  <p id="durationInfo" class="text-xs text-gray-400 mt-2"></p>
</div>


          <!-- Montant -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Montant par versement
            </label>
            <div class="flex">
              <span class="px-4 py-3 bg-gray-100 border border-r-0 rounded-l-lg text-gray-600">FCFA</span>
              <input type="number" 
                     id="amount" 
                     min="500" 
                     step="100"
                     class="flex-1 px-4 py-3 border rounded-r-lg focus:outline-none focus:border-green-500"
                     placeholder="Ex: 5000">
            </div>
            <p class="text-sm text-gray-500 mt-1">Minimum: 500 FCFA</p>
            
            <!-- Suggestions -->
            <div class="flex flex-wrap gap-2 mt-3">
              <button type="button" data-amount="500" class="amount-btn border-2 border-gray-300 px-4 py-2 rounded-lg hover:bg-gray-100 hover:text-gray-700 hover:border-gray-400">500</button>
              <button type="button" data-amount="1000" class="amount-btn border-2 border-gray-300 px-4 py-2 rounded-lg hover:bg-gray-100 hover:text-gray-700 hover:border-gray-400">1 000</button>
              <button type="button" data-amount="2000" class="amount-btn border-2 border-gray-300 px-4 py-2 rounded-lg hover:bg-gray-100 hover:text-gray-700 hover:border-gray-400">2 000</button>
              <button type="button" data-amount="5000" class="amount-btn border-2 border-gray-300 px-4 py-2 rounded-lg hover:bg-gray-100 hover:text-gray-700 hover:border-gray-400">5 000</button>
              <button type="button" data-amount="10000" class="amount-btn border-2 border-gray-300 px-4 py-2 rounded-lg hover:bg-gray-100 hover:text-gray-700 hover:border-gray-400">10 000</button>
            </div>
          </div>

          <!-- Date de début -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Date de début
            </label>
            <input type="date" 
                   id="startDate" 
                   class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:border-green-500">
            <p class="text-xs text-gray-500 mt-2">La tontine commencera à partir de cette date</p>
          </div>

          <!-- Prévisualisation -->
          <div id="preview" class="bg-green-50 border border-green-200 rounded-xl p-5 hidden">
            <h3 class="font-semibold text-green-800 mb-4 flex items-center">
              <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"/>
              </svg>
              Résumé de votre tontine
            </h3>
            
            <div class="grid grid-cols-2 gap-4 mb-4">
              <div class="text-center p-3 bg-white rounded-lg border">
                <div id="previewPoints" class="text-2xl font-bold text-green-600">--</div>
                <div class="text-sm text-gray-500">Versements</div>
              </div>
              <div class="text-center p-3 bg-white rounded-lg border">
                <div id="previewTotal" class="text-2xl font-bold text-green-600">--</div>
                <div class="text-sm text-gray-500">Total épargné</div>
              </div>
            </div>
            
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="text-gray-600">Montant/versement:</span>
                <span id="previewAmount" class="font-medium">--</span>
              </div>
              <div class="flex justify-between text-red-600">
                <span>Frais de service:</span>
                <span id="previewFees" class="font-medium">--</span>
              </div>
              <div class="pt-3 mt-3 border-t border-green-200">
                <div class="flex justify-between font-bold">
                  <span>Vous récupérez:</span>
                  <span id="previewNet" class="text-lg text-green-700">--</span>
                </div>
                <div>
                  <p class="text-xs text-right text-green-600 mt-1">Après paiement des frais de service</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ÉTAPE 3 : Confirmation -->
      <div id="step3" class="step hidden">
        <input type="hidden" id="tontine_csrf" value="{{ csrf_token('tontine_create') }}">
        <h2 class="text-lg font-semibold text-gray-800 mb-6">Dernière étape</h2>
        
        <!-- Carte récapitulative -->
        <div class="bg-gradient-to-br from-green-50 to-white rounded-xl border border-green-200 p-5 mb-6">
          <div class="text-center mb-5">
            <div id="confirmIcon" class="inline-flex items-center justify-center w-14 h-14 rounded-full bg-blue-100 text-blue-600 mb-3">
              <!-- Icône dynamique -->
            </div>
            <h3 class="font-bold text-green-800 text-lg">Votre tontine est prête</h3>
          </div>
          
          <div class="space-y-4">
            <!-- Type -->
            <div class="flex items-center justify-between p-3 bg-white rounded-lg border">
              <div class="flex items-center">
                <div class="w-10 h-10 rounded-lg flex items-center justify-center mr-3">
                  <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                  </svg>
                </div>
                <div>
                  <div class="text-sm text-gray-500">Type de tontine</div>
                  <div id="confirmType" class="font-bold">--</div>
                </div>
              </div>
            </div>
            
            <!-- Détails -->
            <div class="grid grid-cols-2 gap-3">
              <div class="p-3 bg-white rounded-lg border">
                <div class="text-sm text-gray-500">Durée</div>
                <div id="confirmDuration" class="font-bold text-lg">--</div>
              </div>
              <div class="p-3 bg-white rounded-lg border">
                <div class="text-sm text-gray-500">Versements</div>
                <div id="confirmPoints" class="font-bold text-lg">--</div>
              </div>
            </div>
            
            <!-- Montant -->
            <div class="p-4 bg-white rounded-lg border">
              <div class="flex justify-between items-center mb-2">
                <div>
                  <div class="text-sm text-gray-500">Montant par versement</div>
                  <div id="confirmAmount" class="text-xl font-bold text-green-700">--</div>
                </div>
              </div>
              <div class="pt-3 border-t">
                <div class="flex justify-between text-sm mb-1">
                  <span class="text-gray-600">Total épargné:</span>
                  <span id="confirmTotal" class="font-medium">--</span>
                </div>
                <div class="flex justify-between text-sm text-red-600 mb-1">
                  <span>Frais de service:</span>
                  <span id="confirmFees" class="font-medium">--</span>
                </div>
                <div class="flex justify-between font-bold text-lg mt-2 pt-2 border-t">
                  <span>Vous récupérez:</span>
                  <span id="confirmNet" class="text-green-700">--</span>
                </div>
                <div>
                  <p class="text-xs text-right text-green-600 mt-1">Après paiement des frais de service</p>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Note sur les frais 
          <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
            <p class="text-sm text-yellow-800">
               <strong>Note importante :</strong> Les frais correspondent exactement au montant d'un seul versement de votre tontine.
            </p>
          </div>-->
        </div>

        <!-- Nom de la tontine -->
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Donnez un nom à votre tontine
          </label>
          <input type="text" 
                 id="name" 
                 maxlength="30"
                 class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:border-green-500"
                 placeholder="Ex: Épargne vacances, Achat téléphone...">
          <div class="flex justify-between text-sm text-gray-500 mt-1">
            <span>Ce nom apparaîtra dans votre tableau de bord</span>
            <span id="charCount">0/30</span>
          </div>
        </div>

        <!-- Conditions -->
        <label class="flex items-start mb-6">
          <input type="checkbox" id="terms" class="mt-1 mr-2">
          <span class="text-sm text-gray-700">
            Je comprends et accepte que les frais de service équivalent à un versement, 
            et j'accepte les <a href="#" class="text-green-600 hover:underline">conditions générales</a>.
          </span>
        </label>
      </div>

      <!-- Boutons de navigation -->
      <div class="flex justify-between pt-6 border-t">
        <button id="btnBack" class="btn-secondary hidden border-2 border-gray-300 px-4 py-2 rounded-lg hover:bg-gray-100 hover:text-gray-700 hover:border-gray-400">
          ← Retour
        </button>
        
        <button id="btnNext" class="btn-green-700 ml-auto  border-2 border-green-600 px-4 py-2 rounded-lg hover:bg-green-700 hover:text-white hover:border-green-700" disabled>
          Continuer →
        </button>
        
        <button id="btnCreate" class="btn-success hidden border-2 border-green-600 px-4 py-2 rounded-lg hover:bg-green-700 hover:text-white hover:border-green-700" disabled>
          Créer ma tontine
        </button>
      </div>
    </div>

    <!-- Informations -->
    <div class="text-center space-y-1 text-sm text-gray-500">
      <p>Vous pouvez avoir jusqu'à 3 tontines actives</p>
      <p>Toutes vos épargnes sont 100% sécurisées</p>
    </div>
    <!-- Modal de chargement -->
    <div id="loadingModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="bg-white p-6 rounded-lg shadow-xl text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-500 mx-auto mb-4"></div>
        <p class="text-gray-700">Traitement en cours...</p>
      </div>
    </div>

    <!-- Modal de succès -->
    <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="bg-white p-6 rounded-lg shadow-xl text-center">
        <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
        </div>
        <h3 class="text-lg font-medium text-gray-900 mb-2">Succès !</h3>
        <p class="text-gray-700 mb-4">Votre tontine a été créée avec succès.</p>
        <p class="text-sm text-gray-500">Redirection en cours...</p>
      </div>
    </div>
  </main>
</div>

<script>
// Données
let data = {
  type: null,
  amount: null,
  duration: 3,
  startDate: new Date().toISOString().split('T')[0],
  name: ''
};

let step = 1;

// Informations des types de tontines
const tontineTypes = {
  daily: {
    name: 'Tontine Journalière',
    icon: '',
    color: 'blue',
    minDuration: 1,
    maxDuration: 12,
    description: 'Versement chaque jour',
    pointsPerMonth: 31
  },
  weekly: {
    name: 'Tontine Hebdomadaire',
    icon: '',
    color: 'green',
    minDuration: 1,
    maxDuration: 12,
    description: 'Versement chaque semaine',
    pointsPerMonth: 4
  },
  monthly: {
    name: 'Tontine Mensuelle',
    icon: '',
    color: 'purple',
    minDuration: 1,
    maxDuration: 12,
    description: 'Versement une fois par mois',
    pointsPerMonth: 1
  }
};

// Formater la monnaie
function formatCurrency(amount) {
  if (!amount) return '--';
  return new Intl.NumberFormat('fr-FR').format(amount) + ' FCFA';
}

// Calculer les points selon le type
function calculatePoints() {
  if (!data.type || !data.duration) return 0;
  const type = tontineTypes[data.type];
  return data.duration * type.pointsPerMonth;
}

// Mettre à jour l'interface étape 2
function updateStep2() {
  if (!data.type) return;
  
  const type = tontineTypes[data.type];
  
  // Mettre à jour l'icône et description
  const iconDiv = document.getElementById('typeIcon');
  if (iconDiv) {
    const colorClass = `bg-${type.color}-100`;
    const textClass = `text-${type.color}-600`;
    iconDiv.className = `w-10 h-10 rounded-lg flex items-center justify-center ${colorClass} ${textClass}`;
    iconDiv.innerHTML = `<span class="text-lg">${type.icon}</span>`;
  }
  
  const typeDescription = document.getElementById('typeDescription');
  if (typeDescription) {
    typeDescription.textContent = type.description;
  }
  
  // Mettre à jour le slider de durée
  const durationInput = document.getElementById('duration');
  if (durationInput) {
    durationInput.min = type.minDuration;
    durationInput.max = type.maxDuration;
    
    // Ajuster la valeur si hors limites
    if (data.duration < type.minDuration) {
      data.duration = type.minDuration;
      durationInput.value = type.minDuration;
    } else if (data.duration > type.maxDuration) {
      data.duration = type.maxDuration;
      durationInput.value = type.maxDuration;
    }
  }
  
  const monthsSpan = document.getElementById('months');
  if (monthsSpan) {
    monthsSpan.textContent = `${data.duration} mois`;
  }
  
  const minDuration = document.getElementById('minDuration');
  const maxDuration = document.getElementById('maxDuration');
  if (minDuration) minDuration.textContent = `${type.minDuration} mois`;
  if (maxDuration) maxDuration.textContent = `${type.maxDuration} mois`;
  
  // Info durée
  const durationInfo = document.getElementById('durationInfo');
  if (durationInfo) {
    if (data.type === 'monthly') {
      durationInfo.textContent = '⚠️ La tontine mensuelle nécessite une durée minimale de 3 mois';
      durationInfo.className = 'text-xs text-yellow-600 mt-2';
    } else {
      durationInfo.textContent = '';
    }
  }
}

// Mettre à jour la prévisualisation
function updatePreview() {
  const preview = document.getElementById('preview');
  const points = calculatePoints();
  const total = points * data.amount;
  
  if (data.amount >= 500 && data.type) {
    preview.classList.remove('hidden');
    
    // Les frais = montant d'un versement
    const fees = Math.round(calculateFees());
    const net = total;
    
    // Mettre à jour les valeurs
    const previewPoints = document.getElementById('previewPoints');
    const previewTotal = document.getElementById('previewTotal');
    const previewAmount = document.getElementById('previewAmount');
    const previewFees = document.getElementById('previewFees');
    const previewNet = document.getElementById('previewNet');
    
    if (previewPoints) previewPoints.textContent = points;
    if (previewTotal) previewTotal.textContent = formatCurrency(total);
    if (previewAmount) previewAmount.textContent = formatCurrency(data.amount);
    if (previewFees) previewFees.textContent = formatCurrency(fees);
    if (previewNet) previewNet.textContent = formatCurrency(net);
  } else {
    preview.classList.add('hidden');
  }
}
function calculateFees() {
  if (!data.type || !data.amount || !data.duration) return 0;

  const amount = data.amount;
  const duration = data.duration;

  switch (data.type) {
    case 'daily':
      // 1000/jour → 1 mois = 1000 | 3 mois = 3000
      return amount * duration;

    case 'weekly':
      // (montant × 4 / 30) × nombre de mois
      return (amount * 4 / 30) * duration;

    case 'monthly':
      // montant / 30 × nombre de mois
      return (amount / 30) * duration;

    default:
      return 0;
  }
}


// Mettre à jour le récapitulatif final
function updateSummary() {
  if (!data.type) return;
  
  const type = tontineTypes[data.type];
  const points = calculatePoints();
  const total = points * data.amount;
  const fees = Math.round(calculateFees()); // Frais = montant d'un versement
  const net = total ;
  
  // Mettre à jour l'icône
  const iconDiv = document.getElementById('confirmIcon');
  if (iconDiv) {
    const colorClass = `bg-${type.color}-100`;
    const textClass = `text-${type.color}-600`;
    iconDiv.className = `inline-flex items-center justify-center w-14 h-14 rounded-full ${colorClass} ${textClass} mb-3`;
    iconDiv.innerHTML = `<span class="text-2xl">${type.icon}</span>`;
  }
  
  // Mettre à jour les valeurs
  const confirmType = document.getElementById('confirmType');
  const confirmDuration = document.getElementById('confirmDuration');
  const confirmPoints = document.getElementById('confirmPoints');
  const confirmAmount = document.getElementById('confirmAmount');
  const confirmTotal = document.getElementById('confirmTotal');
  const confirmFees = document.getElementById('confirmFees');
  const confirmNet = document.getElementById('confirmNet');
  
  if (confirmType) confirmType.textContent = type.name;
  if (confirmDuration) confirmDuration.textContent = `${data.duration} mois`;
  if (confirmPoints) confirmPoints.textContent = `${points} versements`;
  if (confirmAmount) confirmAmount.textContent = formatCurrency(data.amount);
  if (confirmTotal) confirmTotal.textContent = formatCurrency(total);
  if (confirmFees) confirmFees.textContent = formatCurrency(fees);
  if (confirmNet) confirmNet.textContent = formatCurrency(net);
}

// Mettre à jour l'interface
function updateUI() {
  // Mettre à jour la progression
  const progress = document.getElementById('progress');
  if (progress) {
    progress.style.width = `${step * 33}%`;
  }
  
  const stepNum = document.getElementById('stepNum');
  if (stepNum) {
    stepNum.textContent = step;
  }
  
  // Afficher/masquer les étapes
  document.querySelectorAll('.step').forEach(el => {
    el.classList.add('hidden');
    el.classList.remove('active');
  });
  
  const currentStep = document.getElementById(`step${step}`);
  if (currentStep) {
    currentStep.classList.remove('hidden');
    currentStep.classList.add('active');
  }
  
  // Gérer les boutons
  const btnBack = document.getElementById('btnBack');
  const btnNext = document.getElementById('btnNext');
  const btnCreate = document.getElementById('btnCreate');
  
  if (btnBack) btnBack.classList.toggle('hidden', step === 1);
  if (btnNext) btnNext.classList.toggle('hidden', step === 3);
  if (btnCreate) btnCreate.classList.toggle('hidden', step !== 3);
  
  // Désactiver bouton si nécessaire
  if (step === 1) {
    if (btnNext) btnNext.disabled = !data.type;
  } else if (step === 2) {
    const type = data.type ? tontineTypes[data.type] : null;
    const validDuration = type && data.duration >= type.minDuration && data.duration <= type.maxDuration;
    if (btnNext) btnNext.disabled = !(data.amount >= 500 && validDuration);
  } else if (step === 3) {
    const nameValid = data.name && data.name.trim().length > 0;
    const termsChecked = document.getElementById('terms') ? document.getElementById('terms').checked : false;
    if (btnCreate) btnCreate.disabled = !(nameValid && termsChecked);
  }
}

// Gérer la sélection des cartes
function setupTontineCards() {
  document.querySelectorAll('.tontine-type-card').forEach(card => {
    const radio = card.querySelector('input[type="radio"]');
    const checkmark = card.querySelector('.checkmark');
    const cardDiv = card.querySelector('.tontine-card');
    
    card.addEventListener('click', () => {
      // Désélectionner toutes les cartes
      document.querySelectorAll('.tontine-type-card').forEach(c => {
        const cRadio = c.querySelector('input[type="radio"]');
        const cCheckmark = c.querySelector('.checkmark');
        const cCard = c.querySelector('.tontine-card');
        
        cRadio.checked = false;
        if (cCheckmark) {
          cCheckmark.classList.remove('bg-green-500', 'border-green-500');
          cCheckmark.querySelector('svg').classList.add('opacity-0');
        }
        if (cCard) {
          cCard.classList.remove('border-green-500', 'bg-green-50');
        }
      });
      
      // Sélectionner cette carte
      radio.checked = true;
      if (checkmark) {
        checkmark.classList.add('bg-green-500', 'border-green-500');
        checkmark.querySelector('svg').classList.remove('opacity-0');
      }
      if (cardDiv) {
        cardDiv.classList.add('border-green-500', 'bg-green-50');
      }
      
      data.type = radio.value;
      updateUI();
      if (step === 1) {
        updateStep2();
        updatePreview();
      }
    });
  });
}

// Initialiser les événements
document.addEventListener('DOMContentLoaded', function() {
  // Initialiser les cartes
  setupTontineCards();
  
  // Suggestions de montant
  document.querySelectorAll('.amount-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const amount = parseInt(this.dataset.amount);
      const amountInput = document.getElementById('amount');
      if (amountInput) {
        amountInput.value = amount;
        data.amount = amount;
        updateUI();
        updatePreview();
      }
    });
  });
  
  // Montant
  const amountInput = document.getElementById('amount');
  if (amountInput) {
    amountInput.addEventListener('input', function() {
      data.amount = parseInt(this.value) || 0;
      updateUI();
      updatePreview();
    });
  }
  
  // Durée
  const durationInput = document.getElementById('duration');
  if (durationInput) {
    durationInput.addEventListener('input', function() {
      data.duration = parseInt(this.value);
      const monthsSpan = document.getElementById('months');
      if (monthsSpan) {
        monthsSpan.textContent = `${data.duration} mois`;
      }
      updateUI();
      updatePreview();
    });
  }
  
  // Date
  const today = new Date().toISOString().split('T')[0];
  const dateInput = document.getElementById('startDate');
  if (dateInput) {
    dateInput.min = today;
    dateInput.value = today;
    dateInput.addEventListener('change', function() {
      data.startDate = this.value;
    });
  }
  
  // Nom et compteur de caractères
  const nameInput = document.getElementById('name');
  const charCount = document.getElementById('charCount');
  if (nameInput && charCount) {
    nameInput.addEventListener('input', function() {
      data.name = this.value;
      charCount.textContent = `${this.value.length}/30`;
      updateUI();
    });
  }
  
  // Conditions
  const termsCheckbox = document.getElementById('terms');
  if (termsCheckbox) {
    termsCheckbox.addEventListener('change', updateUI);
  }
  
  // Navigation
  const btnNext = document.getElementById('btnNext');
  if (btnNext) {
    btnNext.addEventListener('click', function() {
      if (step === 1 && !data.type) return;
      if (step === 2) {
        const type = tontineTypes[data.type];
        if (!data.amount || data.amount < 500) return;
        if (data.duration < type.minDuration || data.duration > type.maxDuration) return;
      }
      
      step++;
      if (step === 2) {
        updateStep2();
        updatePreview();
      } else if (step === 3) {
        updateSummary();
      }
      updateUI();
    });
  }
  
  const btnBack = document.getElementById('btnBack');
  if (btnBack) {
    btnBack.addEventListener('click', function() {
      step--;
      updateUI();
    });
  }
  
  // Création
  const btnCreate = document.getElementById('btnCreate');
  if (btnCreate) {
    btnCreate.addEventListener('click', async function() {
      if (!data.name.trim() || !document.getElementById('terms').checked) return;
      
      // Vérifier d'abord si l'utilisateur peut créer une nouvelle tontine
      try {
        const response = await fetch('{{ path('app_tontine_count') }}');
        const result = await response.json();
        
        if (result.count >= 3) {
          alert('Vous avez atteint le nombre maximum de tontines actives (3).');
          return;
        }
      } catch (error) {
        console.error('Erreur lors de la vérification des tontines :', error);
      }
      
      // Animation de chargement
      const btn = this;
      const originalText = btn.innerHTML;
      btn.innerHTML = '<span class="animate-pulse">Création en cours...</span>';
      btn.disabled = true;
      
      // Afficher le modal de chargement
      const loadingModal = document.getElementById('loadingModal');
      if (loadingModal) loadingModal.classList.remove('hidden');
      
      try {
        const csrfToken = document.getElementById('tontine_csrf')?.value;
        if (!csrfToken) {
          throw new Error('Token de sécurité manquant');
        }

        const requestData = {
          name: data.name,
          amount: parseFloat(data.amount),
          period: data.type,
          duration: parseInt(data.duration),
          startDate: data.startDate || new Date().toISOString().split('T')[0],
          _token: csrfToken
        };
        
        const response = await fetch('{{ path("app_tontine_create") }}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRF-TOKEN': csrfToken
          },
          credentials: 'same-origin',
          body: JSON.stringify(requestData)
        });
        
        const result = await response.json();
        
        // Cacher le modal de chargement s'il existe
        const loadingModal = document.getElementById('loadingModal');
        if (loadingModal) loadingModal.classList.add('hidden');
        
        if (response.ok && result.success) {
          // Afficher le modal de succès s'il existe
          const successModal = document.getElementById('successModal');
          if (successModal) {
            successModal.classList.remove('hidden');
            
            // Redirection après 3 secondes
            setTimeout(() => {
              window.location.href = '{{ path("app_dashboard") }}';
            }, 3000);
          } else {
            // Si le modal de succès n'existe pas, rediriger immédiatement
            window.location.href = '{{ path("app_dashboard") }}';
          }
          
        } else {
          alert(result.message || 'Une erreur est survenue.');
          btn.innerHTML = originalText;
          btn.disabled = false;
        }
        
      } catch (error) {
        console.error('Erreur:', error);
        const loadingModal = document.getElementById('loadingModal');
        if (loadingModal) loadingModal.classList.add('hidden');
        
        let errorMessage = 'Erreur de connexion. Veuillez réessayer.';
        if (error.message) {
          errorMessage = error.message;
        }
        alert(errorMessage);
        
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    });
  }
  
  // Mettre à jour l'interface initiale
  updateUI();
});

</script>

<style>
/* Styles */
.tontine-card {
  transition: all 0.2s ease;
}

.tontine-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
}

.duration-slider {
  height: 6px;
  border-radius: 3px;
  background: #e5e7eb;
  outline: none;
}

.duration-slider::-webkit-slider-thumb {
  width: 22px;
  height: 22px;
  border-radius: 50%;
  background: #10b981;
  cursor: pointer;
  border: 3px solid white;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  transition: background 0.2s;
}

.duration-slider::-webkit-slider-thumb:hover {
  background: #059669;
}

.amount-btn {
  @apply px-3 py-2 text-sm border border-gray-300 rounded-lg hover:border-green-500 hover:text-green-600 hover:bg-green-50 transition-colors;
}

.btn-green-700 {
  @apply px-6 py-3 bg-green-500 text-white font-medium rounded-lg hover:bg-green-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed;
}

.btn-secondary {
  @apply px-6 py-3 border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition-colors;
}

.btn-success {
  @apply px-6 py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed shadow-sm hover:shadow;
}

.step {
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Couleurs pour les types */
.bg-blue-100 { background-color: #dbeafe !important; }
.text-blue-600 { color: #2563eb !important; }
.bg-green-100 { background-color: #d1fae5 !important; }
.text-green-600 { color: #059669 !important; }
.bg-purple-100 { background-color: #f3e8ff !important; }
.text-purple-600 { color: #7c3aed !important; }

/* Animation pour le checkmark */
.checkmark {
  transition: all 0.2s ease;
}

.checkmark svg {
  transition: opacity 0.2s ease;
}
</style>
{% endblock %}