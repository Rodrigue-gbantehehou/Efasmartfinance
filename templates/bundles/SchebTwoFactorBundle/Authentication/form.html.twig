{% extends 'base.html.twig' %}

{% block header %}{% endblock %}
{% block footer %}{% endblock %}
{% block cookie_banner %}{% endblock %}

{% block title %}Vérification de Sécurité{% endblock %}

{% block stylesheets %}
{{ parent() }}
<style>
    @keyframes slideUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .animate-slide-up { animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
</style>
{% endblock %}

{% block body %}
<div class="min-h-screen bg-gradient-to-br from-green-700 to-green-900 flex items-center justify-center p-4">
    <div class="max-w-md w-full animate-slide-up">
        <!-- Logo/Header -->
        <div class="text-center mb-8">
            <div class="w-20 h-20 bg-yellow-500 rounded-[2rem] flex items-center justify-center mx-auto mb-4 shadow-xl shadow-yellow-200/50">
                <i class="fas fa-shield-alt text-green-700 text-3xl"></i>
            </div>
            <h1 class="text-3xl font-black text-white tracking-tight">Vérification 2FA</h1>
            <p class="text-white mt-2 font-medium">Protégez votre compte avec un code de sécurité</p>
        </div>

        <div class="bg-white rounded-[2.5rem] shadow-2xl shadow-slate-200/60 p-8 border border-white">
            {% if app.user %}
                <div class="flex items-center space-x-4 p-4 bg-slate-50 rounded-2xl mb-8 border border-slate-100">
                    <div class="w-12 h-12 rounded-xl bg-yellow-100 flex items-center justify-center text-green-700 font-bold text-lg">
                        {{ app.user.firstname|first|upper }}{{ app.user.lastname|first|upper }}
                    </div>
                    <div class="min-w-0">
                        <p class="text-sm font-bold text-white truncate">{{ app.user.firstname }} {{ app.user.lastname }}</p>
                        <p class="text-xs text-slate-500 truncate">{{ app.user.email ?: app.user.uuid }}</p>
                    </div>
                </div>
            {% endif %}

            {% if authenticationError %}
                <div class="p-4 bg-red-50 text-red-700 rounded-2xl border border-red-100 mb-8 flex items-start space-x-3 text-sm animate-pulse">
                    <i class="fas fa-exclamation-circle mt-0.5"></i>
                    <p class="font-semibold">{{ authenticationError|trans }}</p>
                </div>
            {% endif %}

            <form method="post" action="{{ path('2fa_login_check') }}" class="space-y-8">
                <div class="space-y-4">
                    <label for="_auth_code" class="block text-center text-xs font-black uppercase tracking-[0.2em] text-slate-400">
                        Saisissez votre code à 6 chiffres
                    </label>
                    <input type="text" 
                           id="_auth_code" 
                           name="_auth_code" 
                           maxlength="6" 
                           pattern="[0-9]{6}" 
                           required 
                           autofocus
                           placeholder="······"
                           autocomplete="one-time-code"
                           class="w-full text-center text-5xl font-black py-6 bg-slate-50 border-2 border-slate-50 rounded-3xl focus:border-yellow-500 focus:bg-white focus:ring-[12px] focus:ring-yellow-50 focus:placeholder-transparent transition-all outline-none tracking-[0.3em] text-slate-800 placeholder:text-slate-200">
                    
                    <p class="text-center text-xs text-slate-400 font-medium">
                        <i class="fas fa-envelope-open-text mr-1 text-yellow-500"></i>
                        Un code a été envoyé à votre adresse e-mail
                    </p>
                </div>

                <div class="space-y-4">
                    <button type="submit" id="verifyBtn"
                            class="w-full bg-green-700 hover:bg-yellow-500 hover:text-green-900 text-white font-black py-5 rounded-3xl transition-all shadow-xl shadow-green-900/20 active:scale-[0.98] flex items-center justify-center space-x-3">
                        <span>Vérifier l'identité</span>
                        <i class="fas fa-chevron-right text-xs"></i>
                    </button>
                    
                    <a href="{{ path('app_logout') }}" class="block text-center text-sm font-bold text-slate-400 hover:text-slate-600 transition-colors py-2">
                        Annuler la connexion
                    </a>
                </div>

                <input type="hidden" name="_csrf_token" value="{{ csrf_token('two_factor') }}">
            </form>
        </div>

        <div class="mt-8 text-center px-4">
            <div class="inline-flex items-center space-x-3 bg-white/60 backdrop-blur-sm py-2 px-4 rounded-full border border-white text-xs text-slate-500 font-semibold shadow-sm">
                <span class="flex h-2 w-2 rounded-full bg-yellow-500 animate-pulse"></span>
                <span>Code de sécurité à 6 chiffres</span>
            </div>
        </div>
    </div>
</div>

<script>
let timeLeft = 30;
const timerEl = document.getElementById('timer');

function updateTimer() {
    timerEl.textContent = timeLeft + 's';
    if (timeLeft <= 0) {
        timeLeft = 30;
    } else {
        timeLeft--;
    }
}

setInterval(updateTimer, 1000);

// Auto-format input
const codeInput = document.getElementById('_auth_code');
if (codeInput) {
    codeInput.addEventListener('input', function(e) {
        this.value = this.value.replace(/[^0-9]/g, '').slice(0, 6);
        if (this.value.length === 6) {
            // Optionnel : auto-soumission
            // this.form.submit();
        }
    });
}

const form = document.querySelector('form');
form?.addEventListener('submit', () => {
    const btn = document.getElementById('verifyBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-circle-notch animate-spin text-xl"></i>';
});
</script>
{% endblock %}
