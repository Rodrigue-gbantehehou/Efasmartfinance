<!DOCTYPE html>
<html lang="fr">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Carte Tontine - Efa Smart Finance</title>
		<script src="https://cdn.tailwindcss.com"></script>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
		<style>
			@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700 &display=swap');:root {
				--green-700-color: #008040;
				--green-700-dark: #059669;
				--secondary-color: #3B82F6;
			}

			body {
				font-family: 'Poppins', sans-serif;
				background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
				min-height: 100vh;
				color: #1f2937;
			}

			.logo {
				filter: brightness(0) invert(1);
				opacity: 0.9;
			}

			.glass-card {
				background: rgba(255, 255, 255, 0.9);
				backdrop-filter: blur(10px);
				border: 1px solid rgba(255, 255, 255, 0.2);
			}

			.shadow-soft {
				box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
			}

			.shadow-hard {
				box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
			}

			.gradient-green-700 {
				background: linear-gradient(135deg, var(--green-700-color) 0%, var(--green-700-dark) 100%);
			}

			.gradient-secondary {
				background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
			}

			.hover-lift {
				transition: transform 0.2s ease, box-shadow 0.2s ease;
			}

			.hover-lift:hover {
				transform: translateY(-2px);
				box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
			}

			.point-grid {
				display: grid;
				grid-template-columns: repeat(auto-fill, minmax(45px, 1fr));
				gap: 8px;
			}

			@media(min-width: 768px) {
				.point-grid {
					grid-template-columns: repeat(14, minmax(45px, 1fr));
				}
			}

			.animate-pulse {
				animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
			}

			@keyframes pulse {
				0,
				100% {
					opacity: 1;
				}
				50% {
					opacity: 0.5;
				}
			}

			.print-only {
				display: none;
			}

			@media print {
				.no-print {
					display: none !important;
				}

				.print-only {
					display: block !important;
				}

				body {
					background: white !important;
					-webkit-print-color-adjust: exact;
					print-color-adjust: exact;
				}

				.card {
					break-inside: avoid;
					page-break-inside: avoid;
				}
			}
		</style>
	</head>
	<body
		class="flex flex-col min-h-screen">
		<!-- Header -->
		<div class="w-full bg-gradient-to-br from-green-500 to-green-700">
			<div class="max-w-7xl mx-auto py-6 px-4 md:px-6">
				<div class="flex flex-col md:flex-row justify-between items-center gap-4">
					<div>
						<h1 class="text-3xl font-bold text-white">Efa Smart Finance</h1>
						<p class="text-white">Carte Membre Tontine</p>
					</div>
					<div class="flex items-center gap-4">
						<div class="text-right hidden md:block">
							<p class="text-sm text-white">Membre depuis</p>
							<p class="font-medium text-white">{{ tontine.utilisateur.createdAt|date('d/m/Y') }}</p>
						</div>
					</div>
				</div>
			</div>
		</div>
		{% set interval = tontine.frequency == 'monthly' ? 'months' : 
                                                            (tontine.frequency == 'weekly' ? 'weeks' : 'days') %}
		<!-- Main Content - Centré verticalement et horizontalement -->
		<div class="flex-grow flex items-center justify-center py-8 px-4">
			<div
				class="w-full max-w-7xl mx-auto">
				<!-- Grid Container centré -->
				<div
					class="flex flex-col lg:flex-row justify-center items-center lg:items-start gap-8 lg:gap-12">
					<!-- Left Column - Tontine Card -->
					<div
						class="w-full lg:w-2/3 max-w-4xl">
						<!-- Tontine Status Card -->
						<div class="{% if tontine.statut == 'completed' %}bg-gradient-to-r from-red-700 via-red-600 to-red-700{% else %}gradient-green-700{% endif %} rounded-3xl shadow-hard overflow-hidden relative">
							<!-- Badge Clôturée -->
							{% if tontine.statut == 'completed' %}
								<div class="absolute top-4 right-4 z-10">
									<span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800">
										<i class="fas fa-times-circle mr-1"></i> Clôturée
									</span>
								</div>
							{% endif %}
							<div class="p-6 md:p-8">
								<div class="flex flex-col md:flex-row justify-between items-start gap-6">
									<div class="flex-1">
										<div class="flex items-center gap-4">
											<div class="h-14 w-14 rounded-2xl bg-white/20 backdrop-blur-sm flex items-center justify-center">
												<i class="{% if tontine.statut == 'completed' %}fas fa-lock{% else %}fas fa-piggy-bank{% endif %} text-2xl text-white"></i>
											</div>
											<div>
												<h2 class="text-xl md:text-3xl font-bold text-white">{{ tontine.name }}</h2>
												{% if tontine.statut == 'completed' %}
													<p class="text-red-100 text-sm mt-1">Clôturée le {{ tontine.endedAt ? tontine.endedAt|date('d/m/Y') : '' }}</p>
												{% endif %}
											</div>
										</div>
									</div>
								</div>
							</div>

							<!-- Progress Section -->
							<div class="bg-white/10 backdrop-blur-sm p-6 md:p-8">
								<div class="text-center mb-6">
									<h3 class="text-xl font-bold text-white mb-3">{% if tontine.statut == 'completed' %}Tontine clôturée{% else %}Progression des points{% endif %}</h3>
									<div class="flex items-center justify-center gap-4">
										<div class="text-white">
											<span class="font-bold text-2xl">{{ tontine.paidPoints|default(0) }}</span>
											<span class="{% if tontine.statut == 'completed' %}text-red-100{% else %}text-green-100{% endif %}">/{{ tontine.totalPoints }}
												points</span>
										</div>
										<div class="w-32 h-3 bg-white/30 rounded-full overflow-hidden">
											<div class="h-full {% if tontine.statut == 'completed' %}bg-gradient-to-r from-red-400 to-red-500{% else %}bg-gradient-to-r from-yellow-400 to-yellow-300{% endif %} transition-all duration-500" style="width: {{ ((tontine.paidPoints|default(0) / tontine.totalPoints) * 100)|round }}%"></div>
										</div>
									</div>
								</div>

								<!-- Points Grid -->
								<div class="point-grid mb-6">
									{% for point in 1..tontine.totalPoints %}
										{% set isPaid = point <= (tontine.paidPoints|default(0)) %}
										{% set isCurrent = point == (tontine.paidPoints|default(0)) + 1 %}
										{% set pointDueDate = tontine.startDate|date_modify('+' ~ (point-1) ~ ' ' ~ interval) %}
										{% set isMissed = pointDueDate < date('now') and not isPaid %}

										<div class="relative group">
											<div class="aspect-square border-2
												                                            {% if isPaid %}border-green-500 bg-green-100 text-green-800
												                                            {% elseif isMissed %}border-red-500 bg-red-100 text-red-800
												                                            {% elseif isCurrent %}border-yellow-500 bg-yellow-100 text-yellow-800
												                                            {% else %}border-gray-300 bg-white text-gray-700{% endif %}
												                                            rounded-xl flex flex-col items-center justify-center cursor-pointer hover-lift" title="Point #{{ point }} - Échéance: {{ pointDueDate|date('d/m/Y') }}">

												<div class="text-lg font-bold">{{ point }}</div>
												<div class="text-xs">
													{% if isPaid %}
														<i class="fas fa-check-circle text-green-600"></i>
													{% elseif isMissed %}
														<i class="fas fa-exclamation-triangle text-red-600"></i>
													{% elseif isCurrent %}
														<i class="fas fa-clock text-yellow-600"></i>
													{% else %}
														<i class="far fa-circle text-gray-400"></i>
													{% endif %}
												</div>
											</div>

											{% if isCurrent and tontine.statut == 'active' %}
												<div class="absolute -top-2 -right-2 bg-gradient-to-r from-yellow-500 to-yellow-600 text-white text-xs px-2 py-1 rounded-full shadow-lg animate-pulse">
													<i class="fas fa-bolt"></i>
												</div>
											{% endif %}
										</div>
									{% endfor %}
								</div>

								<!-- Legend -->
								<div class="flex flex-wrap justify-center gap-4 text-sm">
									<div class="flex items-center gap-2">
										<div class="w-3 h-3 rounded-full bg-green-500"></div>
										<span class="text-green-100">Payé</span>
									</div>
									<div class="flex items-center gap-2">
										<div class="w-3 h-3 rounded-full bg-yellow-500"></div>
										<span class="text-green-100">À payer</span>
									</div>
									<div class="flex items-center gap-2">
										<div class="w-3 h-3 rounded-full bg-red-500"></div>
										<span class="text-green-100">En retard</span>
									</div>
									<div class="flex items-center gap-2">
										<div class="w-3 h-3 rounded-full bg-gray-300"></div>
										<span class="text-green-100">À venir</span>
									</div>
								</div>
							</div>
						</div>
					</div>

				<!-- Right Column - Status Card -->
<div class="w-full lg:w-1/3 max-w-md">
    <!-- Tontine Status -->
    {% set totalAPayer = tontine.totalPoints * tontine.amountPerPoint %}
    {% set is_completed = tontine.totalpay == totalAPayer %}
	{% set montantARetirer = totalAPayer * 0.1 %}
    
    {% if is_completed %}
        <!-- Tontine Completed State -->
		{%  if tontine.statut != 'completed'  %}
		
        <div class="glass-card rounded-2xl p-6 shadow-hard h-full border-2 border-green-500">
            <div class="flex items-center gap-3 mb-6">
                <div class="h-12 w-12 rounded-xl bg-gradient-to-r from-green-500 to-emerald-600 flex items-center justify-center">
                    <i class="fas fa-trophy text-white text-lg"></i>
                </div>
                <div>
                    <h3 class="font-semibold text-gray-900 text-xl">Tontine Terminée</h3>
                    <p class="text-green-600 text-sm font-medium">Félicitations !</p>
                </div>
            </div>
            
            <!-- Completion Stats -->
            <div class="text-center mb-8">
                <div class="text-4xl font-bold text-green-700 mb-4">
                    {{ totalAPayer|number_format(0, ',', ' ') }} F CFA
                </div>
                <div class="text-lg text-gray-700 mb-4">
                    <i class="fas fa-check-circle text-green-500 mr-2"></i>
                    Objectif atteint à 100%
                </div>
                
                <!-- Progress Circle -->
                <div class="relative inline-flex items-center justify-center mb-6">
                    <svg class="w-24 h-24" viewBox="0 0 36 36">
                        <path d="M18 2.0845
                            a 15.9155 15.9155 0 0 1 0 31.831
                            a 15.9155 15.9155 0 0 1 0 -31.831"
                            fill="none"
                            stroke="#e5e7eb"
                            stroke-width="3"
                            stroke-dasharray="100, 100"/>
                        <path d="M18 2.0845
                            a 15.9155 15.9155 0 0 1 0 31.831
                            a 15.9155 15.9155 0 0 1 0 -31.831"
                            fill="none"
                            stroke="#008040"
                            stroke-width="3"
                            stroke-dasharray="100, 100"
                            stroke-linecap="round"/>
                        <text x="18" y="20.5" text-anchor="middle" fill="#008040" font-size="8" font-weight="bold">100%</text>
                    </svg>
                </div>
            </div>
            
            <!-- Withdrawal Status -->
            <div class="mb-8">
                {% if not tontine.isretirer %}
                    <!-- Awaiting Withdrawal -->
                    <div class="bg-gradient-to-r from-yellow-50 to-amber-50 border border-yellow-200 rounded-xl p-4 mb-4">
                        <div class="flex items-center gap-3">
                            <div class="h-10 w-10 rounded-full bg-yellow-100 text-yellow-600 flex items-center justify-center">
                                <i class="fas fa-hand-holding-usd text-lg"></i>
                            </div>
                            <div class="flex-1">
                                <h4 class="font-semibold text-gray-900 mb-1">Retrait disponible</h4>
                                <p class="text-sm text-gray-600">Votre épargne est prête à être retirée</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Withdraw Button -->
					<div class="text-center">
                    <a href="{{ path('app_withdrawal_request', {'id': tontine.id}) }}" 
																	   class="inline-flex items-center justify-center gap-2 px-5 py-2.5 
																	      bg-gradient-to-r from-green-600 to-green-700 
																	      hover:from-green-700 hover:to-green-800 
																	      text-white rounded-xl font-medium 
																	      transition-all duration-300 transform hover:scale-[1.02] 
																	      shadow-md hover:shadow-lg">
																		<i class="fas fa-download mr-1"></i> 
																		Demander le retrait
																	</a>
																	
                    </div>
                    <p class="text-xs text-gray-6000 text-center mt-3">
                        Traitement sous 24-48h après demande
                    </p>
                {% else %}
                    <!-- Withdrawal Completed -->
                    <div class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-xl p-4 mb-4">
                        <div class="flex items-center gap-3">
                            <div class="h-10 w-10 rounded-full bg-green-100 text-green-600 flex items-center justify-center">
                                <i class="fas fa-check-circle text-lg"></i>
                            </div>
                            <div class="flex-1">
                                <h4 class="font-semibold text-gray-900 mb-1">Retrait effectué</h4>
                                <p class="text-sm text-gray-600">
                                    <i class="fas fa-calendar-check text-green-500 mr-1"></i>
                                    Complété le {{ tontine.retraitAt|date('d/m/Y') }}
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Completed Message -->
                    <div class="text-center p-4 bg-gray-50 rounded-xl">
                        <div class="h-12 w-12 rounded-full bg-gray-200 text-gray-6000 flex items-center justify-center mx-auto mb-3">
                            <i class="fas fa-flag-checkered text-lg"></i>
                        </div>
                        <p class="text-gray-700 font-medium mb-1">Cycle complété</p>
                        <p class="text-sm text-gray-6000">Votre tontine est terminée avec succès</p>
                    </div>
                {% endif %}
            </div>
            
           
        </div>
        {% endif %}
    {% else %}
        <!-- Active Tontine State -->
        <div class="glass-card rounded-2xl p-6 shadow-soft h-full">
            <div class="flex items-center gap-3 mb-6">
                <div class="h-12 w-12 rounded-xl gradient-secondary flex items-center justify-center">
                    <i class="fas fa-calendar-check text-white text-lg"></i>
                </div>
                <h3 class="font-semibold text-gray-900 text-xl">Prochain paiement</h3>
            </div>

            {% if tontine.statut == 'active' and tontine.nextDueDate %}
                {% set daysRemaining = date(tontine.nextDueDate).diff(date('now')).days %}

                <div class="text-center mb-8">
                    <div class="text-4xl font-bold text-gray-900 mb-4">
                        {{ tontine.amountPerPoint|number_format(0, ',', ' ') }} F CFA
                    </div>
                    <div class="text-lg text-gray-700 mb-4">
                        <i class="fas fa-calendar-day text-green-600 mr-2"></i>
                        {{ tontine.nextDueDate|date('d M Y') }}
                    </div>
                    <div class="mb-6">
                        {% if daysRemaining < 0 %}
                            <span class="inline-flex items-center gap-2 px-4 py-2 bg-red-100 text-red-800 rounded-full text-sm font-medium">
                                <i class="fas fa-exclamation-circle"></i>
                                En retard de {{ -daysRemaining }} jour(s)
                            </span>
                        {% elseif daysRemaining == 0 %}
                            <span class="inline-flex items-center gap-2 px-4 py-2 bg-yellow-100 text-yellow-800 rounded-full text-sm font-medium">
                                <i class="fas fa-clock"></i>
                                Aujourd'hui
                            </span>
                        {% else %}
                            <span class="inline-flex items-center gap-2 px-4 py-2 bg-green-100 text-green-800 rounded-full text-sm font-medium">
                                <i class="fas fa-clock"></i>
                                Dans {{ daysRemaining }} jour(s)
                            </span>
                        {% endif %}
                    </div>
                </div>

                <a href="{{ path('app_tontine_payment', {'id': tontine.id}) }}" 
                   class="block w-full text-center gradient-green-700 text-white font-semibold py-4 rounded-xl hover-lift transition-all duration-300 text-lg mb-4">
                    <i class="fas fa-credit-card mr-2"></i>
                    Payer maintenant
                </a>
                
                <!-- Progress Summary -->
                <div class="mt-6 pt-6 border-t border-gray-200">
                    <div class="grid grid-cols-3 gap-3">
                        <div class="text-center">
                            <p class="text-gray-6000 text-xs mb-1">Payés</p>
                            <p class="font-bold text-green-700 text-lg">{{ tontine.paidPoints|default(0) }}</p>
                        </div>
                        <div class="text-center">
                            <p class="text-gray-6000 text-xs mb-1">Restants</p>
                            <p class="font-bold text-gray-900 text-lg">{{ tontine.totalPoints - tontine.paidPoints|default(0) }}</p>
                        </div>
                        <div class="text-center">
                            <p class="text-gray-6000 text-xs mb-1">Total</p>
                            <p class="font-bold text-green-700 text-lg">{{ tontine.totalPoints }}</p>
                        </div>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div class="mt-4">
                        <div class="flex justify-between text-xs text-gray-600 mb-1">
                            <span>Progression</span>
                            <span>{{ ((tontine.paidPoints|default(0) / tontine.totalPoints) * 100)|round }}%</span>
                        </div>
                        <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-green-500 to-green-600 transition-all duration-500" 
                                 style="width: {{ ((tontine.paidPoints|default(0) / tontine.totalPoints) * 100)|round }}%"></div>
                        </div>
                    </div>
                </div>
                
            {% else %}
                <!-- No Pending Payment -->
                <div class="text-center py-10">
                    <div class="h-20 w-20 rounded-full bg-gray-100 text-gray-400 flex items-center justify-center mx-auto mb-6">
                        <i class="fas fa-check-circle text-3xl"></i>
                    </div>
                    <p class="text-gray-600 font-medium text-lg mb-2">Aucun paiement en attente</p>
                    <p class="text-gray-6000">Tous les points sont à jour</p>
                    
                    <!-- Next Payment Info -->
                    {% if tontine.nextDueDate %}
                        <div class="mt-6 p-4 bg-gray-50 rounded-xl">
                            <p class="text-gray-6000 text-sm mb-1">Prochaine échéance</p>
                            <p class="font-semibold text-gray-900">{{ tontine.nextDueDate|date('d/m/Y') }}</p>
                        </div>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    {% endif %}
    
	</div>

			
</div>
	<!-- Print Notice -->
				<div class="text-center text-gray-6000 text-sm mt-12">
					<p>Document généré le
						{{ "now"|date('d/m/Y à H:i') }}</p>
					<p>Efa Smart Finance • www.efasmartfinance.com</p>
				</div>
			</div>
		</div>
{% include 'dashboard/links/_js.html.twig' %}   
	</body>
</html>
